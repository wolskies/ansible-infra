---
- name: Update all systems and dotfiles
  hosts: all
  gather_facts: true
  collections:
    - wolskinet.infrastructure

  roles:
    - name: wolskinet.infrastructure.maintenance
      become: false

  tasks:
    - name: Check for reboot requirement (Ubuntu/Debian)
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      when: ansible_os_family == "Debian"

    - name: Set reboot flag if needed
      ansible.builtin.set_fact:
        reboot_required: true
      when:
        - ansible_os_family == "Debian"
        - reboot_required_file.stat.exists

    - name: Report systems requiring reboot
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} requires a reboot"
      when: reboot_required is defined and reboot_required

    - name: Report completion
      ansible.builtin.debug:
        msg: "System update completed for {{ inventory_hostname }}"
