# Ansible Collection - wolskinet.infrastructure

A comprehensive collection of Ansible roles for infrastructure management across multiple operating systems including Ubuntu 24+, Debian 12/13, Arch Linux, and macOS.

## Description

This collection provides a set of roles designed to automate the setup and maintenance of infrastructure components across different operating systems. It follows an **inventory-group-based architecture** where different types of machines (servers, docker_hosts, workstations) are configured through group membership, enabling modular and extensible infrastructure management.

## Architecture Overview

The collection fully leverages [Ansible's variable precedence hierarchy](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable) for maximum flexibility through OS-specific hierarchical package variables:

### Hierarchical Package Variables

```yaml
# group_vars/all/Ubuntu.yml - Global packages for all Ubuntu machines
all_packages_install_Ubuntu:
  - htop
  - vim

# group_vars/servers/Ubuntu.yml - Server group packages  
group_packages_install_Ubuntu:
  - nginx
  - certbot

# host_vars/web-01/Ubuntu.yml - Host-specific packages
host_packages_install_Ubuntu:
  - redis-server

# Generated by discovery (host_vars/web-01.yml)
host_packages_install_Ubuntu:
  - curl
  - git
```

**Variable Merging Order:**
1. `all_packages_install_<Distribution>` (group_vars/all)
2. `group_packages_install_<Distribution>` (group_vars/<group>)
3. `host_packages_install_<Distribution>` (host_vars/<host>, includes discovery)

All lists are merged with duplicates removed. Package names are distribution-specific, enabling cross-OS package mapping by users.

### Key Principles

1. **OS-Specific Variables**: Package names are distribution-specific (packages_install_Ubuntu vs packages_install_Archlinux)
2. **Hierarchical Merging**: Variables merge across inventory levels without complex logic
3. **Discovery Integration**: Discovery populates host-level variables that integrate seamlessly
4. **Group-Based Configuration**: Machines are configured based on their inventory group membership  
5. **Modular Roles**: Each role handles a specific aspect (basic setup, Docker, maintenance, etc.)

## Supported Operating Systems

- **Ubuntu**: 24.04 LTS and newer
- **Debian**: 12 (Bookworm), 13 (Trixie)  
- **Arch Linux**: Latest rolling release
- **macOS**: Latest versions

## Included Roles

### wolskinet.infrastructure.basic_setup
**Essential foundation** for all machine types:
- OS packages via hierarchical variables (all/group/host levels)
- Language-specific packages (AUR, pip, npm)  
- OS-specific features (snap removal, AUR helper, Homebrew setup)
- User management and system configuration
- Firewall installation and basic security

### wolskinet.infrastructure.container_platform
**Docker infrastructure management**:
- Docker and Docker Compose installation
- Container service deployment and management
- Network and volume configuration
- Integration with basic_setup foundation

### wolskinet.infrastructure.maintenance  
**System maintenance and updates**:
- Package updates for each OS
- System cleanup and optimization
- Maintenance scheduling

### wolskinet.infrastructure.dotfiles
**Dotfiles management**:
- Git-based dotfiles repository cloning/updating
- Symlink management using GNU Stow
- Shell configuration (zsh, zinit, etc.)

### wolskinet.infrastructure.discovery
**Infrastructure discovery utility**:
- Scans existing machines for packages, services, and configuration
- Generates host_vars files with OS-specific variables
- Creates functional replication playbooks
- Integrates with hierarchical package system
- Detects user-installed pip and npm packages for language-specific roles

### wolskinet.infrastructure.third_party_packages
**Unified package management for everything requiring additional setup**:
- Repository configuration (APT sources, Homebrew taps, etc.)
- Python packages via pip (user, global, virtualenv methods)
- Node.js packages via npm (global and local)
- System packages from third-party repositories
- Rust and Go packages (cargo install, go install)
- Consolidates all non-standard package management

## Installation

### From Ansible Galaxy

```bash
ansible-galaxy collection install wolskinet.infrastructure
```

### From Source

```bash
git clone https://github.com/wolskinet/ansible-infrastructure.git
cd ansible-infrastructure
ansible-galaxy collection build
ansible-galaxy collection install wolskinet-infrastructure-*.tar.gz
```

## Quick Start

### 1. Create Inventory Structure

```yaml
# inventory.yml
servers:
  hosts:
    web-server:
      ansible_host: 192.168.1.20
    db-server:
      ansible_host: 192.168.1.21

docker_hosts:
  hosts:
    docker-01:
      ansible_host: 192.168.1.30

workstations:
  hosts:
    ubuntu-desktop:
      ansible_host: 192.168.1.10
    macbook-pro:
      ansible_host: 192.168.1.11
```

### 2. Configure Hierarchical Package Variables

```yaml
# group_vars/all/Ubuntu.yml - Global Ubuntu packages
all_packages_install_Ubuntu:
  - htop
  - curl
  - git

# group_vars/servers/Ubuntu.yml - Server-specific packages
group_packages_install_Ubuntu:
  - nginx
  - ufw

# host_vars/web-server.yml - Host-specific packages  
host_packages_install_Ubuntu:
  - redis-server
  - postgresql-client
```

### 3. Create Deployment Playbooks

```yaml
# deploy-servers.yml
- name: Deploy server infrastructure
  hosts: servers
  gather_facts: true
  become: true
  
  roles:
    - wolskinet.infrastructure.basic_setup
    - wolskinet.infrastructure.maintenance
```

### 4. Run Deployment

```bash
ansible-playbook -i inventory.yml deploy-servers.yml
```

## Discovery Workflow

The discovery role scans existing machines and generates inventory variables for replication:

### 1. Run Discovery

```bash
# Scan a machine and generate host_vars
ansible-playbook -i "target-host," utilities/playbooks/discover-essential.yml
```

### 2. Generated Output

Discovery creates:
- `utilities/playbooks/inventory/host_vars/<host>.yml` with OS-specific variables
- `utilities/playbooks/playbooks/deploy-<host>.yml` for replication

### 3. Use Discovery Results

The generated host_vars integrate with the hierarchical system:

```yaml
# Generated in host_vars/web-01.yml
host_packages_install_Ubuntu:
  - nginx
  - redis-server
  - curl
  # ... discovered packages

# User can add additional packages at any level
# group_vars/servers/Ubuntu.yml
group_packages_install_Ubuntu:
  - certbot  # Adds to discovered packages

# group_vars/all/Ubuntu.yml  
all_packages_install_Ubuntu:
  - htop     # Adds to all machines
```

## Role Configuration Examples

### Basic Setup Role

Essential system foundation with hierarchical packages:

```yaml
# Minimal configuration - packages from discovery/hierarchy
- hosts: all
  roles:
    - wolskinet.infrastructure.basic_setup

# With user management and system packages
- hosts: servers
  vars:
    user_details:
      - name: deploy
        uid: 1001
        shell: /bin/bash
        groups: ["sudo"]
    host_packages_install_Ubuntu:
      - python3-pip      # System Python
      - nodejs           # System Node.js
  roles:
    - wolskinet.infrastructure.basic_setup
```

### Language-Specific Package Roles

Development tools and user packages:

```yaml
# Python development environment
- hosts: developers
  roles:
    - wolskinet.infrastructure.basic_setup
    - role: wolskinet.infrastructure.third_party_packages
      vars:
        pip_install_method: "user"
        pip_packages:
          - black
          - ruff
          - mypy

# Node.js development tools
- hosts: frontend_devs
  roles:
    - wolskinet.infrastructure.basic_setup
    - role: wolskinet.infrastructure.third_party_packages
      vars:
        npm_packages:
          - "@angular/cli"
          - prettier
          - eslint
```

### Container Platform Role

Docker infrastructure with service deployment:

```yaml
- hosts: docker_hosts
  roles:
    - wolskinet.infrastructure.basic_setup
    - wolskinet.infrastructure.container_platform
```

### Maintenance Role

System updates and maintenance:

```yaml
- hosts: all
  roles:
    - wolskinet.infrastructure.maintenance
```

## Advanced Usage

### Cross-OS Package Mapping

Handle different package names across distributions:

```yaml
# group_vars/all/Ubuntu.yml
all_packages_install_Ubuntu:
  - redis-server
  - postgresql-client

# group_vars/all/Archlinux.yml  
all_packages_install_Archlinux:
  - redis
  - postgresql
```

### Discovery-Driven Setup

Use discovery to replicate existing configurations:

1. **Scan existing machine**: `ansible-playbook discover-essential.yml`
2. **Review generated variables**: Check `host_vars/<host>.yml`
3. **Deploy to new machine**: `ansible-playbook deploy-<host>.yml`

### Language-Specific Packages

Different package types are handled by appropriate roles:

```yaml
# OS packages via basic_setup (hierarchical)
host_packages_install_Ubuntu:
  - nginx
  - python3-pip    # System Python packages
  - nodejs         # System Node.js

# AUR packages via basic_setup (Arch Linux only)
aur_packages:
  - paru
  - visual-studio-code-bin
  
# Python packages for third_party_packages role
pip_packages:       # User packages only
  - ansible-lint
  - black
  
# Node.js packages for third_party_packages role
npm_packages:       # Global CLI tools
  - typescript
  - prettier
```

### System vs User Package Separation

```yaml
# System packages (via OS package manager in basic_setup)
host_packages_install_Ubuntu:
  - python3-pip          # System pip
  - python3-requests     # System Python packages
  - nodejs               # System Node.js
  - npm                  # System npm

# User packages (via third_party_packages role)
pip_packages:            # third_party_packages role
  - ansible-dev-tools    # Not available in apt
  - mypy                 # Development tool

npm_packages:            # third_party_packages role
  - "@angular/cli"       # Development CLI
  - eslint               # Linting tool
```

## Security and Secrets Management

Use Ansible Vault for sensitive data:

```bash
# Create encrypted secrets
ansible-vault create group_vars/all/vault.yml
```

```yaml
# In vault.yml (encrypted)
vault_user_password: "$6$encrypted_hash$"

# In vars.yml (plain)  
user_details:
  - name: admin
    password: "{{ vault_user_password }}"
```

For complete secrets management guide, see: [docs/vault-secrets-guide.md](docs/vault-secrets-guide.md)

## Dependencies

### Required Collections
- `community.general` (for additional modules)
- `community.docker` (for container_platform role)
- `ansible.posix` (for firewall management)

### Python Requirements
- Python 3.9+ on control node
- pip, venv support

## Development

See [CLAUDE.md](CLAUDE.md) for development workflow and testing commands.

## License

GPL-3.0-or-later

## Author Information

Created by Ed Wolski (ed@wolskinet.com)

## Support

- Issues: https://github.com/wolskinet/ansible-infrastructure/issues
- Documentation: https://github.com/wolskinet/ansible-infrastructure