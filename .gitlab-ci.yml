stages:
  - validate
  - security
  - test
  - integration
  - build
  - publish

variables:
  ANSIBLE_FORCE_COLOR: "true"
  FF_WAIT_FOR_POD_TO_BE_REACHABLE: 1
  # Docker connection resilience
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  # Use CI-specific config for Docker temp directory issues
  ANSIBLE_CONFIG: "$CI_PROJECT_DIR/ansible-ci.cfg"
  # Force Ansible to use /tmp for all temp operations
  ANSIBLE_REMOTE_TEMP: "/tmp/ansible-tmp"
  ANSIBLE_LOCAL_TEMP: "/tmp/ansible-tmp"

# YAML and Ansible validation
yaml-validation:
  stage: validate
  image: python:3.13-slim
  script:
    - pip install yamllint
    - yamllint .
    - echo "✅ YAML validation passed"

ansible-lint:
  stage: validate
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq ansible python3-pip
    - pip install --break-system-packages ansible-lint
    - ansible-galaxy collection install -r requirements.yml --force
    - ansible-lint
    - echo "✅ Ansible lint passed"

syntax-check:
  stage: validate
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq make ansible
    - make syntax-check
    - echo "✅ Syntax check passed"

# Security checks
pre-commit-checks:
  stage: security
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq python3-pip git
    - pip install --break-system-packages pre-commit pyyaml
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - pre-commit run --all-files || echo "Pre-commit issues found (non-blocking)"
    - echo "✅ Pre-commit checks completed"
  allow_failure: true

# Template for molecule test jobs
.molecule_test_template:
  image: python:3.13-slim
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    FF_NETWORK_PER_BUILD: "true"
  before_script:
    # Install system packages like we do locally
    - apt-get update -qq
    - apt-get install -y -qq ansible docker.io make dnsutils python3-pip
    # Login to Docker Hub to avoid rate limiting
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin || echo "Docker Hub login failed (continuing anyway)"
    # CRITICAL: Remove ALL stale collections from previous CI runs
    - rm -rf /root/.ansible/collections
    # Install molecule and testing tools via pip (user install, no venv)
    - pip install --break-system-packages molecule[docker] molecule-plugins[docker] pytest-testinfra
    # Install ansible collections from requirements.yml
    - ansible-galaxy collection install -r requirements.yml --force
    - echo "=== Installed collections ==="
    - ansible-galaxy collection list | grep -E "(community\.general|ansible\.posix|community\.docker)"
    - echo "=== Collection paths ==="
    - ansible --version | grep "collection location"
    # Debug DNS and network connectivity
    - echo "Checking network connectivity..."
    - nslookup docker || echo "DNS lookup failed"
    - ping -c 3 docker || echo "Ping failed"
    # Wait for Docker with enhanced retry logic
    - echo "Waiting for Docker daemon..."
    - for i in {1..60}; do docker info >/dev/null 2>&1 && break || (echo "Attempt $i failed, retrying..."; sleep 2); done
    - docker info

# Role-specific tests
test-discovery:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s discovery
    - echo "✅ Discovery role tests passed"

test-packages:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s packages
    - echo "✅ Package management tests passed"

test-os-configuration:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s os_configuration
    - echo "✅ OS configuration tests passed"

test-users:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s users
    - echo "✅ User management tests passed"

test-security-services:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s security
    - echo "✅ Security services tests passed"

test-system-settings:
  extends: .molecule_test_template
  stage: test
  script:
    - molecule test -s system_settings
    - echo "✅ System settings tests passed"

# REMOVED: test-language-packages - functionality moved to configure_user role
# Language package management is now handled per-user in configure_user role

# REMOVED: test-security - duplicate of test-security-services
# Use test-security-services which tests manage_security_services role

# Integration tests
test-integration:
  extends: .molecule_test_template
  stage: integration
  script:
    - make test-integration
    - echo "✅ Integration tests passed"
  only:
    - main
    - merge_requests

# Collection build
collection-build:
  stage: build
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq make ansible
    - make collection-build
    - ls -la *.tar.gz
    - echo "✅ Collection built successfully"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 week

# Version validation and tagging
version-check:
  stage: build
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq python3-yaml
    - python3 -c "import yaml; print('Version:', yaml.safe_load(open('galaxy.yml'))['version'])"
    - echo "✅ Version validated"
  only:
    - tags

# Publish to Ansible Galaxy (manual trigger only)
publish-galaxy:
  stage: publish
  image: python:3.13-slim
  dependencies:
    - collection-build
  script:
    - apt-get update -qq && apt-get install -y -qq ansible
    - |
      if [ -z "$GALAXY_API_KEY" ]; then
        echo "❌ GALAXY_API_KEY not set - skipping publish"
        exit 1
      fi
    - ansible-galaxy collection publish *.tar.gz --api-key $GALAXY_API_KEY
    - echo "✅ Collection published to Ansible Galaxy"
  when: manual
  only:
    - tags
  variables:
    GALAXY_API_KEY: $GALAXY_API_KEY
