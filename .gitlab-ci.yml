stages:
  - validate
  - test
  - integration
  - build
  - publish

variables:
  ANSIBLE_FORCE_COLOR: "true"
  FF_WAIT_FOR_POD_TO_BE_REACHABLE: 1
  # Docker connection resilience
  DOCKER_DRIVER: overlay2
  DOCKER_BUILDKIT: 1
  # Use CI-specific config for Docker temp directory issues
  ANSIBLE_CONFIG: "$CI_PROJECT_DIR/ansible-ci.cfg"
  # Force Ansible to use /tmp for all temp operations
  ANSIBLE_REMOTE_TEMP: "/tmp/ansible-tmp"
  ANSIBLE_LOCAL_TEMP: "/tmp/ansible-tmp"

# Global cache configuration
cache:
  # Use same cache for all jobs with same key
  policy: pull-push
  # Fallback cache for different branches
  fallback_keys:
    - cache-main

# Comprehensive validation - combines all linting and syntax checks
validate-all:
  stage: validate
  image: registry.wolskinet.com:5050/ansible/collections/infrastructure/validation:latest
  cache:
    key: "validation-$CI_COMMIT_REF_SLUG"
    paths:
      - /root/.cache/pip/
      - /root/.ansible/collections/
      - /var/cache/apt/
      - /root/.cache/pre-commit/
  script:
    # Tools already pre-installed in custom image, just install collections
    - |
      if [ ! -f /root/.ansible/collections/.installed ]; then
        echo "Installing Ansible collections (not cached)..."
        for i in {1..3}; do
          echo "Attempt $i: Installing ansible collections..."
          if ansible-galaxy collection install -r requirements.yml --force; then
            echo "✅ Collections installed successfully"
            touch /root/.ansible/collections/.installed
            break
          else
            echo "❌ Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
          if [ $i -eq 3 ]; then
            echo "❌ All attempts failed"
            exit 1
          fi
        done
      else
        echo "✅ Using cached Ansible collections"
      fi
    # Install current collection being tested
    - echo "Installing current collection wolskies.infrastructure..."
    - ansible-galaxy collection install . --force

    # Run pre-commit checks (includes yamllint, prettier, custom checks)
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - pre-commit run --all-files || true # Non-blocking but shows issues

    # Run ansible-lint (critical for Ansible best practices)
    - ansible-lint

    # Run syntax check (ensures playbooks are parseable)
    - make syntax-check

    - echo "✅ All validation checks completed"

# Template for molecule test jobs
.molecule_test_template:
  image: python:3.13-slim
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    FF_NETWORK_PER_BUILD: "true"
  cache:
    key: "molecule-$CI_COMMIT_REF_SLUG"
    paths:
      - /root/.cache/pip/
      - /root/.ansible/collections/
      - /var/cache/apt/
      - /var/lib/apt/lists/
  before_script:
    # Install system packages like we do locally
    - apt-get update -qq
    - apt-get install -y -qq ansible docker.io make dnsutils python3-pip
    # Wait for Docker daemon and login to avoid rate limiting
    - echo "Waiting for Docker daemon..."
    - for i in {1..30}; do docker info >/dev/null 2>&1 && break || (echo "Attempt $i failed, retrying..."; sleep 2); done
    - echo "Logging into Docker Hub..."
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
    # Ensure collections directory exists for caching
    - mkdir -p /root/.ansible/collections
    # Install molecule and testing tools via pip (user install, no venv)
    - pip install --break-system-packages molecule[docker] molecule-plugins[docker] pytest-testinfra
    # Install collections with caching and retry for transient Galaxy failures
    - |
      if [ ! -f /root/.ansible/collections/.installed ]; then
        echo "Installing Ansible collections (not cached)..."
        for i in {1..3}; do
          echo "Attempt $i: Installing ansible collections..."
          if ansible-galaxy collection install -r requirements.yml --force; then
            echo "✅ Collections installed successfully"
            touch /root/.ansible/collections/.installed
            break
          else
            echo "❌ Attempt $i failed, retrying in 10 seconds..."
            sleep 10
          fi
          if [ $i -eq 3 ]; then
            echo "❌ All attempts failed"
            exit 1
          fi
        done
      else
        echo "✅ Using cached Ansible collections"
      fi
    # Install current collection being tested
    - echo "Installing current collection wolskies.infrastructure..."
    - ansible-galaxy collection install . --force
    - echo "=== Installed collections ==="
    - ansible-galaxy collection list | grep -E "(community\.general|ansible\.posix|community\.docker|wolskies\.infrastructure)"
    - echo "=== Collection paths ==="
    - ansible --version | grep "collection location"
    # Debug DNS and network connectivity
    - echo "Checking network connectivity..."
    - nslookup docker || echo "DNS lookup failed"
    - ping -c 3 docker || echo "Ping failed"
    # Wait for Docker with enhanced retry logic
    - echo "Waiting for Docker daemon..."
    - for i in {1..60}; do docker info >/dev/null 2>&1 && break || (echo "Attempt $i failed, retrying..."; sleep 2); done
    - docker info

# Individual role-level tests (run in parallel for faster feedback)
test-role-discovery:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/discovery && molecule test
    - echo "✅ Discovery role tests passed"

# REMOVED: test-docker - role not ready for production
# Docker compose functionality needs further development

# MOVED: test-minimal - moved to validate stage as validate-minimal-config
# Minimal configuration safety is a validation concern, not a functional test

# REMOVED: test-dotfiles - functionality consolidated into configure_user role
# Dotfiles deployment is now handled as part of per-user configuration

# Individual role-level tests (run in parallel for faster feedback)
test-role-nodejs:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/nodejs && molecule test
    - echo "✅ Node.js role tests passed"

test-role-rust:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/rust && molecule test
    - echo "✅ Rust role tests passed"

test-role-go:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/go && molecule test
    - echo "✅ Go role tests passed"

test-role-neovim:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/neovim && molecule test
    - echo "✅ Neovim role tests passed"

test-role-terminal-config:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/terminal_config && molecule test
    - echo "✅ Terminal config role tests passed"

test-role-os-configuration:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/os_configuration && molecule test
    - echo "✅ OS configuration role tests passed"

test-role-manage-packages:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/manage_packages && molecule test
    - echo "✅ Package management role tests passed"

test-role-manage-security-services:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/manage_security_services && molecule test
    - echo "✅ Security services role tests passed"

test-role-configure-user:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/configure_user && molecule test
    - echo "✅ User configuration role tests passed"

test-role-manage-flatpak:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/manage_flatpak && molecule test
    - echo "✅ Flatpak management role tests passed (Ubuntu + Arch Linux)"

test-role-manage-snap-packages:
  extends: .molecule_test_template
  stage: test
  script:
    - cd roles/manage_snap_packages && molecule test
    - echo "✅ Snap packages role tests passed"

# Variable validation - ensures role variable passing and defaults work correctly
test-variable-validation:
  extends: .molecule_test_template
  stage: integration
  script:
    - molecule test -s minimal # Test robustness with empty/missing config
    - echo "✅ Variable validation and robustness tests passed"
  only:
    - main
    - merge_requests

# Collection build
collection-build:
  stage: build
  image: python:3.13-slim
  cache:
    key: "build-$CI_COMMIT_REF_SLUG"
    paths:
      - /var/cache/apt/
  script:
    - apt-get update -qq && apt-get install -y -qq make ansible
    - make collection-build
    - ls -la *.tar.gz
    - echo "✅ Collection built successfully"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 week

# Version validation and tagging
version-check:
  stage: build
  image: python:3.13-slim
  script:
    - apt-get update -qq && apt-get install -y -qq python3-yaml
    - python3 -c "import yaml; print('Version:', yaml.safe_load(open('galaxy.yml'))['version'])"
    - echo "✅ Version validated"
  only:
    - tags

# Publish to Ansible Galaxy (manual trigger only)
publish-galaxy:
  stage: publish
  image: python:3.13-slim
  dependencies:
    - collection-build
  script:
    - apt-get update -qq && apt-get install -y -qq ansible
    - |
      if [ -z "$GALAXY_API_KEY" ]; then
        echo "❌ GALAXY_API_KEY not set - skipping publish"
        exit 1
      fi
    - ansible-galaxy collection publish *.tar.gz --api-key $GALAXY_API_KEY
    - echo "✅ Collection published to Ansible Galaxy"
  when: manual
  only:
    - tags
  variables:
    GALAXY_API_KEY: $GALAXY_API_KEY
