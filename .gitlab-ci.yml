# GitLab CI/CD Pipeline for wolskinet.infrastructure Ansible Collection
# Supports self-hosted GitLab with GitHub sync

stages:
  - validate
  - test-roles
  - test-integration
  - build
  - sync-github

variables:
  COLLECTION_NAMESPACE: wolskinet
  COLLECTION_NAME: infrastructure
  COLLECTION_VERSION: 1.0.0
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  PY_COLORS: '1'

# Cache for pip and ansible collections
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pip-cache/
    - .ansible-cache/

.base-setup: &base-setup
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3-pip docker.io
    - pip3 install --cache-dir .pip-cache/ ansible molecule[docker] docker pytest-testinfra ansible-lint yamllint
    - ansible-galaxy collection install community.general community.docker -p .ansible-cache/
    - docker --version
    - ansible --version
    - molecule --version

# Validation Stage
lint-collection:
  stage: validate
  image: python:3.11-slim
  <<: *base-setup
  script:
    - echo "Linting Ansible collection files..."
    - ansible-lint --version || pip3 install ansible-lint
    - ansible-lint .
    - echo "Checking YAML syntax..."
    - yamllint .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate-galaxy:
  stage: validate
  image: python:3.11-slim
  <<: *base-setup
  script:
    - echo "Validating galaxy.yml..."
    - ansible-galaxy collection build . --force
    - ls -la *.tar.gz
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate-templates:
  stage: validate
  image: python:3.11-slim
  <<: *base-setup
  script:
    - echo "Validating all Jinja2 templates..."
    - |
      find roles -name "*.j2" -type f | while read template; do
        echo "Checking: $template"
        python3 -c "
      from jinja2 import Environment, FileSystemLoader, StrictUndefined
      import os
      import sys
      template_path = '$template'
      template_dir = os.path.dirname(template_path)
      template_name = os.path.basename(template_path)
      try:
          env = Environment(
              loader=FileSystemLoader(template_dir),
              undefined=StrictUndefined
          )
          # Attempt to parse the template
          env.get_template(template_name)
          print(f'✓ Template syntax valid: {template_path}')
      except Exception as e:
          print(f'✗ Template syntax error in {template_path}: {e}')
          sys.exit(1)
        "
      done
    - echo "All templates validated successfully!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Role Testing Stage
test-basic-setup:
  stage: test-roles
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Testing basic_setup role..."
    - molecule test -s basic_setup
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-docker-setup:
  stage: test-roles
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Testing container_platform role..."
    - molecule test -s container_platform
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-discovery-utility:
  stage: test-roles
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Testing infrastructure discovery utility..."
    - molecule test -s discovery
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-system-tuning:
  stage: test-roles
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Testing system_tuning role..."
    - molecule test -s system_tuning
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-hierarchical-variables:
  stage: test-roles
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Testing hierarchical variable system..."
    - molecule test -s default --tags variables
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

# Integration Testing Stage
test-collection-integration:
  stage: test-integration
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Running full collection integration tests..."
    - molecule test -s default
  needs:
    - test-basic-setup
    - test-docker-setup
    - test-discovery-utility
    - test-system-tuning
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

# Build Stage
build-collection:
  stage: build
  image: python:3.11-slim
  <<: *base-setup
  script:
    - echo "Building collection for release..."
    - ansible-galaxy collection build . --force
    - echo "Collection built successfully:"
    - ls -la *.tar.gz
  artifacts:
    paths:
      - "${COLLECTION_NAMESPACE}-${COLLECTION_NAME}-*.tar.gz"
    expire_in: 1 week
  needs:
    - lint-collection
    - validate-galaxy
    - test-collection-integration
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# GitHub Sync Stage
sync-to-github:
  stage: sync-github
  image: alpine/git:latest
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git openssh-client
    - eval $(ssh-agent -s)
    - echo "$GITHUB_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
  script:
    - echo "Syncing repository to GitHub..."
    - git remote add github git@github.com:${GITHUB_USERNAME}/${GITHUB_REPOSITORY}.git || true
    - git fetch github || echo "GitHub remote not accessible, continuing..."
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        echo "Syncing main branch to GitHub..."
        git push github HEAD:main --force-with-lease
      elif [ -n "$CI_COMMIT_TAG" ]; then
        echo "Syncing tag $CI_COMMIT_TAG to GitHub..."
        git push github $CI_COMMIT_TAG
      else
        echo "Skipping sync for feature branch $CI_COMMIT_BRANCH"
      fi
    - echo "GitHub sync completed"
  needs:
    - build-collection
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
    - if: $CI_COMMIT_TAG
      when: on_success
  # Required GitLab CI/CD variables:
  # GITHUB_SSH_PRIVATE_KEY - SSH private key for GitHub access
  # GITHUB_USERNAME - GitHub username/organization
  # GITHUB_REPOSITORY - GitHub repository name

# Cleanup job for failed pipelines
cleanup-on-failure:
  stage: .post
  image: alpine:latest
  script:
    - echo "Pipeline failed - cleaning up resources"
    - echo "Check logs for test failures or infrastructure issues"
  when: on_failure
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security scanning (optional, requires GitLab Premium)
ansible-security-scan:
  stage: validate
  image: python:3.11-slim
  before_script:
    - pip3 install ansible-lint bandit safety
  script:
    - echo "Running security scans..."
    - ansible-lint .
    - find . -name "*.py" -exec bandit {} + || true
    - safety check || true
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Performance testing (runs on schedule)
performance-test:
  stage: test-integration
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Running performance tests..."
    - time molecule test -s default
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

# Multi-OS Testing Matrix (scheduled runs)
.os-matrix-test: &os-matrix-test
  stage: test-integration
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $TEST_MATRIX == "true"
  allow_failure: true

test-ubuntu-discovery:
  <<: *os-matrix-test
  script:
    - echo "Testing discovery on Ubuntu 24.04..."
    - molecule test -s discovery
  variables:
    MOLECULE_PLATFORM: ubuntu2404

test-debian-discovery:
  <<: *os-matrix-test
  script:
    - echo "Testing discovery on Debian 12..."
    - molecule test -s discovery
  variables:
    MOLECULE_PLATFORM: debian12

test-cross-os-compatibility:
  <<: *os-matrix-test
  script:
    - echo "Testing cross-OS compatibility..."
    - molecule test -s default --parallel
  variables:
    MOLECULE_PARALLEL: "true"

# End-to-End Testing (full workflow)
test-e2e-workflow:
  stage: test-integration
  image: python:3.11-slim
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: ""
  <<: *base-setup
  script:
    - echo "Running end-to-end workflow test..."
    - echo "1. Discovery -> 2. Configuration Generation -> 3. Infrastructure Setup"
    - molecule test -s default
    - echo "Testing discovery-to-deployment pipeline..."
    - molecule converge -s discovery
    - molecule verify -s discovery
  needs:
    - test-collection-integration
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $MR_LABELS =~ /.*e2e-test.*/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    paths:
      - molecule/*/logs/
      - /tmp/discovery-test*/
    expire_in: 1 hour
    when: always
