# GitLab CI/CD Pipeline for wolskinet.infrastructure Ansible Collection

stages:
  - validate
  - test-roles
  - test-integration
  - build
  - sync-github

variables:
  COLLECTION_NAMESPACE: wolskinet
  COLLECTION_NAME: infrastructure
  COLLECTION_VERSION: 1.0.0
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  PY_COLORS: '1'
  ANSIBLE_COLLECTIONS_PATH: "/root/.ansible/collections:${CI_PROJECT_DIR}/..:${HOME}/.ansible/collections:/usr/share/ansible/collections"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pip-cache/
    - .ansible-cache/

# Molecule test template
.molecule-test: &molecule-test
  image: python:3.11-slim
  services:
    - name: docker:dind
      command: ["--tls=false", "--host=tcp://0.0.0.0:2375"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 0
    ANSIBLE_COLLECTIONS_PATH: "/root/.ansible/collections:${CI_PROJECT_DIR}/..:${HOME}/.ansible/collections:/usr/share/ansible/collections"
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq python3-pip make curl docker.io
    - pip3 install --cache-dir .pip-cache/ ansible molecule molecule-plugins[docker] docker pytest-testinfra ansible-lint yamllint jinja2
    - ansible-galaxy collection install community.general community.docker -p .ansible-cache/
    # Install the current collection for testing
    - mkdir -p /root/.ansible/collections/ansible_collections/wolskinet/
    - cp -r . /root/.ansible/collections/ansible_collections/wolskinet/infrastructure
    # Wait for Docker daemon
    - echo "Waiting for Docker daemon..."
    - for i in {1..30}; do if docker info >/dev/null 2>&1; then echo "Docker ready"; break; fi; sleep 2; done
    - docker info
    # Verify setup
    - docker --version
    - ansible --version
    - molecule --version
    - ansible-galaxy collection list | grep wolskinet || echo "Collection not found in list"

# Basic validation
quick-validation:
  stage: validate
  image: python:3.11-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3-pip make
    - pip3 install --cache-dir .pip-cache/ ansible ansible-lint yamllint jinja2
  script:
    - make test-quick
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Comprehensive linting
lint-collection:
  stage: validate
  image: python:3.11-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3-pip make
    - pip3 install --cache-dir .pip-cache/ ansible ansible-lint yamllint
  script:
    - echo "Running comprehensive linting..."
    - ansible-lint --version
    - ansible-lint . --offline
    - yamllint .
    - echo "✅ All linting checks passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Validate galaxy metadata
validate-galaxy:
  stage: validate
  image: python:3.11-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3-pip
    - pip3 install ansible
  script:
    - echo "Validating galaxy.yml and building collection..."
    - ansible-galaxy collection build . --force
    - echo "✅ Collection package created successfully"
    - ls -la *.tar.gz
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Docker connectivity test
test-docker-connectivity:
  stage: validate
  <<: *molecule-test
  script:
    - echo "=== Docker Debug ==="
    - docker info
    - docker run --rm hello-world
    - echo "Docker connectivity OK"
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Role tests
test-configure-host:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s configure_host
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-manage-packages:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s manage_packages
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-manage-users:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s manage_users
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-manage-firewall:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s manage_firewall
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-manage-system-settings:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s manage_system_settings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-discovery:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s discovery
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-dotfiles:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s dotfiles
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

test-manage-language-packages:
  stage: test-roles
  <<: *molecule-test
  script:
    - molecule test -s manage_language_packages
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

# Integration tests
test-collection-integration:
  stage: test-integration
  <<: *molecule-test
  script:
    - echo "Running collection integration tests..."
    - molecule test -s integration
  needs:
    - test-configure-host
    - test-manage-packages
    - test-manage-users
    - test-manage-firewall
    - test-manage-system-settings
    - test-discovery
    - test-dotfiles
    - test-manage-language-packages
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  retry:
    max: 2
    when: runner_system_failure

# Build collection
build-collection:
  stage: build
  image: python:3.11-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3-pip
    - pip3 install ansible
  script:
    - echo "Building collection after all tests pass..."
    - ansible-galaxy collection build . --force
    - echo "Collection built successfully:"
    - ls -la *.tar.gz
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 week
  needs:
    - quick-validation
    - lint-collection
    - validate-galaxy
    - test-collection-integration
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
