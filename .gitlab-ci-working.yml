stages:
  - validate
  - test
  - build

variables:
  ANSIBLE_FORCE_COLOR: "true"

# Simple validation
yaml-validation:
  stage: validate
  image: python:3.11-slim
  script:
    - pip install yamllint
    - yamllint .
    - echo "✅ YAML validation passed"

# Basic molecule test (without templates)
molecule-test-basic:
  stage: test
  image: python:3.11-slim
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  script:
    - python3 -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements-dev.txt
    - docker info
    - molecule syntax -s packages
    - echo "✅ Basic molecule test passed"

# Simple collection build
collection-build-simple:
  stage: build
  image: python:3.11-slim
  script:
    - python3 -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install ansible
    - ansible-galaxy collection build --force
    - ls -la *.tar.gz
    - echo "✅ Collection built successfully"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour
