---
- name: Prepare rust test environment
  hosts: all
  become: true
  gather_facts: true
  tasks:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install basic dependencies
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - build-essential
        state: present
      when: ansible_os_family == "Debian"

    - name: Create test user
      ansible.builtin.user:
        name: testuser
        create_home: true
        shell: /bin/bash
        state: present

    # Manual rustup installation for older distributions
    - name: Install rustup manually (Debian 12 / Ubuntu 22.04)
      block:
        - name: Download rustup installer
          ansible.builtin.get_url:
            url: https://sh.rustup.rs
            dest: /tmp/rustup-init.sh
            mode: "0755"

        - name: Install rustup for root (system-wide)
          ansible.builtin.command:
            cmd: /tmp/rustup-init.sh -y --default-toolchain stable
          environment:
            RUSTUP_HOME: /usr/local/rustup
            CARGO_HOME: /usr/local/cargo
          changed_when: true

        - name: Add cargo to system PATH
          ansible.builtin.lineinfile:
            path: /etc/environment
            line: 'PATH="/usr/local/cargo/bin:$PATH"'
            create: true

        - name: Create symlinks in /usr/local/bin
          ansible.builtin.file:
            src: "/usr/local/cargo/bin/{{ item }}"
            dest: "/usr/local/bin/{{ item }}"
            state: link
          loop:
            - rustup
            - cargo
            - rustc
      when: >
        (ansible_distribution == 'Debian' and ansible_distribution_major_version | int == 12) or
        (ansible_distribution == 'Ubuntu' and ansible_distribution_major_version | int == 22)
