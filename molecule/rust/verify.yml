---
- name: Verify rust installation
  hosts: all
  become: true
  tasks:
    - name: Check rustup is available
      ansible.builtin.command: which rustup
      register: rustup_path
      changed_when: false

    - name: Verify rustup path exists
      ansible.builtin.assert:
        that:
          - rustup_path.rc == 0
        fail_msg: "rustup command not found in PATH"

    - name: Check cargo is available
      ansible.builtin.command: which cargo
      register: cargo_path
      changed_when: false

    - name: Verify cargo path exists
      ansible.builtin.assert:
        that:
          - cargo_path.rc == 0
        fail_msg: "cargo command not found in PATH"

    - name: Check installed rust packages for testuser
      ansible.builtin.command: cargo install --list
      register: cargo_list
      become: true
      become_user: testuser
      changed_when: false

    - name: Verify rust packages were installed
      ansible.builtin.assert:
        that:
          - "'ripgrep' in cargo_list.stdout"
          - "'bat' in cargo_list.stdout"
        fail_msg: "Expected rust packages not found in cargo install --list"
