---
- name: Verify flatpak package management functionality
  hosts: all
  become: true
  gather_facts: true
  tasks:
    # Test 1: Verify flatpak is still installed (we didn't remove system packages)
    - name: Check if flatpak is installed
      ansible.builtin.package_facts:
        manager: auto

    - name: Verify flatpak system package exists
      ansible.builtin.assert:
        that:
          - "'flatpak' in ansible_facts.packages"
        fail_msg: "flatpak should still be installed"
        success_msg: "flatpak system package is present"

    # Test 2: Verify flatpak command works
    - name: Test flatpak command functionality
      ansible.builtin.command: flatpak --version
      register: flatpak_version
      changed_when: false
      failed_when: false

    - name: Verify flatpak command works
      ansible.builtin.assert:
        that:
          - flatpak_version.rc == 0
        fail_msg: "flatpak command should work"
        success_msg: "flatpak command is functional"

    # Test 3: Check installed flatpak packages (should be removed)
    - name: List installed flatpak packages
      ansible.builtin.command: flatpak list --app --columns=application
      register: installed_flatpaks
      changed_when: false
      failed_when: false

    - name: Verify flatpak packages were removed
      ansible.builtin.assert:
        that:
          - installed_flatpaks.stdout_lines | length == 0 or 'org.freedesktop.Platform' not in installed_flatpaks.stdout
        fail_msg: "Flatpak packages should have been removed"
        success_msg: "Flatpak packages were successfully removed"

    # Test 4: Check flatpak repositories (should be removed during cleanup)
    - name: List flatpak repositories
      ansible.builtin.command: flatpak remote-list
      register: flatpak_remotes
      changed_when: false
      failed_when: false

    - name: Display flatpak repositories
      ansible.builtin.debug:
        msg: "Flatpak repositories: {{ flatpak_remotes.stdout_lines | default(['none']) }}"

    # Test 5: Verify basic flatpak functionality still works
    - name: Test flatpak info command
      ansible.builtin.command: flatpak info --show-commit org.freedesktop.Platform//22.08
      register: flatpak_info
      changed_when: false
      failed_when: false

    # Test 6: Display summary for debugging
    - name: Display flatpak management summary
      ansible.builtin.debug:
        msg: |
          Host: {{ inventory_hostname }}
          Distribution: {{ ansible_distribution }}
          Installed flatpaks: {{ installed_flatpaks.stdout_lines | default(['none']) }}
          Flatpak remotes: {{ flatpak_remotes.stdout_lines | default(['none']) }}
          Flatpak version: {{ flatpak_version.stdout | default('unknown') }}
      tags: debug
