---
- name: Test flatpak package management functionality
  hosts: all
  become: true
  gather_facts: true
  tasks:
    # Phase 1: Install flatpak packages
    - name: Apply flatpak package management role (install)
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.manage_flatpak
      tags:
        - flatpak-packages
        - install-flatpak

    # Phase 2: Test removal functionality
    - name: Configure flatpak for removal testing
      ansible.builtin.set_fact:
        flatpak_packages:
          management_action: "remove"
          repositories:
            enable_flathub: true
            cleanup: true
          packages:
            install:
              - org.freedesktop.Platform//22.08
          remove:
            all_packages: true
            system_packages: false # Keep flatpak installed for testing
            cleanup_directories: false
            cleanup_repositories: true
          purge:
            confirm: false

    - name: Apply flatpak package management role (remove)
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.manage_flatpak
      tags:
        - flatpak-packages
        - remove-flatpak
