---
# Test dotfiles role with various scenarios
- name: Test dotfiles role deployment scenarios
  hosts: all
  gather_facts: true

  vars:
    # Test users for different dotfiles scenarios
    test_users:
      - name: testuser1
        uid: 1001
        shell: /bin/bash
        dotfiles_repository_url: "https://github.com/ohmyzsh/ohmyzsh.git"
        dotfiles_uses_stow: false  # Test non-stow scenario
        
      - name: testuser2  
        uid: 1002
        shell: /bin/bash
        dotfiles_repository_url: "https://github.com/mathiasbynens/dotfiles.git"
        dotfiles_uses_stow: true
        dotfiles_stow_packages: ["git", "vim"]

  pre_tasks:
    - name: Update package cache
      ansible.builtin.package:
        update_cache: true
      when: ansible_pkg_mgr in ['apt']

    - name: Install essential packages
      ansible.builtin.package:
        name:
          - git
          - stow
          - sudo
        state: present

    - name: Create test users
      ansible.builtin.user:
        name: "{{ item.name }}"
        uid: "{{ item.uid }}"
        shell: "{{ item.shell }}"
        create_home: true
        state: present
      loop: "{{ test_users }}"

  tasks:
    - name: Test dotfiles role with stow method
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.dotfiles
      vars:
        dotfiles_user: "{{ item.name }}"
        dotfiles_repository_url: "{{ item.dotfiles_repository_url }}"
        dotfiles_uses_stow: "{{ item.dotfiles_uses_stow }}"
        dotfiles_stow_packages: "{{ item.dotfiles_stow_packages | default([]) }}"
      loop: "{{ test_users }}"
      failed_when: false  # Don't fail test if repositories are unavailable

  post_tasks:
    - name: Display test completion
      ansible.builtin.debug:
        msg: "Dotfiles role testing completed for {{ test_users | length }} test scenarios"