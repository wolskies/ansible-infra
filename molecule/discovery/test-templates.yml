---
# Test playbook to validate current discovery templates with structured data
- name: Test current discovery templates
  hosts: localhost
  gather_facts: true
  vars:
    # Structured discovery data for testing current templates
    discovery_host_vars:
      packages:
        host_packages_install_Ubuntu: ["vim", "htop"]
        third_party_packages:
          python: ["requests", "flask"]
          nodejs:
            npm_global: ["typescript"]
      docker:
        install_docker: true
        docker_version: "24.0.7"
        install_docker_services: []
      users:
        discovered_users_config:
          - name: "testuser"
            uid: "1000"
            home: "/home/testuser"
            shell: "/bin/bash"
      discovery_metadata:
        source_hostname: "test-host"
        discovery_date: "2024-01-01T00:00:00Z"
    discovery_paths:
      inventory_dir: "/tmp/test"
      playbooks_dir: "/tmp/test"
      host_vars_dir: "/tmp/test/host_vars/test-host"
    inventory_hostname: "test-host"
    
  tasks:
    - name: Test current simple_host_vars template rendering
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../../roles/discovery/templates/simple_host_vars.yml.j2"
        dest: "/tmp/test-simple_host_vars.yml"
      register: simple_host_vars_result
      
    - name: Test current host_secrets template rendering  
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../../roles/discovery/templates/host_secrets.yml.j2"
        dest: "/tmp/test-host_secrets.yml"
      register: host_secrets_result
      
    - name: Verify current templates rendered successfully
      ansible.builtin.assert:
        that:
          - simple_host_vars_result is succeeded
          - host_secrets_result is succeeded
        fail_msg: "One or more current templates failed to render"
        
    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "Current template testing completed successfully"
          - "simple_host_vars.yml.j2: {{ 'OK' if simple_host_vars_result is succeeded else 'FAILED' }}"
          - "host_secrets.yml.j2: {{ 'OK' if host_secrets_result is succeeded else 'FAILED' }}"
