---
# Test edge cases that have caused runtime errors
- name: Test discovery edge cases
  hosts: localhost
  gather_facts: false
  vars:
    test_role_path: "{{ playbook_dir }}/../../roles/discovery"
  
  tasks:
    - name: Test case 1 - apt_keys as function instead of dict
      block:
        - name: Simulate apt_keys registration failure
          ansible.builtin.set_fact:
            test_repositories:
              apt:
                keys: "{{ 'some_function' }}"  # This would simulate a function object
                
        - name: Try to render template with bad keys
          ansible.builtin.template:
            src: "{{ test_role_path }}/templates/simple_host_vars.yml.j2"
            dest: "/tmp/test-bad-keys.yml"
          vars:
            host_packages_install_Ubuntu: "{{ test_repositories.apt.keys }}"  # This should be a list, not a string
            users_config: []
            firewall_enable: true
            config_hostname: "test"
            ansible_distribution: "Ubuntu"
            inventory_hostname: "test"
          ignore_errors: true
          register: bad_keys_result
          
        - name: Verify template handles bad keys gracefully
          ansible.builtin.assert:
            that:
              - bad_keys_result is succeeded or 'sequence' in (bad_keys_result.msg | default(''))
            fail_msg: "Template should handle non-list keys gracefully"

    - name: Test case 2 - Missing nested attributes
      ansible.builtin.template:
        src: "{{ test_role_path }}/templates/simple_host_vars.yml.j2"
        dest: "/tmp/test-missing-nested.yml"
      vars:
        # Some variables defined, some missing
        host_packages_install_Debian: ['vim']
        # users_config is intentionally missing
        firewall_enable: false
        # config_hostname is intentionally missing
        config_system_timezone: "UTC"
        ansible_distribution: "Debian"
        inventory_hostname: "missing-nested-test"
        ansible_architecture: "x86_64"
        ansible_date_time: { iso8601: "2024-01-01T00:00:00Z" }
      register: missing_nested_result
      
    - name: Verify missing nested attributes handled
      ansible.builtin.assert:
        that:
          - missing_nested_result is succeeded
        fail_msg: "Template must handle missing nested attributes"

    - name: Test case 3 - Null and undefined values
      ansible.builtin.template:
        src: "{{ test_role_path }}/templates/simple_host_vars.yml.j2"
        dest: "/tmp/test-null-values.yml"
      vars:
        host_packages_install_Ubuntu: null
        users_config: null
        firewall_enable: null
        firewall_custom_rules: null
        config_hostname: null
        config_system_timezone: null
        ansible_distribution: "Ubuntu"
        inventory_hostname: "null-test"
        ansible_architecture: "x86_64"
        ansible_date_time: { iso8601: "2024-01-01T00:00:00Z" }
      register: null_values_result
      
    - name: Verify null values handled
      ansible.builtin.assert:
        that:
          - null_values_result is succeeded
        fail_msg: "Template must handle null values"

    - name: Test case 4 - Completely undefined variables
      ansible.builtin.template:
        src: "{{ test_role_path }}/templates/simple_host_vars.yml.j2"
        dest: "/tmp/test-undefined-vars.yml"
      vars:
        ansible_distribution: "Ubuntu"
        inventory_hostname: "undefined-test"
        ansible_architecture: "x86_64"
        ansible_date_time: { iso8601: "2024-01-01T00:00:00Z" }
        # All discovery variables are intentionally not defined
      register: undefined_vars_result
      
    - name: Verify undefined variables handled
      ansible.builtin.assert:
        that:
          - undefined_vars_result is succeeded
        fail_msg: "Template must handle undefined variables gracefully"

    - name: Summary of edge case tests
      ansible.builtin.debug:
        msg:
          - "Edge case test results:"
          - "Bad keys test: {{ 'PASSED' if (bad_keys_result is succeeded or 'sequence' in (bad_keys_result.msg | default(''))) else 'FAILED' }}"
          - "Missing nested test: {{ 'PASSED' if missing_nested_result is succeeded else 'FAILED' }}"
          - "Null values test: {{ 'PASSED' if null_values_result is succeeded else 'FAILED' }}"
          - "Undefined vars test: {{ 'PASSED' if undefined_vars_result is succeeded else 'FAILED' }}"
