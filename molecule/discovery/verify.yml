---
- name: Verify discovery functionality
  hosts: all
  gather_facts: false
  tasks:
    - name: Check that host_vars file was created
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.ansible/tmp/{{ molecule_ephemeral_directory | basename }}.discovery/inventory/host_vars/ubuntu-discovery/vars.yml"
      register: host_vars_file
      delegate_to: localhost

    - name: Validate host_vars file exists
      ansible.builtin.assert:
        that:
          - host_vars_file.stat.exists
        fail_msg: "Discovery should create host_vars file at {{ ansible_user_dir }}/.ansible/tmp/{{ molecule_ephemeral_directory | basename }}.discovery/inventory/host_vars/ubuntu-discovery/vars.yml"

    - name: Read generated host_vars content
      ansible.builtin.slurp:
        src: "{{ ansible_user_dir }}/.ansible/tmp/{{ molecule_ephemeral_directory | basename }}.discovery/inventory/host_vars/ubuntu-discovery/vars.yml"
      register: host_vars_content
      delegate_to: localhost

    - name: Parse host_vars content
      ansible.builtin.set_fact:
        discovered_vars: "{{ host_vars_content.content | b64decode | from_yaml }}"

    - name: Validate discovered packages
      ansible.builtin.assert:
        that:
          - discovered_vars.host_packages_install_Ubuntu is defined
          - discovered_vars.host_packages_install_Ubuntu | length > 0
        fail_msg: "Should discover installed packages"

    - name: Validate firewall discovery
      ansible.builtin.assert:
        that:
          - discovered_vars.firewall_enable is defined
        fail_msg: "Should discover firewall status"
