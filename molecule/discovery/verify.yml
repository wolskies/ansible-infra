---
# Simple verification for discovery testing
- name: Verify infrastructure discovery
  hosts: discovery_targets
  gather_facts: false
  tasks:
    - name: Check for host vars file
      ansible.builtin.stat:
        path: "inventory/host_vars/{{ inventory_hostname }}/vars.yml"
      register: host_vars_file
      delegate_to: localhost

    - name: Verify host vars file exists
      ansible.builtin.assert:
        that:
          - host_vars_file.stat.exists
        fail_msg: "Host vars file not created"

    - name: Read generated host vars file
      ansible.builtin.slurp:
        src: "inventory/host_vars/{{ inventory_hostname }}/vars.yml"
      register: host_vars_content
      delegate_to: localhost

    - name: Parse and verify host vars content
      ansible.builtin.set_fact:
        discovered_vars: "{{ host_vars_content.content | b64decode | from_yaml }}"

    - name: Verify discovery worked
      ansible.builtin.assert:
        that:
          - discovered_vars is defined
          - discovered_vars is mapping
          - discovered_vars | length > 0
        fail_msg: "Discovery failed to create valid output"

    - name: Display discovery results
      ansible.builtin.debug:
        msg:
          - "Discovery verification completed"
          - "Variables discovered: {{ discovered_vars.keys() | list }}"