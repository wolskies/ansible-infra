---
# Verify infrastructure discovery functionality
- name: Verify infrastructure discovery
  hosts: discovery_targets
  gather_facts: false
  tasks:
    - name: Verify discovery output files exist
      block:
        - name: Check for host vars file
          ansible.builtin.stat:
            path: "{{ discovery_output_path }}/host_vars/{{ inventory_hostname }}.yml"
          register: host_vars_file
          delegate_to: localhost

        - name: Verify host vars file exists
          ansible.builtin.assert:
            that:
              - host_vars_file.stat.exists
            fail_msg: "Host vars file not created at {{ discovery_output_path }}/host_vars/{{ inventory_hostname }}.yml"

        - name: Check for deployment playbook
          ansible.builtin.stat:
            path: "{{ discovery_output_path }}/playbooks/{{ inventory_hostname }}_discovered.yml"
          register: playbook_file
          delegate_to: localhost

        - name: Verify deployment playbook exists
          ansible.builtin.assert:
            that:
              - playbook_file.stat.exists
            fail_msg: "Deployment playbook not created"

    - name: Verify discovered data content
      block:
        - name: Read generated host vars file
          ansible.builtin.slurp:
            src: "{{ discovery_output_path }}/host_vars/{{ inventory_hostname }}.yml"
          register: host_vars_content
          delegate_to: localhost

        - name: Parse host vars content
          ansible.builtin.set_fact:
            discovered_vars: "{{ host_vars_content.content | b64decode | from_yaml }}"

        - name: Verify all discovery tasks executed successfully
          ansible.builtin.assert:
            that:
              - discovered_vars is defined
              - discovered_vars is mapping
              - discovered_vars | length > 0
            fail_msg: "Discovery tasks did not complete successfully - no data discovered"

        - name: Verify basic discovery structure
          ansible.builtin.assert:
            that:
              - discovered_vars is defined
              - discovered_vars is mapping
            fail_msg: "Discovery output is not valid YAML structure"

        - name: Verify basic discovered data structure
          ansible.builtin.assert:
            that:
              - discovered_vars is defined
              - discovered_vars is mapping
            fail_msg: "Host vars file is not valid YAML or is empty"

        - name: Display discovery summary
          ansible.builtin.debug:
            msg:
              - "Discovery verification completed"
              - "Target: {{ inventory_hostname }}"
              - "Host vars created: {{ host_vars_file.stat.exists }}"
              - "Variables discovered: {{ discovered_vars.keys() | list | length if discovered_vars is mapping else 0 }}"

    - name: Test simplified template
      block:
        - name: Test template with simple data structure
          ansible.builtin.template:
            src: "{{ role_path }}/templates/simple_host_vars.yml.j2"
            dest: "/tmp/test-simple-data.yml"
          vars:
            discovery_host_vars:
              packages:
                host_packages_install_Ubuntu: ['vim', 'git', 'curl']
              users:
                discovered_users_config: []
              security:
                firewall_enabled: true
          delegate_to: localhost
          register: simple_template_result
          
        - name: Verify simple template rendered successfully
          ansible.builtin.assert:
            that:
              - simple_template_result is succeeded
            fail_msg: "Simple template failed to render"

        - name: Test template with empty data
          ansible.builtin.template:
            src: "{{ role_path }}/templates/simple_host_vars.yml.j2"
            dest: "/tmp/test-empty-data.yml"
          vars:
            discovery_host_vars: {}
          delegate_to: localhost
          register: empty_template_result
          
        - name: Verify empty data template rendered successfully
          ansible.builtin.assert:
            that:
              - empty_template_result is succeeded
            fail_msg: "Template failed with empty data"

        - name: Test template with undefined discovery_host_vars
          ansible.builtin.template:
            src: "{{ role_path }}/templates/simple_host_vars.yml.j2"
            dest: "/tmp/test-undefined.yml"
          delegate_to: localhost
          register: undefined_result
          
        - name: Verify undefined values handled gracefully
          ansible.builtin.assert:
            that:
              - undefined_result is succeeded
            fail_msg: "Template failed to handle undefined discovery_host_vars"
