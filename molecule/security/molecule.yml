---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: ubuntu-security-test
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
  - name: debian-security-test
    image: geerlingguy/docker-debian12-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        # Test security services configuration
        firewall:
          enabled: false # Disabled in containers - UFW requires kernel modules
          prevent_ssh_lockout: true
          package: "ufw"
          rules:
            - rule: allow
              port: 22
              proto: tcp
              comment: "SSH access"
            - rule: allow
              port: 80
              proto: tcp
              comment: "HTTP"
        fail2ban:
          enabled: false # Disabled in containers - fail2ban service doesn't work properly
          sender: "root@localhost"
          dest_email: ""
          services:
            - name: sshd
              enabled: true
              maxretry: 5
              bantime: 3600
              findtime: 600
              logpath: /var/log/auth.log
              client_alive_interval: 300
              client_alive_count_max: 2

    host_vars:
      ubuntu-security-test:
        # Test Ubuntu-specific security settings
        security_services:
          ufw:
            logging: "on"
            rules:
              - rule: deny
                from: 192.168.100.0/24
                comment: "Block test subnet"
              - rule: allow
                port: 8080
                proto: tcp
                src: 10.0.0.0/8
                comment: "Internal web access"

          fail2ban:
            email_notifications:
              enabled: false # Skip email in test
              sender: "fail2ban@example.com"
              recipient: "admin@example.com"

      debian-security-test:
        # Test Debian-specific security settings
        security_services:
          fail2ban:
            services:
              ssh:
                maxretry: 6 # Different from Ubuntu
                bantime: 1200
            custom_filters:
              test-filter:
                enabled: true
                definition: |
                  [Definition]
                  failregex = ^%(__prefix_line)s(?:error: PAM: )?[aA]uthentication (?:failure|error) for .* from <HOST>
                  ignoreregex =

  config_options:
    defaults:
      remote_tmp: /tmp/ansible-remote-tmp
      local_tmp: /tmp/ansible-local-tmp
      host_key_checking: false
      stdout_callback: ansible.builtin.default
      stdout_callback_format: yaml
verifier:
  name: ansible
