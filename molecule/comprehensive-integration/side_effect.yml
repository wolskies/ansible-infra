---
# Side effect tests - simulate real world changes between runs
- name: Simulate real-world changes that could break subsequent runs
  hosts: all
  gather_facts: true
  become: true
  tasks:

    # Simulate system changes that could affect role behavior
    - name: Simulate package removal
      ansible.builtin.package:
        name: git
        state: absent
      when: inventory_hostname == 'ubuntu-minimal'
      ignore_errors: true

    # Simulate user modifications
    - name: Modify existing user
      ansible.builtin.user:
        name: gooduser
        shell: /bin/zsh
      when: ansible_distribution == "Ubuntu"
      ignore_errors: true

    # Simulate snap package installation
    - name: Install additional snap package  # noqa: syntax-check[unknown-module]
      community.general.snap:
        name: core
        state: present
      when: 
        - ansible_distribution == "Ubuntu"
        - "'snap_systems' in group_names"
      ignore_errors: true

    # Simulate UFW rule changes
    - name: Add conflicting UFW rule
      community.general.ufw:
        rule: deny
        port: "2222"
        proto: tcp
      when: ansible_distribution == "Ubuntu"
      ignore_errors: true

    # Simulate file system changes
    - name: Create conflicting dotfiles directory
      ansible.builtin.file:
        path: /home/gooduser/.dotfiles
        state: directory
        owner: root
        group: root
      when: ansible_distribution != "Archlinux"
      ignore_errors: true

    # Simulate service state changes
    - name: Stop critical services
      ansible.builtin.systemd:
        name: systemd-timesyncd
        state: stopped
      ignore_errors: true

    - name: Display side effect summary
      ansible.builtin.debug:
        msg: "Applied side effects to test role resilience on {{ inventory_hostname }}"