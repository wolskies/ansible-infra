---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  # Multi-tier server architecture testing
  - name: web-server-integration
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    groups:
      - servers
      - web_servers

  - name: database-server-integration
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    groups:
      - servers
      - database_servers

  - name: workstation-integration
    image: geerlingguy/docker-debian12-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    groups:
      - workstations
      - developer_workstations

provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        # Enable consistent behavior for molecule tests
        molecule_test: true
        # Global timezone and hostname settings
        config_common_timezone: "UTC"
        config_common_hostname_manage: false # Skip in container

        # Global users for all machines
        users_config:
          - name: admin
            uid: 1001
            groups: [sudo]
            shell: /bin/bash
            comment: "System Administrator"
            create_home: true
          - name: monitoring
            uid: 1010
            groups: []
            shell: /usr/sbin/nologin
            comment: "Monitoring User"
            create_home: false

        # Global packages across all machines
        all_packages_install_Ubuntu:
          - curl
          - wget
          - git
          - htop
          - vim
          - rsync
        all_packages_install_Debian:
          - curl
          - wget
          - git
          - htop
          - vim
          - rsync

        # Global security configuration
        security_services:
          ufw:
            enabled: true
            default_policy:
              incoming: deny
              outgoing: allow
            rules:
              - rule: allow
                port: 22
                proto: tcp
                comment: "SSH"
          fail2ban:
            enabled: true
            services:
              ssh:
                enabled: true

        # Global firewall rules - SSH access
        firewall_rules:
          - rule: allow
            name: OpenSSH
            comment: "SSH access for all machines"

      servers:
        # Server group configuration
        group_packages_install_Ubuntu:
          - nginx
          - certbot
          - logrotate
          - cron

        # Enable comprehensive system configuration for servers
        configure_system:
          language_packages:
            enabled: true
          system_settings:
            enabled: true

        # Language packages for server development
        language_packages:
          python:
            enabled: true
            packages:
              - requests
              - flask
              - gunicorn
          nodejs:
            enabled: true
            packages:
              - express
              - pm2

        # System performance tuning for servers
        system_settings_sysctl:
          enabled: true
          parameters:
            vm.swappiness: 10
            net.core.somaxconn: 65535
            net.ipv4.tcp_keepalive_time: 120
            fs.file-max: 100000

        system_settings_limits:
          enabled: true
          limits:
            - domain: "*"
              limit_type: soft
              limit_item: nofile
              value: 65536
            - domain: "*"
              limit_type: hard
              limit_item: nofile
              value: 65536

      web_servers:
        # Web server specific packages
        group_packages_install_Ubuntu:
          - apache2-utils
          - ssl-cert

        # Web server specific firewall rules
        firewall_rules:
          - rule: allow
            port: 80
            proto: tcp
            comment: "HTTP"
          - rule: allow
            port: 443
            proto: tcp
            comment: "HTTPS"

        # Web server specific users
        users_config:
          - name: webuser
            uid: 2001
            groups: [www-data]
            shell: /usr/sbin/nologin
            comment: "Web Service User"
            create_home: false

      database_servers:
        # Database server specific packages
        group_packages_install_Ubuntu:
          - postgresql-client
          - redis-tools

        # Database server specific firewall rules
        firewall_rules:
          - rule: allow
            port: 5432
            proto: tcp
            src: 172.16.0.0/12
            comment: "PostgreSQL from internal network"
          - rule: allow
            port: 6379
            proto: tcp
            src: 172.16.0.0/12
            comment: "Redis from internal network"

        # Database server specific users
        users_config:
          - name: dbuser
            uid: 2002
            groups: []
            shell: /usr/sbin/nologin
            comment: "Database Service User"
            create_home: false

        # Database server performance tuning
        system_settings_sysctl:
          enabled: true
          parameters:
            vm.overcommit_memory: 2
            vm.overcommit_ratio: 80
            kernel.shmmax: 68719476736
            kernel.shmall: 16777216

      workstations:
        # Workstation specific packages
        group_packages_install_Debian:
          - firefox-esr
          - libreoffice-writer
          - git
          - code

        # Developer workstation users
        users_config:
          - name: developer
            uid: 1003
            groups: [sudo, docker]
            shell: /bin/zsh
            comment: "Developer User"
            create_home: true
          - name: designer
            uid: 1004
            groups: [audio, video]
            shell: /bin/bash
            comment: "Graphic Designer"
            create_home: true

        # Workstation features (disabled in container)
        configure_system:
          dotfiles_deployment:
            enabled: false # Skip in container
          flatpak_packages:
            enabled: false # Skip in container

        # Development language packages
        language_packages:
          python:
            enabled: true
            packages:
              - jupyter
              - pandas
              - numpy
          nodejs:
            enabled: true
            packages:
              - "@vue/cli"
              - typescript

        # Developer system limits
        system_settings_limits:
          enabled: true
          limits:
            - domain: developer
              limit_type: soft
              limit_item: nofile
              value: 65536
            - domain: developer
              limit_type: soft
              limit_item: nproc
              value: 32768

    host_vars:
      web-server-integration:
        # Web server specific host configuration
        host_packages_install_Ubuntu:
          - nginx-extras
          - fail2ban

        # Web server specific firewall rules
        firewall_rules:
          - rule: allow
            port: 8080
            proto: tcp
            src: 172.16.0.0/12
            comment: "Application server from internal network"

        # Web server performance tuning
        system_settings_sysctl:
          enabled: true
          parameters:
            net.core.netdev_max_backlog: 5000
            net.ipv4.tcp_congestion_control: bbr

      database-server-integration:
        # Database server specific host packages
        host_packages_install_Ubuntu:
          - postgresql-contrib
          - redis-server

        # Database specific system tuning
        system_settings_sysctl:
          enabled: true
          parameters:
            vm.dirty_ratio: 15
            vm.dirty_background_ratio: 5

      workstation-integration:
        # Workstation specific host packages
        host_packages_install_Debian:
          - gimp
          - inkscape
          - vlc

        # Workstation user with dotfiles configuration
        users_config:
          - name: power-user
            uid: 2003
            groups: [sudo, audio, video, plugdev]
            shell: /bin/zsh
            comment: "Power User"
            create_home: true

  config_options:
    defaults:
      roles_path: ../../roles
      host_key_checking: false
      stdout_callback: yaml

verifier:
  name: ansible
