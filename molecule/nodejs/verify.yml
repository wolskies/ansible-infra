---
- name: Verify nodejs installation
  hosts: all
  become: true
  tasks:
    - name: Check node is available
      ansible.builtin.command: which node
      register: node_path
      changed_when: false

    - name: Verify node path exists
      ansible.builtin.assert:
        that:
          - node_path.rc == 0
        fail_msg: "node command not found in PATH"

    - name: Check npm is available
      ansible.builtin.command: which npm
      register: npm_path
      changed_when: false

    - name: Verify npm path exists
      ansible.builtin.assert:
        that:
          - npm_path.rc == 0
        fail_msg: "npm command not found in PATH"

    - name: Check user's npm global directory exists
      ansible.builtin.stat:
        path: /home/testuser/.npm-global
      register: npm_global_dir

    - name: Verify npm global directory was created
      ansible.builtin.assert:
        that:
          - npm_global_dir.stat.exists
        fail_msg: "npm global directory not found"

    - name: Check installed npm packages for testuser
      ansible.builtin.command: npm list -g --depth=0 --prefix=/home/testuser/.npm-global
      register: npm_list
      become: true
      become_user: testuser
      environment:
        PATH: "/home/testuser/.npm-global/bin:{{ ansible_env.PATH }}"
      changed_when: false

    - name: Verify npm packages were installed
      ansible.builtin.assert:
        that:
          - "'eslint@' in npm_list.stdout"
          - "'prettier@' in npm_list.stdout"
        fail_msg: "Expected npm packages not found in npm list -g. Output was: {{ npm_list.stdout }}"
