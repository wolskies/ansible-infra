---
- name: Verify language toolchain installations
  hosts: all
  become: true
  tasks:
    # =============================================================================
    # USER VERIFICATION
    # =============================================================================
    - name: Verify test user exists
      ansible.builtin.getent:
        database: passwd
        key: testdev
      register: user_check

    - name: Assert user was created
      ansible.builtin.assert:
        that:
          - user_check.ansible_facts.getent_passwd.testdev is defined
        fail_msg: "Test user 'testdev' was not created"

    # =============================================================================
    # NODE.JS VERIFICATION
    # =============================================================================
    - name: Check if npm is available for testdev
      ansible.builtin.command: sudo -u testdev which npm
      register: npm_check
      changed_when: false
      failed_when: false

    - name: Verify npm is installed
      ansible.builtin.assert:
        that:
          - npm_check.rc == 0
        fail_msg: "npm not found for testdev user"
        success_msg: "npm successfully installed"

    - name: Check npm global packages for testdev
      ansible.builtin.command: sudo -u testdev npm list -g --depth=0
      register: npm_packages
      changed_when: false
      failed_when: false

    - name: Verify npm packages are installed
      ansible.builtin.assert:
        that:
          - "'typescript' in npm_packages.stdout"
          - "'eslint' in npm_packages.stdout"
          - "'prettier' in npm_packages.stdout"
        fail_msg: "npm packages not installed correctly"
        success_msg: "npm packages installed successfully"

    # =============================================================================
    # RUST VERIFICATION
    # =============================================================================
    - name: Check if cargo is available for testdev
      ansible.builtin.command: sudo -u testdev which cargo
      register: cargo_check
      changed_when: false
      failed_when: false

    - name: Verify cargo is installed
      ansible.builtin.assert:
        that:
          - cargo_check.rc == 0
        fail_msg: "cargo not found for testdev user"
        success_msg: "cargo successfully installed"

    - name: Check if rust packages are available
      ansible.builtin.command: sudo -u testdev which ripgrep
      register: rust_packages_check
      changed_when: false
      failed_when: false

    - name: Verify rust packages are installed
      ansible.builtin.assert:
        that:
          - rust_packages_check.rc == 0
        fail_msg: "rust packages not installed correctly"
        success_msg: "rust packages installed successfully"

    # =============================================================================
    # GO VERIFICATION
    # =============================================================================
    - name: Check if go is available for testdev
      ansible.builtin.command: sudo -u testdev which go
      register: go_check
      changed_when: false
      failed_when: false

    - name: Verify go is installed
      ansible.builtin.assert:
        that:
          - go_check.rc == 0
        fail_msg: "go not found for testdev user"
        success_msg: "go successfully installed"

    - name: Check go packages in user's GOPATH
      ansible.builtin.command: sudo -u testdev ls -la /home/testdev/go/bin/
      register: go_packages_check
      changed_when: false
      failed_when: false

    - name: Verify go packages are installed
      ansible.builtin.assert:
        that:
          - go_packages_check.rc == 0
          - go_packages_check.stdout | length > 0
        fail_msg: "go packages not installed correctly"
        success_msg: "go packages installed successfully"

    # =============================================================================
    # NEOVIM VERIFICATION
    # =============================================================================
    - name: Check if neovim is available for testdev
      ansible.builtin.command: sudo -u testdev which nvim
      register: nvim_check
      changed_when: false
      failed_when: false

    - name: Verify neovim is installed
      ansible.builtin.assert:
        that:
          - nvim_check.rc == 0
        fail_msg: "neovim not found for testdev user"
        success_msg: "neovim successfully installed"

    - name: Check neovim configuration exists
      ansible.builtin.stat:
        path: "/home/testdev/.config/nvim/init.lua"
      register: nvim_config

    - name: Verify neovim configuration is installed
      ansible.builtin.assert:
        that:
          - nvim_config.stat.exists
        fail_msg: "neovim configuration not installed"
        success_msg: "neovim configuration installed successfully"

    - name: Check vim alias exists
      ansible.builtin.stat:
        path: "/home/testdev/.local/bin/vim"
      register: vim_alias

    - name: Verify vim alias is installed
      ansible.builtin.assert:
        that:
          - vim_alias.stat.exists
          - vim_alias.stat.executable
        fail_msg: "vim alias not installed"
        success_msg: "vim alias installed successfully"

    # =============================================================================
    # TERMINAL CONFIGURATION VERIFICATION
    # =============================================================================
    - name: Check terminal terminfo directory exists
      ansible.builtin.stat:
        path: "/home/testdev/.terminfo"
      register: terminfo_dir

    - name: Verify terminfo directory was created
      ansible.builtin.assert:
        that:
          - terminfo_dir.stat.exists
          - terminfo_dir.stat.isdir
        fail_msg: "terminfo directory not created"
        success_msg: "terminfo directory created successfully"

    - name: Check alacritty terminfo entries
      ansible.builtin.command: sudo -u testdev infocmp -x alacritty
      register: alacritty_terminfo
      changed_when: false
      failed_when: false

    - name: Check kitty terminfo entries
      ansible.builtin.command: sudo -u testdev infocmp -x xterm-kitty
      register: kitty_terminfo
      changed_when: false
      failed_when: false

    - name: Verify terminal terminfo entries are available
      ansible.builtin.assert:
        that:
          - alacritty_terminfo.rc == 0 or kitty_terminfo.rc == 0
        fail_msg: "terminal terminfo entries not installed correctly"
        success_msg: "terminal terminfo entries installed successfully"

    # =============================================================================
    # CROSS-TOOLCHAIN VERIFICATION
    # =============================================================================
    - name: Display toolchain installation summary
      ansible.builtin.debug:
        msg:
          - "=== Language Toolchain Installation Complete ==="
          - "✅ Node.js: {{ 'PASS' if npm_check.rc == 0 else 'FAIL' }}"
          - "✅ Rust: {{ 'PASS' if cargo_check.rc == 0 else 'FAIL' }}"
          - "✅ Go: {{ 'PASS' if go_check.rc == 0 else 'FAIL' }}"
          - "✅ Neovim: {{ 'PASS' if nvim_check.rc == 0 else 'FAIL' }}"
          - "✅ Terminal Config: {{ 'PASS' if (alacritty_terminfo.rc == 0 or kitty_terminfo.rc == 0) else 'FAIL' }}"
          - "User: testdev created with proper toolchain access"
