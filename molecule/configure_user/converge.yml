---
- name: Converge
  hosts: all
  gather_facts: true
  tasks:
    - name: Test configure_user role per user
      ansible.builtin.include_role:
        name: wolskies.infrastructure.configure_user
      vars:
        target_user: "{{ user }}"
      loop: "{{ users }}"
      loop_control:
        loop_var: user
      when: user.name != 'root' # Skip system accounts
      tags:
        - user-config

    # Test idempotency by running again
    - name: Test configure_user role idempotency
      ansible.builtin.include_role:
        name: wolskies.infrastructure.configure_user
      vars:
        target_user: "{{ user }}"
      loop: "{{ users }}"
      loop_control:
        loop_var: user
      when: user.name != 'root' # Skip system accounts
      tags:
        - user-config
        - idempotency
