---
- name: Prepare configure_user test environment
  hosts: all
  become: true
  gather_facts: true
  tasks:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages for testing
      ansible.builtin.apt:
        name:
          - git
          - nodejs
          - npm
          - curl
          - wget
          - zsh
          - dash
          - python3-debian
        state: present
      when: ansible_os_family == "Debian"

    # Create test users that configure_user will configure
    - name: Create test users for configuration
      ansible.builtin.user:
        name: "{{ item }}"
        create_home: true
        shell: /bin/bash
        state: present
      loop:
        - testuser1
        - devuser
        - dotfilesuser
        - shelluser

    # Install Rust for testing (if not present)
    - name: Check if rustup exists
      ansible.builtin.stat:
        path: /usr/bin/rustup
      register: rustup_check

    - name: Install Rust toolchain for testing
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rustup-init.sh
        mode: "0755"
      when: not rustup_check.stat.exists

    - name: Run Rust installer
      ansible.builtin.command:
        cmd: /tmp/rustup-init.sh -y --default-toolchain stable
      environment:
        RUSTUP_HOME: /usr/local/rustup
        CARGO_HOME: /usr/local/cargo
      when: not rustup_check.stat.exists
      changed_when: true

    - name: Add cargo to PATH
      ansible.builtin.lineinfile:
        path: /etc/environment
        line: 'PATH="/usr/local/cargo/bin:$PATH"'
        create: true
      when: not rustup_check.stat.exists

    # Install Go for testing
    - name: Check if Go exists
      ansible.builtin.stat:
        path: /usr/bin/go
      register: go_check

    - name: Install Go if missing
      ansible.builtin.apt:
        name: golang
        state: present
      when: not go_check.stat.exists and ansible_os_family == "Debian"
