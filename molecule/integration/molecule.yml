---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: server-integration-test
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    groups:
      - servers
  - name: workstation-integration-test
    image: geerlingguy/docker-debian12-ansible:latest
    pre_build_image: true
    privileged: true
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    groups:
      - workstations
provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        # Global settings for all machines
        config_common_timezone: "UTC"
        config_common_hostname_manage: false # Skip in container

        # Global users
        users_config:
          - name: admin
            uid: 1001
            groups: [sudo]
            shell: /bin/bash
            comment: "System Administrator"
            create_home: true
          - name: operator
            uid: 1002
            groups: []
            shell: /bin/bash
            comment: "System Operator"
            create_home: true

        # Global packages
        all_packages_install_Ubuntu:
          - curl
          - git
          - htop
          - vim
        all_packages_install_Debian:
          - curl
          - git
          - htop
          - vim

        # Global security
        security_services:
          ufw:
            enabled: true
            default_policy:
              incoming: deny
              outgoing: allow
            rules:
              - rule: allow
                port: 22
                proto: tcp
                comment: "SSH"
          fail2ban:
            enabled: true
            services:
              ssh:
                enabled: true

        # Global firewall rules
        firewall_rules:
          - rule: allow
            name: OpenSSH
            comment: "SSH access"

      servers:
        # Server-specific configuration
        group_packages_install_Ubuntu:
          - nginx
          - certbot
          - htop

        # Enable optional components for servers
        configure_system:
          language_packages:
            enabled: true
          system_settings:
            enabled: true

        # Language packages for development
        language_packages:
          python:
            enabled: true
            packages:
              - requests
              - flask
          nodejs:
            enabled: true
            packages:
              - express
              - lodash

        # System performance tuning
        system_settings_sysctl:
          enabled: true
          parameters:
            vm.swappiness: 10
            net.core.somaxconn: 65535
            net.ipv4.tcp_keepalive_time: 120

        # Server-specific firewall rules
        firewall_rules:
          - rule: allow
            port: 80
            proto: tcp
            comment: "HTTP"
          - rule: allow
            port: 443
            proto: tcp
            comment: "HTTPS"

      workstations:
        # Workstation-specific packages
        group_packages_install_Debian:
          - firefox-esr
          - libreoffice-writer
          - code

        # Workstation user configuration
        users_config:
          - name: developer
            uid: 1003
            groups: [sudo, docker]
            shell: /bin/zsh
            comment: "Developer User"
            create_home: true

        # Enable workstation features
        configure_system:
          dotfiles_deployment:
            enabled: false # Skip in container
          flatpak_packages:
            enabled: false # Skip in container

        # System settings for workstation
        system_settings_limits:
          enabled: true
          limits:
            - domain: developer
              limit_type: soft
              limit_item: nofile
              value: 65536

    host_vars:
      server-integration-test:
        # Server-specific host configuration
        host_packages_install_Ubuntu:
          - redis-server
          - postgresql-client

        # Server-specific users
        users_config:
          - name: webuser
            uid: 2001
            groups: [www-data]
            shell: /usr/sbin/nologin
            comment: "Web Service User"
            create_home: false

        # Host-specific firewall rules
        firewall_rules:
          - rule: allow
            port: 6379
            proto: tcp
            src: 10.0.0.0/8
            comment: "Redis from internal network"

      workstation-integration-test:
        # Workstation-specific host configuration
        host_packages_install_Debian:
          - gimp
          - inkscape

        # Development user with dotfiles
        users_config:
          - name: designer
            uid: 2002
            groups: [audio, video]
            shell: /bin/bash
            comment: "Graphic Designer"
            create_home: true

  config_options:
    defaults:
      host_key_checking: false
      stdout_callback: yaml
verifier:
  name: ansible
