---
# Prepare test environment for new-machine playbook testing
- name: Prepare test machines
  hosts: all
  gather_facts: true
  become: true
  
  tasks:
    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      
    - name: Install basic test packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - python3
          - python3-pip
          - systemd
          - git
          - curl
        state: present
      when: ansible_os_family == "Debian"
      
    - name: Create test user directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /home/testuser
        - /tmp/discovery-test
        - /etc/test-configs
        
    - name: Create mock dotfiles directory
      ansible.builtin.file:
        path: /home/testuser/.dotfiles
        state: directory
        mode: '0755'
        
    - name: Create test configuration files for discovery
      ansible.builtin.copy:
        content: |
          # Test configuration file
          test_setting=value
          discovery_test=true
        dest: "/etc/test-configs/{{ item }}"
        mode: '0644'
      loop:
        - test.conf
        - discovery.conf
        
    - name: Install test packages for discovery scanning
      ansible.builtin.package:
        name: "{{ test_discovery_packages | default(['vim']) }}"
        state: present
      ignore_errors: true  # Some packages might not exist in test images
      
    - name: Create test systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Test Discovery Service
          After=network.target
          
          [Service]
          Type=simple
          ExecStart=/bin/sleep 3600
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/test-discovery-service.service
        mode: '0644'
      notify: reload systemd
        
    - name: Enable test service
      ansible.builtin.systemd:
        name: test-discovery-service
        enabled: true
        daemon_reload: true
      ignore_errors: true
      
  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true