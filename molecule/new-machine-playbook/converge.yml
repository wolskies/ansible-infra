---
# Test the complete new-machine setup workflow
- name: Test new-machine playbook workflow
  hosts: all
  gather_facts: true
  collections:
    - wolskinet.infrastructure
  
  vars:
    # Override for testing - disable slow operations
    reboot_after_setup: false
    enable_maintenances: false
    
  tasks:
    # Phase 1: Run discovery on the prepared machines
    - name: Run infrastructure discovery
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.discovery
      vars:
        discovery:
          output_dir: "/tmp/discovery-test/{{ inventory_hostname }}"
          generate_configs: true
          include_sensitive: false
          timeout: 60
      tags: discovery
      
    # Phase 2: Test core roles from new-machine setup
    - name: Test basic_setup role
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.basic_setup
        apply:
          become: true
      vars:
        # Safety overrides for testing
        security_hardening_enabled: false
        ssh_hardening_enabled: false
        install_dotfiles: false
        host_enable_docker: false
        reboot_after_setup: false
        # Use mock discovered data
        discovered_machine_type: "{{ machine_type | default('workstation') }}"
      tags: new_machine
      
    - name: Test maintenance role
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.maintenance
        apply:
          become: false
      vars:
        enable_maintenances: false  # Skip actual updates in tests
      tags: new_machine
      
    # Phase 3: Verify hierarchical variable merging
    - name: Test hierarchical variable system
      ansible.builtin.include_role:
        name: wolskinet.infrastructure.basic_setup
        tasks_from: merge-variables
      vars:
        # Test data for variable merging
        global_packages_install:
          - git
          - curl
        group_packages_install:
          - wget
          - htop
        host_packages_install:
          - vim
        discovered_packages_install:
          - nano
      tags: variables
      
    - name: Verify variable merging results
      ansible.builtin.assert:
        that:
          - final_packages_install is defined
          - "'git' in final_packages_install"
          - "'curl' in final_packages_install" 
          - "'wget' in final_packages_install"
          - "'htop' in final_packages_install"
          - "'vim' in final_packages_install"
          - "'nano' in final_packages_install"
        success_msg: "Hierarchical variable merging works correctly"
        fail_msg: "Variable merging failed - packages: {{ final_packages_install | default('undefined') }}"
      tags: variables
      
    - name: Display test completion summary
      ansible.builtin.debug:
        msg:
          - "=== New-Machine Playbook Test Completed ==="
          - "Host: {{ inventory_hostname }}"
          - "Machine Type: {{ machine_type | default('workstation') }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version | default('Unknown') }}"
          - "Discovery Output: /tmp/discovery-test/{{ inventory_hostname }}"
          - "Final Packages: {{ final_packages_install | default([]) | length }}"
          - "Variable Merging: âœ“ Successful"