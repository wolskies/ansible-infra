---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: ubuntu-firewall-test
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    pre_build_image: true
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
  - name: debian-firewall-test
    image: geerlingguy/docker-debian12-ansible:latest
    pre_build_image: true
    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    command: "/lib/systemd/systemd"
    capabilities:
      - NET_ADMIN
      - SYS_ADMIN
provisioner:
  name: ansible
  inventory:
    group_vars:
      all:
        ansible_user: root
        # Enable consistent behavior for molecule tests
        molecule_test: true
        # Test firewall rules configuration
        firewall_rules:
          - rule: allow
            port: "80"
            proto: tcp
            comment: "HTTP traffic for testing"
          - rule: allow
            port: "443"
            proto: tcp
            comment: "HTTPS traffic for testing"
          - rule: allow
            port: "8080"
            proto: tcp
            src: "192.168.1.0/24"
            comment: "App server from local network"
          - rule: deny
            port: "23"
            proto: tcp
            comment: "Block telnet"
        # Security services configuration
        security_firewall_common:
          enabled: true
          start: true
          prevent_ssh_lockout: true
        security_firewall_linux:
          rate_limiting:
            enabled: true
            connections: 6
            period: 30
            comment: "SSH rate limiting test"
        security_fail2ban_common:
          enabled: true
          start: true
          sender: "root@localhost"
          dest_email: ""
  config_options:
    defaults:
      host_key_checking: false
      stdout_callback: yaml
verifier:
  name: ansible
