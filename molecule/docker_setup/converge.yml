---
# Test docker_setup role specifically
- name: Test docker_setup role
  hosts: all
  gather_facts: true
  collections:
    - wolskinet.infrastructure
    - community.docker
  
  pre_tasks:
    - name: Update package cache
      ansible.builtin.package:
        update_cache: true
      when: ansible_pkg_mgr in ['apt', 'pacman']

    - name: Install prerequisites for Docker testing
      ansible.builtin.package:
        name:
          - python3-pip
        state: present
      when: ansible_pkg_mgr == 'apt'

    - name: Install Docker SDK for Python
      ansible.builtin.pip:
        name: docker
        state: present

  roles:
    - name: wolskinet.infrastructure.docker_setup

  post_tasks:
    - name: Verify role execution
      ansible.builtin.debug:
        msg: "docker_setup role completed on {{ ansible_distribution }}"

    - name: Wait for Docker service to be ready
      ansible.builtin.wait_for:
        port: 2375
        host: localhost
        delay: 5
        timeout: 60
      failed_when: false

    - name: Test basic Docker functionality
      community.docker.docker_container:
        name: test-hello-world
        image: hello-world
        state: started
        auto_remove: true
      register: hello_world_test
      failed_when: false

    - name: Display Docker test result
      ansible.builtin.debug:
        msg: "Docker hello-world test: {{ 'PASSED' if hello_world_test is succeeded else 'FAILED' }}"