---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Check if service directory exists (service test only)
      ansible.builtin.stat:
        path: "{{ docker_services_root }}/{{ service_name }}"
      register: service_dir
      when: test_docker_only is not defined

    - name: Check if docker-compose.yml exists (service test only)
      ansible.builtin.stat:
        path: "{{ docker_services_root }}/{{ service_name }}/docker-compose.yml"
      register: compose_file
      when: test_docker_only is not defined

    - name: Check if .env file exists (service test only)
      ansible.builtin.stat:
        path: "{{ docker_services_root }}/{{ service_name }}/.env"
      register: env_file
      when: test_docker_only is not defined

    - name: Assert service files exist (service test only)
      ansible.builtin.assert:
        that:
          - service_dir.stat.exists
          - service_dir.stat.isdir
          - compose_file.stat.exists
          - env_file.stat.exists
        fail_msg: "Docker service files not properly deployed"
      when: test_docker_only is not defined

    - name: Read docker-compose.yml content (service test only)
      ansible.builtin.slurp:
        src: "{{ docker_services_root }}/{{ service_name }}/docker-compose.yml"
      register: compose_content
      when: test_docker_only is not defined

    - name: Verify template rendering (service test only)
      ansible.builtin.assert:
        that:
          - "'nginx-test:' in (compose_content.content | b64decode)"
          - '''- ":80"'' in (compose_content.content | b64decode)'
          - "'image: nginx:alpine' in (compose_content.content | b64decode)"
          - "'env_file:' in (compose_content.content | b64decode)"
        fail_msg: "docker-compose.yml template rendering failed - service_use_proxy variable not working"
      when: test_docker_only is not defined

    - name: Validate docker-compose.yml is valid YAML (service test only)
      ansible.builtin.set_fact:
        parsed_compose: "{{ compose_content.content | b64decode | from_yaml }}"
      when: test_docker_only is not defined

    - name: Assert docker-compose.yml structure is valid (service test only)
      ansible.builtin.assert:
        that:
          - parsed_compose is defined
          - parsed_compose.services is defined
          - parsed_compose.services['nginx-test'] is defined
        fail_msg: "docker-compose.yml is not valid YAML or missing required structure"
      when: test_docker_only is not defined
