---
- name: Validate required variables
  ansible.builtin.assert:
    that:
      - node_user is defined
      - node_user | length > 0
      - node_packages is defined
    fail_msg: "nodejs role requires node_user and node_packages variables"

- name: Install Node.js system dependencies (Debian/Ubuntu)
  ansible.builtin.include_tasks: setup-Debian.yml
  when:
    - ansible_os_family == 'Debian'

- name: Install Node.js system dependencies (Arch Linux)
  ansible.builtin.include_tasks: setup-Archlinux.yml
  when:
    - ansible_os_family == 'Archlinux'

- name: Install Node.js system dependencies (macOS)
  ansible.builtin.include_tasks: setup-Darwin.yml
  when:
    - ansible_system == 'Darwin'

- name: Create npm global directory for {{ node_user }}
  ansible.builtin.file:
    path: "{{ npm_config_prefix }}"
    state: directory
    mode: "0755"
  become: true
  become_user: "{{ node_user }}"
  when: node_packages | length > 0
  tags:
    - nodejs
    - user-packages

- name: Install npm packages globally for {{ node_user }}
  community.general.npm:
    name: "{{ node_package.name | default(node_package) }}"
    version: "{{ node_package.version | default(omit) }}"
    global: true
    state: present
  environment:
    NPM_CONFIG_PREFIX: "{{ npm_config_prefix }}"
    NODE_PATH: "{{ npm_config_prefix }}/lib/node_modules"
    NPM_CONFIG_UNSAFE_PERM: "{{ npm_config_unsafe_perm }}"
  loop: "{{ node_packages }}"
  loop_control:
    loop_var: node_package
  become: true
  become_user: "{{ node_user }}"
  when: node_packages | length > 0
  tags:
    - nodejs
    - user-packages

- name: Get node_user home directory
  ansible.builtin.user:
    name: "{{ node_user }}"
  register: node_user_info
  when: node_packages | length > 0

- name: Add npm global bin to user's PATH in ~/.profile
  ansible.builtin.lineinfile:
    path: "{{ node_user_info.home }}/.profile"
    line: 'export PATH="{{ npm_config_prefix | regex_replace("^~", "$HOME") }}/bin:$PATH"'
    regexp: '^export PATH=.*{{ npm_config_prefix | regex_replace("^~", "\\$HOME") | regex_escape }}/bin.*'
    create: true
    mode: "0644"
    owner: "{{ node_user }}"
    group: "{{ node_user }}"
  become: true
  when: node_packages | length > 0
  tags:
    - nodejs
    - user-packages
