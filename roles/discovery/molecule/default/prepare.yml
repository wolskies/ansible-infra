---
- name: Prepare discovery test environment
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for container to be ready
      ansible.builtin.wait_for_connection:
        delay: 2
        timeout: 30

    - name: Install essential packages and UFW
      ansible.builtin.apt:
        name:
          - python3
          - python3-pip
          - sudo
          - ufw
          - curl
          - wget
          - git
        state: present
        update_cache: true
      failed_when: false

    - name: Create some test packages to discover
      ansible.builtin.apt:
        name:
          - htop
          - vim
          - tree
        state: present
      failed_when: false

    - name: Set up UFW for testing
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - "22"
        - "80"
        - "443"
      become: true
      failed_when: false

    - name: Enable UFW
      community.general.ufw:
        state: enabled
        policy: deny
      become: true
      failed_when: false

    - name: Create test directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /tmp/host_vars
        - /tmp/host_vars/ubuntu-discovery

    - name: Gather facts after preparation
      ansible.builtin.setup:
