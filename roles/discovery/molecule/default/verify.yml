---
- name: Verify discovery functionality
  hosts: all
  gather_facts: true
  tasks:
    - name: Validate system information was collected
      ansible.builtin.assert:
        that:
          - ansible_distribution is defined
          - ansible_hostname is defined
          - ansible_os_family is defined
        fail_msg: "System facts should be collected during discovery"

    - name: Check package discovery worked (Debian/Ubuntu)
      ansible.builtin.command:
        cmd: dpkg -l
      register: package_check_deb
      changed_when: false
      when: ansible_os_family == 'Debian'

    - name: Check package discovery worked (Arch Linux)
      ansible.builtin.command:
        cmd: pacman -Q
      register: package_check_arch
      changed_when: false
      when: ansible_os_family == 'Archlinux'

    - name: Validate package discovery functionality
      ansible.builtin.assert:
        that:
          - (ansible_os_family == 'Debian' and package_check_deb.stdout_lines | length > 0) or
            (ansible_os_family == 'Archlinux' and package_check_arch.stdout_lines | length > 0)
        fail_msg: "Should be able to query installed packages on {{ ansible_os_family }}"

    - name: Check user discovery worked
      ansible.builtin.command:
        cmd: cat /etc/passwd
      register: users_check
      changed_when: false

    - name: Validate user discovery functionality
      ansible.builtin.assert:
        that:
          - users_check.stdout_lines | length > 0
          - "'root' in users_check.stdout"
        fail_msg: "Should be able to discover system users"

    - name: Discovery functionality validated
      ansible.builtin.debug:
        msg:
          - "=== Discovery Role Verification Complete ==="
          - "System: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Host: {{ ansible_hostname }}"
          - "Discovery role successfully executed and discovered system information"
          - "Packages found: {{ package_check.stdout_lines | length }} packages"
          - "Users discoverable: Yes"
