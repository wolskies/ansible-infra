---
# Simplified Discovery Role - trust Ansible's built-ins

- name: Validate supported OS versions
  ansible.builtin.fail:
    msg: |
      {{ ansible_distribution }} {{ ansible_distribution_version }} is not supported.
      Supported distributions:
      - Ubuntu 22+
      - Debian 12+
      - Arch Linux
      - macOS
  when:
    - (ansible_distribution == "Ubuntu" and ansible_distribution_major_version | int < 22) or
      (ansible_distribution == "Debian" and ansible_distribution_major_version | int < 12) or
      (ansible_distribution not in ["Archlinux", "Ubuntu", "Debian", "MacOSX"])
  tags:
    - always
    - validation
    - discovery

- name: Set output path
  ansible.builtin.set_fact:
    discovery_paths:
      host_vars_dir: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}"
      host_vars_file: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}/vars.yml"
  delegate_to: localhost

- name: Debug discovery paths
  ansible.builtin.debug:
    msg:
      - "inventory_file: {{ inventory_file | default('undefined') }}"
      - "host_vars_dir: {{ discovery_paths.host_vars_dir }}"
      - "host_vars_file: {{ discovery_paths.host_vars_file }}"
  delegate_to: localhost
  when: discovery_debug | default(false)

- name: Create output directory
  ansible.builtin.file:
    path: "{{ discovery_paths.host_vars_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Gather system facts
  ansible.builtin.setup:

- name: Gather package facts (Linux only)
  ansible.builtin.package_facts:
    manager: auto
  when: ansible_system == "Linux"

- name: Discover packages
  ansible.builtin.include_tasks: scan-packages.yml

- name: Discover APT repositories
  ansible.builtin.include_tasks: scan-apt-repositories.yml
  when: ansible_os_family == "Debian"

- name: Discover users
  ansible.builtin.include_tasks: scan-users.yml

- name: Discover firewall rules
  ansible.builtin.include_tasks: scan-firewall.yml

- name: Discover language packages
  ansible.builtin.include_tasks: scan-language-packages.yml

- name: Get current timezone configuration
  community.general.timezone:
    name: ""
  check_mode: true
  register: current_timezone
  failed_when: false

- name: Set basic host variables (same variable names as before)
  ansible.builtin.set_fact:
    config_hostname: "{{ ansible_hostname }}"
    config_system_timezone: "{{ current_timezone.name | default('UTC') }}"

- name: Generate host variables file
  ansible.builtin.template:
    src: simple_host_vars.yml.j2
    dest: "{{ discovery_paths.host_vars_file }}"
    mode: '0644'
  delegate_to: localhost

- name: Show discovery completion
  ansible.builtin.debug:
    msg:
      - "=== Infrastructure Discovery Completed ==="
      - "Generated: {{ discovery_paths.host_vars_file }}"
