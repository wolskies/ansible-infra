---
# Discovery Role Main Tasks

- name: Initialize discovery environment
  block:
    - name: Validate supported OS
      ansible.builtin.fail:
        msg: >-
          {{ ansible_distribution }} {{ ansible_distribution_version }} not supported.
          Need: Ubuntu 24+, Debian 12+, Arch, macOS
      when:
        - (ansible_distribution == "Ubuntu" and ansible_distribution_major_version | int < 24) or
          (ansible_distribution == "Debian" and ansible_distribution_major_version | int < 12)

    - name: Set discovery output paths using Ansible inventory location
      ansible.builtin.set_fact:
        discovery_paths:
          host_vars_dir: "{{ discovery.inventory_dir | default((inventory_file | dirname) if inventory_file is defined else 'inventory') }}/host_vars/{{ inventory_hostname }}"
          host_vars_file: "{{ discovery.inventory_dir | default((inventory_file | dirname) if inventory_file is defined else 'inventory') }}/host_vars/{{ inventory_hostname }}/vars.yml"
      delegate_to: localhost
      run_once: true

    - name: Display discovery start message
      ansible.builtin.debug:
        msg:
          - "=== Infrastructure Discovery Starting ==="
          - "Target: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Host vars output: {{ discovery_paths.host_vars_file }}"
          - "Host directory: {{ discovery_paths.host_vars_dir }}"

    - name: Create discovery output directories on Ansible controller
      ansible.builtin.file:
        path: "{{ discovery_paths.host_vars_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
  tags:
    - discovery
    - setup

- name: Discover system information
  ansible.builtin.include_tasks: scan-system.yml
  tags:
    - discovery
    - system

- name: Discover packages and repositories
  ansible.builtin.include_tasks: scan-packages.yml
  tags:
    - discovery
    - packages

- name: Discover services and security configurations
  ansible.builtin.include_tasks: scan-services.yml
  tags:
    - discovery
    - services
    - security

- name: Discover Docker environment
  ansible.builtin.include_tasks: scan-docker.yml
  tags:
    - discovery
    - docker

- name: Discover user environment
  ansible.builtin.include_tasks: scan-users.yml
  tags:
    - discovery
    - users

- name: Enhanced dotfiles discovery
  ansible.builtin.include_tasks: scan-dotfiles.yml
  tags:
    - discovery
    - dotfiles

- name: Process discovery data
  ansible.builtin.include_tasks: process-data.yml
  tags:
    - discovery
    - processing

- name: Generate role-specific variables
  ansible.builtin.include_tasks: generate-role-vars.yml
  tags:
    - discovery
    - role-integration

- name: Generate configuration files
  ansible.builtin.include_tasks: generate-configs.yml
  when: discovery.generate_configs
  tags:
    - discovery
    - generation

- name: Display discovery completion
  block:
    - name: Show discovery summary
      ansible.builtin.debug:
        msg:
          - "=== Infrastructure Discovery Completed ==="
          - "Hostname: {{ inventory_hostname }}"
          - "Packages: {{ discovered_packages.total | default(0) }}"
          - "Services: {{ discovered_services.running | default([]) | length }}"
          - "Docker: {{ 'Enabled' if discovered_docker.installed | default(false) else 'Not installed' }}"
          - "Users discovered: {{ discovered_users.system_users.regular_users_detailed | default([]) | length }} (with per-user dotfiles config)"
          - ""
          - "Generated files:"
          - "  Host vars: {{ discovery_paths.host_vars_file }}"
          - "  Host directory: {{ discovery_paths.host_vars_dir }}"
          - ""
          - "Ready for collection use:"
          - "1. Review {{ discovery_paths.host_vars_file }}"
          - "2. Use with: ansible-playbook playbooks/your-deployment.yml -l {{ inventory_hostname }}"
          - "3. The basic_setup role will automatically use discovered packages"

  tags:
    - discovery
    - summary
