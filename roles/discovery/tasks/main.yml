---
# Simplified Discovery Role - trust Ansible's built-ins

- name: Set output path
  ansible.builtin.set_fact:
    discovery_paths:
      host_vars_dir: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}"
      host_vars_file: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}/vars.yml"
  delegate_to: localhost

- name: Debug discovery paths
  ansible.builtin.debug:
    msg:
      - "inventory_file: {{ inventory_file | default('undefined') }}"
      - "host_vars_dir: {{ discovery_paths.host_vars_dir }}"
      - "host_vars_file: {{ discovery_paths.host_vars_file }}"
  delegate_to: localhost

- name: Create output directory
  ansible.builtin.file:
    path: "{{ discovery_paths.host_vars_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Get system facts
  ansible.builtin.setup:

- name: Discover packages
  ansible.builtin.include_tasks: scan-packages.yml

- name: Discover repositories
  ansible.builtin.include_tasks: scan-repositories.yml

- name: Discover users
  ansible.builtin.include_tasks: scan-users.yml

- name: Discover firewall rules
  ansible.builtin.include_tasks: scan-firewall.yml

- name: Get system timezone
  ansible.builtin.command: timedatectl show -p Timezone --value
  register: system_timezone
  changed_when: false
  failed_when: false

- name: Fallback timezone detection for systems without timedatectl
  ansible.builtin.command: readlink -f /etc/localtime
  register: timezone_link
  changed_when: false
  failed_when: false
  when: system_timezone.rc != 0

- name: Set basic host variables (same variable names as before)
  ansible.builtin.set_fact:
    config_hostname: "{{ ansible_hostname }}"
    config_system_timezone: >-
      {%- if system_timezone.rc == 0 and system_timezone.stdout -%}
        {{ system_timezone.stdout }}
      {%- elif timezone_link.rc == 0 and timezone_link.stdout -%}
        {{ timezone_link.stdout | regex_replace('^.*/zoneinfo/', '') }}
      {%- else -%}
        UTC
      {%- endif -%}

- name: Generate host variables file
  ansible.builtin.template:
    src: simple_host_vars.yml.j2
    dest: "{{ discovery_paths.host_vars_file }}"
    mode: '0644'
  delegate_to: localhost

- name: Show discovery completion
  ansible.builtin.debug:
    msg:
      - "=== Infrastructure Discovery Completed ==="
      - "Generated: {{ discovery_paths.host_vars_file }}"
