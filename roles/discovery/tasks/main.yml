---
# Simplified Discovery Role - trust Ansible's built-ins

- name: Set output path
  ansible.builtin.set_fact:
    discovery_paths:
      host_vars_dir: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}"
      host_vars_file: "{{ (inventory_file | dirname) if inventory_file is defined else 'inventory' }}/host_vars/{{ inventory_hostname }}/vars.yml"
  delegate_to: localhost

- name: Create output directory
  ansible.builtin.file:
    path: "{{ discovery_paths.host_vars_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Get system facts
  ansible.builtin.setup:

- name: Discover packages
  ansible.builtin.include_tasks: scan-packages.yml

- name: Discover repositories
  ansible.builtin.include_tasks: scan-repositories.yml

- name: Discover users
  ansible.builtin.include_tasks: scan-users.yml

- name: Set basic host variables (same variable names as before)
  ansible.builtin.set_fact:
    config_hostname: "{{ ansible_hostname }}"
    config_system_timezone: "{{ ansible_date_time.tz }}"
    firewall_enable: false

- name: Generate host variables file
  ansible.builtin.template:
    src: simple_host_vars.yml.j2
    dest: "{{ discovery_paths.host_vars_file }}"
    mode: '0644'
  delegate_to: localhost

- name: Generate secrets template file
  ansible.builtin.template:
    src: host_secrets.yml.j2
    dest: "{{ discovery_paths.host_vars_dir }}/secrets.yml"
    mode: '0600'
  delegate_to: localhost

- name: Show discovery completion
  ansible.builtin.debug:
    msg:
      - "=== Infrastructure Discovery Completed ==="
      - "Generated: {{ discovery_paths.host_vars_file }}"
