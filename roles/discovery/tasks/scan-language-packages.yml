---
# Language package discovery for multiple ecosystems

# Python packages (pip)
- name: Discover Python packages
  block:
    - name: Get pip packages (global)
      ansible.builtin.command: pip3 list --format=freeze
      register: pip_packages
      changed_when: false
      failed_when: false
      become: true

    - name: Extract pip package names
      ansible.builtin.set_fact:
        pip_package_names: >-
          {{
            (pip_packages.stdout_lines | default([])
            | map('regex_replace', '^([^=]+)==.*$', '\1')
            | select('match', '^[^=]+$')
            | list)
          }}

    - name: Filter out system-managed Python packages
      ansible.builtin.set_fact:
        discovered_python_packages: >-
          {{
            pip_package_names | reject('in', system_python_packages) | list | unique | sort
          }}
      vars:
        # Find system packages that match pip package names
        # Convert python3-package -> package, python-package -> package
        system_python_packages: >-
          {{
            (ansible_facts.packages.keys() | list
            | select('match', '^python3?-')
            | map('regex_replace', '^python3?-(.+)$', '\1')
            | list) +
            (ansible_facts.packages.keys() | list
            | select('match', '^python3?$')
            | list)
          }}
  when: >
    'python3' in ansible_facts.packages or
    'python' in ansible_facts.packages or
    'python3-pip' in ansible_facts.packages

# Node.js packages (npm)
- name: Discover Node.js packages
  block:
    - name: Get npm packages (global)
      ansible.builtin.command: npm list -g --depth=0 --parseable
      register: npm_packages
      changed_when: false
      failed_when: false

    - name: Extract npm package names
      ansible.builtin.set_fact:
        npm_package_names: >-
          {{
            (npm_packages.stdout_lines | default([])
            | map('regex_replace', '^.*/node_modules/(.+)$', '\1')
            | select('match', '^[^/]+$')
            | reject('equalto', 'npm')
            | list)
          }}

    - name: Filter out system-managed Node.js packages
      ansible.builtin.set_fact:
        discovered_nodejs_packages_global: >-
          {{
            npm_package_names | reject('in', system_nodejs_packages) | list | unique | sort
          }}
      vars:
        # Find system packages that match npm package names
        # Convert node-package -> package, nodejs-package -> package
        system_nodejs_packages: >-
          {{
            (ansible_facts.packages.keys() | list
            | select('match', '^nodejs?-')
            | map('regex_replace', '^nodejs?-(.+)$', '\1')
            | list) +
            (ansible_facts.packages.keys() | list
            | select('match', '^nodejs?$')
            | list)
          }}
  when: >
    'nodejs' in ansible_facts.packages or
    'npm' in ansible_facts.packages

# Rust packages (cargo)
- name: Discover Rust packages
  block:
    - name: Get cargo installed packages
      ansible.builtin.command: cargo install --list
      register: cargo_packages
      changed_when: false
      failed_when: false

    - name: Extract cargo package names
      ansible.builtin.set_fact:
        cargo_package_names: >-
          {{
            (cargo_packages.stdout_lines | default([])
            | map('regex_replace', '^([^ ]+).*$', '\1')
            | select('match', '^[^:]+$')
            | list)
          }}

    - name: Filter out system-managed Rust packages
      ansible.builtin.set_fact:
        discovered_rust_packages: >-
          {{
            cargo_package_names | reject('in', system_rust_packages) | list | unique | sort
          }}
      vars:
        # Find system packages that match cargo package names
        # Convert rust-package -> package
        system_rust_packages: >-
          {{
            (ansible_facts.packages.keys() | list
            | select('match', '^rust-')
            | map('regex_replace', '^rust-(.+)$', '\1')
            | list) +
            (ansible_facts.packages.keys() | list
            | select('match', '^rust$')
            | list)
          }}
  when: >
    'rust' in ansible_facts.packages or
    'cargo' in ansible_facts.packages or
    'rustc' in ansible_facts.packages

# Go packages
- name: Discover Go packages
  block:
    - name: Find Go binaries in GOPATH/bin
      ansible.builtin.find:
        paths: "{{ ansible_env.HOME }}/go/bin"
        file_type: file
        patterns: "*"
      register: go_binaries
      failed_when: false

    - name: Extract Go package names (binaries)
      ansible.builtin.set_fact:
        go_package_names: >-
          {{
            (go_binaries.files | default([])
            | map(attribute='path')
            | map('basename')
            | list)
          }}

    - name: Filter out system-managed Go packages
      ansible.builtin.set_fact:
        discovered_go_packages: >-
          {{
            go_package_names | reject('in', system_go_packages) | list | unique | sort
          }}
      vars:
        # Find system packages that match go package names
        # Convert golang-package -> package, go-package -> package
        system_go_packages: >-
          {{
            (ansible_facts.packages.keys() | list
            | select('match', '^golang?-')
            | map('regex_replace', '^golang?-(.+)$', '\1')
            | list) +
            (ansible_facts.packages.keys() | list
            | select('match', '^golang?$')
            | list)
          }}
  when: >
    'go' in ansible_facts.packages or
    'golang' in ansible_facts.packages or
    'golang-go' in ansible_facts.packages

# Snap packages
- name: Discover Snap packages
  block:
    - name: Get snap packages
      community.general.snap:
        name: []
        state: absent
      check_mode: true
      register: snap_packages_facts
      failed_when: false

    - name: Get snap packages (fallback if module fails)
      ansible.builtin.command: snap list
      register: snap_packages_cmd
      changed_when: false
      failed_when: false
      when:
        - snap_packages_facts is failed or snap_packages_facts is not defined

    - name: Parse snap packages
      ansible.builtin.set_fact:
        discovered_snap_packages: >-
          {{
            (snap_packages_cmd.stdout_lines[1:] | default([])
            | map('regex_replace', '^([^ ]+).*$', '\1')
            | list | unique | sort)
            if (snap_packages_cmd is defined and snap_packages_cmd.stdout_lines is defined)
            else []
          }}
  when: >
    'snapd' in ansible_facts.packages or
    'snap' in ansible_facts.packages

# Flatpak packages
- name: Discover Flatpak packages
  block:
    - name: Get flatpak packages
      ansible.builtin.command: flatpak list --app --columns=application
      register: flatpak_packages
      changed_when: false
      failed_when: false

    - name: Parse flatpak packages
      ansible.builtin.set_fact:
        discovered_flatpak_packages: >-
          {{
            (flatpak_packages.stdout_lines | default([])
            | map('trim')
            | reject('equalto', '')
            | reject('match', '^Application ID')
            | list | unique | sort)
          }}
      when:
        - flatpak_packages.stdout_lines is defined
  when: "'flatpak' in ansible_facts.packages"

# Ruby gems
- name: Discover Ruby gems
  block:
    - name: Check for gem executable
      ansible.builtin.stat:
        path: "{{ item }}"
      register: gem_executables
      loop:
        - "/usr/bin/gem"
        - "/usr/local/bin/gem"

    - name: Get Ruby gems
      ansible.builtin.command: "{{ gem_executable }} list --local --no-details"
      register: gem_packages
      changed_when: false
      failed_when: false
      vars:
        gem_executable: "{{ gem_executables.results | selectattr('stat.exists', 'equalto', true) | map(attribute='item') | first | default('gem') }}"
      when: gem_executables.results | selectattr('stat.exists', 'equalto', true) | list | length > 0

    - name: Parse Ruby gems
      ansible.builtin.set_fact:
        discovered_ruby_packages: >-
          {{
            (gem_packages.stdout_lines | default([])
            | map('regex_replace', '^([^ ]+).*$', '\1')
            | list | unique | sort)
          }}
      when: gem_packages.stdout_lines is defined
  when: >
    'ruby' in ansible_facts.packages or
    'ruby-full' in ansible_facts.packages or
    'rubygems' in ansible_facts.packages

# Set final discovered language packages
- name: Set discovered language packages variables
  ansible.builtin.set_fact:
    discovered_language_packages:
      python: "{{ discovered_python_packages | default([]) }}"
      nodejs: "{{ discovered_nodejs_packages_global | default([]) }}"
      rust: "{{ discovered_rust_packages | default([]) }}"
      go: "{{ discovered_go_packages | default([]) }}"
      snap: "{{ discovered_snap_packages | default([]) }}"
      flatpak: "{{ discovered_flatpak_packages | default([]) }}"
      ruby: "{{ discovered_ruby_packages | default([]) }}"

- name: Debug discovered language packages
  ansible.builtin.debug:
    msg:
      - "Python (global): {{ discovered_language_packages.python | length }} packages"
      - "Node.js (global): {{ discovered_language_packages.nodejs | length }} packages"
      - "Rust: {{ discovered_language_packages.rust | length }} packages"
      - "Go: {{ discovered_language_packages.go | length }} packages"
      - "Snap: {{ discovered_language_packages.snap | length }} packages"
      - "Flatpak: {{ discovered_language_packages.flatpak | length }} packages"
      - "Ruby: {{ discovered_language_packages.ruby | length }} packages"
  when: discovery_debug | default(false)
