---
# Enhanced Dotfiles Discovery - All Regular Users
# Scans all regular users for dotfiles configurations

- name: Enhanced dotfiles discovery for all users
  block:
    - name: Load dotfiles configuration defaults
      ansible.builtin.include_vars: "{{ role_path }}/../dotfiles/vars/all.yml"

    - name: Scan all regular users for dotfiles
      ansible.builtin.include_tasks: scan-user-dotfiles.yml
      loop: "{{ discovered_users.system_users.regular_users_detailed }}"
      loop_control:
        loop_var: target_user

    - name: Aggregate dotfiles discovery results
      ansible.builtin.set_fact:
        discovered_dotfiles:
          users_with_dotfiles: "{{ user_dotfiles_results | default([]) | selectattr('has_dotfiles') | list }}"
          total_users_scanned: "{{ discovered_users.system_users.regular_users_detailed | length }}"
          dotfiles_methods_found:
            repository: "{{ user_dotfiles_results | default([]) | selectattr('repository_detected') | list }}"
            local_configs: "{{ user_dotfiles_results | default([]) | selectattr('local_configs_detected') | list }}"

          # Primary recommendation (first user with repository dotfiles, or first with configs)
          primary_dotfiles: >-
            {{
              (user_dotfiles_results | default([]) | selectattr('repository_detected') | first) | default(
                user_dotfiles_results | default([]) | selectattr('local_configs_detected') | first, {}
              )
            }}

  tags:
    - discovery
    - dotfiles
    - user-environment
