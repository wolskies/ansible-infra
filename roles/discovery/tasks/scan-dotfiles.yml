---
# Enhanced Dotfiles Discovery - All Regular Users
# Scans all regular users for dotfiles configurations

- name: Enhanced dotfiles discovery for all users
  block:
    - name: Load dotfiles configuration defaults
      ansible.builtin.include_vars: "{{ role_path }}/../dotfiles/vars/all.yml"

    - name: Scan each regular user for dotfiles
      ansible.builtin.include_tasks: scan-user-dotfiles.yml
      loop: "{{ discovered_users.system_users.regular_users_detailed }}"
      loop_control:
        loop_var: target_user

    - name: Aggregate dotfiles discovery results
      ansible.builtin.set_fact:
        discovered_dotfiles:
          users_with_dotfiles: "{{ user_dotfiles_results | default([]) }}"
          total_users_scanned: "{{ discovered_users.system_users.regular_users_detailed | default([]) | length }}"
          repository_users: "{{ user_dotfiles_results | default([]) | selectattr('dotfiles_repo', 'equalto', true) | list }}"
          local_files_users: "{{ user_dotfiles_results | default([]) | selectattr('dotfiles_repo', 'equalto', false) | list }}"

  tags:
    - discovery
    - dotfiles
    - user-environment
