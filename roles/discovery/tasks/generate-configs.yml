---
# Configuration File Generation
# Generates host_vars in user's inventory structure

# NOTE: vars.yml is now built progressively in main.yml
# This file only generates the secrets template

- name: Generate secrets template file
  ansible.builtin.template:
    src: "host_secrets.yml.j2"
    dest: "{{ discovery_paths.host_vars_dir }}/secrets.yml"
    mode: '0600'  # Restricted permissions for secrets file
  delegate_to: localhost
  tags:
    - generation
    - secrets


- name: Create docker-compose directory
  ansible.builtin.file:
    path: "{{ discovery_paths.host_vars_dir }}/docker_compose"
    state: directory
    mode: '0755'
  when:
    - discovery_host_vars.docker is defined
    - discovery_host_vars.docker.install_docker_services is defined
  delegate_to: localhost
  tags:
    - generation
    - docker

- name: Copy docker-compose files if detected
  ansible.builtin.copy:
    src: "{{ item.compose_file }}"
    dest: "{{ discovery_paths.host_vars_dir }}/docker_compose/{{ item.name }}.yml"
    mode: '0644'
  loop: "{{ discovery_host_vars.docker.install_docker_services | default([]) }}"
  when:
    - discovery_host_vars.docker is defined
    - discovery_host_vars.docker.install_docker_services is defined
    - item.compose_file is defined
  delegate_to: localhost
  tags:
    - generation
    - docker

- name: Display generation summary
  ansible.builtin.debug:
    msg:
      - "=== Configuration Files Generated ==="
      - "Host variables: {{ discovery_paths.host_vars_file }}"
      - "Secrets template: {{ discovery_paths.host_vars_dir }}/secrets.yml"
      - "Host directory: {{ discovery_paths.host_vars_dir }}"
      - ""
      - "IMPORTANT: Next steps for secrets management:"
      - "1. Edit {{ discovery_paths.host_vars_dir }}/secrets.yml with your passwords and keys"
      - "2. Encrypt it: ansible-vault encrypt {{ discovery_paths.host_vars_dir }}/secrets.yml"
      - "3. Use --ask-vault-pass when running playbooks"
      - ""
      - "Ready to use with wolskinet.infrastructure collection:"
      - "1. Review {{ discovery_paths.host_vars_file }}"
      - "2. Run: ansible-playbook playbooks/your-playbook.yml -l {{ inventory_hostname }} --ask-vault-pass"
      - "3. The basic_setup role will use the discovered packages automatically"
  tags:
    - generation
    - summary
