---

- name: Check for GUI indicators
  block:
    - name: Check for display variables
      ansible.builtin.shell: |
        echo "DISPLAY=${DISPLAY:-}"
        echo "WAYLAND_DISPLAY=${WAYLAND_DISPLAY:-}"
      register: display_vars
      failed_when: false
      changed_when: false
      become: false

    - name: Check for desktop environment indicators
      ansible.builtin.stat:
        path: "{{ item }}"
      register: gui_indicators
      loop:
        - /usr/share/xsessions
        - /usr/share/wayland-sessions
        - /usr/bin/startx
        - /usr/bin/X
        - /usr/bin/Xorg

    - name: Check for display manager services
      ansible.builtin.set_fact:
        display_managers_found: >-
          {{ ansible_facts.services.keys() |
             select('match', '(gdm|lightdm|sddm|xdm|kdm)') |
             list | length > 0 }}

- name: Determine if GUI is present
  ansible.builtin.set_fact:
    discovered_desktop:
      detected: >-
        {{
          ((display_vars.stdout | default('')) | regex_search('DISPLAY=:')) or
          ((display_vars.stdout | default('')) | regex_search('WAYLAND_DISPLAY=')) or
          ((gui_indicators.results | default([])) | selectattr('stat.exists') | list | length > 0) or
          display_managers_found
        }}
  tags:
    - desktop
    - gui
