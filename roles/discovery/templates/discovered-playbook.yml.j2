# Replication playbook for {{ inventory_hostname }}
# Generated from infrastructure discovery on {{ ansible_date_time.iso8601 }}
# 
# Replicates discovered configuration using basic_setup role and discovered variables.
# Source OS: {{ discovery_profile.system.distribution }} {{ discovery_profile.system.distribution_version }}

---
- name: Replicate discovered configuration for {{ inventory_hostname }}
  hosts: {{ inventory_hostname }}
  gather_facts: true
  become: true
  
  collections:
    - wolskinet.infrastructure
    - community.general{% if discovery_profile.docker.installed %}
    - community.docker{% endif %}

  pre_tasks:
    - name: Display replication information
      ansible.builtin.debug:
        msg:
          - "=== Configuration Replication ==="
          - "Target host: {{ inventory_hostname }}"
          - "Source OS: {{ discovery_profile.system.distribution }} {{ discovery_profile.system.distribution_version }}"
          - "Target OS: {{ ansible_distribution }} {{ ansible_distribution_version | default('unknown') }}"
          - "Discovery date: {{ ansible_date_time.iso8601 }}"
          - ""
          - "Package installation approach:"
          - "  ‚Ä¢ Looking for: packages_install_{{ ansible_distribution }}"
          - "  ‚Ä¢ Discovered: packages_install_{{ discovery_profile.system.distribution }} ({{ discovery_profile.packages.installed | length }} packages)"
          - "  ‚Ä¢ Cross-OS: Add equivalent packages manually if needed"

  roles:
    # Core system setup with discovered packages and configuration
    - name: wolskinet.infrastructure.basic_setup{% if discovery_profile.packages.pip_packages %}
    
    # Third-party packages (repositories, npm, pip, system packages)
    - name: wolskinet.infrastructure.third_party_packages
      vars:
        pip_install_method: "user"
      when: >
        (pip_packages is defined and pip_packages | length > 0) or
        (npm_packages is defined and npm_packages | length > 0) or
        (third_party_packages is defined and third_party_packages | length > 0) or
        (additional_repositories is defined){% endif %}{% if discovery_profile.docker.installed %}
    
    # Container platform setup (Docker detected on source)
    - name: wolskinet.infrastructure.container_platform
      when: docker_detected | default(false){% endif %}{% if discovery_profile.dotfiles.detected %}
    
    # Dotfiles management (repository detected on source)  
    - name: wolskinet.infrastructure.dotfiles
      become: false
      when: dotfiles_detected | default(false){% endif %}
    
    # System maintenance and updates
    - name: wolskinet.infrastructure.maintenance

  post_tasks:
    - name: Display replication results
      ansible.builtin.debug:
        msg:
          - "‚úÖ Configuration replication completed for {{ inventory_hostname }}"
          - ""
          - "üì¶ Package installation:"
          - "   ‚Ä¢ OS packages: {{ vars['host_packages_install_' + ansible_distribution] | default([]) | length }} for {{ ansible_distribution }}"
          - "   ‚Ä¢ AUR packages: {{ aur_packages | default([]) | length }} (Arch only, via basic_setup)"
          - "   ‚Ä¢ Homebrew packages: {{ homebrew_packages | default([]) | length }} (macOS only, via basic_setup)"
          - "   ‚Ä¢ Python packages: {{ pip_packages | default([]) | length }} (via third_party_packages role)"
          - "   ‚Ä¢ Node.js packages: {{ npm_packages | default([]) | length }} (via third_party_packages role)"
          - "   ‚Ä¢ Third-party packages: {{ third_party_packages | default([]) | length }} (via third_party_packages role)"{% if discovery_profile.docker.installed %}
          - ""
          - "üê≥ Docker: Configuration applied"
          - "   ‚Ä¢ Note: Containers/volumes not automatically recreated"{% endif %}{% if discovery_profile.dotfiles.detected %}
          - ""
          - "‚öôÔ∏è  Dotfiles: Repository configured"{% endif %}
          - ""
          - "üîç Manual verification recommended:"
          - "   1. Compare package lists with original system"
          - "   2. Verify services are running as expected" 
          - "   3. Test application functionality"{% if discovery_profile.docker.installed %}
          - "   4. Recreate Docker containers/volumes as needed"{% endif %}{% if discovery_profile.dotfiles.detected %}
          - "   5. Verify dotfiles are properly deployed"{% endif %}
          - ""
          - "Machine characteristics: {{ discovered_machine_characteristics | default([]) | join(', ') or 'none detected' }}"
          - "Replication should closely match original {{ inventory_hostname }} configuration"