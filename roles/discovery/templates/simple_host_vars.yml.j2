---
# Generated by wolskinet.infrastructure.discovery role
# Host variables for {{ inventory_hostname }}
# Using flat variable structure matching configure_system role

# =============================================================================
# DOMAIN-LEVEL CONFIGURATION
# =============================================================================

{% if discovery_domain_name -%}
domain_name: {{ discovery_domain_name | to_json }}
{% endif -%}
{% if discovery_domain_timezone -%}
domain_timezone: {{ discovery_domain_timezone | to_json }}
{% endif -%}
{% if discovery_domain_locale -%}
domain_locale: {{ discovery_domain_locale | to_json }}
{% endif -%}
{% if discovery_domain_language -%}
domain_language: {{ discovery_domain_language | to_json }}
{% endif -%}
{% if discovery_domain_ntp_enabled is not none %}
domain_ntp:
  enabled: {{ discovery_domain_ntp_enabled | lower }}
  servers:
    - "0.pool.ntp.org"
    - "1.pool.ntp.org"
{% endif %}

{% if users is defined and users is sequence and users | length > 0 %}
users:
{{ users | to_nice_yaml(indent=2) | indent(2, first=true) }}
{% else %}
users: []
{% endif %}

# =============================================================================
# HOST-LEVEL CONFIGURATION
# =============================================================================

{% if discovery_hostname %}host_hostname: {{ discovery_hostname | to_json }}

{% endif %}

{% if discovery_services_enabled | length > 0 or discovery_services_disabled | length > 0 %}
host_services:
  enable: {{ discovery_services_enabled | to_json }}
  disable: {{ discovery_services_disabled | to_json }}
{% endif %}

{% if discovery_sysctl_current | length > 0 %}
host_sysctl:
  parameters:
{% for key, value in discovery_sysctl_current.items() %}
    {{ key }}: {{ value | to_json }}
{% endfor %}
{% endif %}


{% if discovery_udev_rules | length > 0 %}
host_udev:
  rules:
{% for rule in discovery_udev_rules %}
    - name: {{ rule.name | to_json }}
      content: {{ rule.content | to_json }}
      priority: {{ rule.priority }}
      state: present
{% endfor %}
{% endif %}

# =============================================================================
# SYSTEM SERVICES CONFIGURATION
# =============================================================================

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

{% if discovery_firewall_enabled or discovery_firewall_package %}
firewall:
  enabled: {{ discovery_firewall_enabled | lower }}
{% if discovery_firewall_package %}
  package: {{ discovery_firewall_package | to_json }}
{% endif %}
{% if discovery_firewall_rules | length > 0 %}
  rules:
{{ discovery_firewall_rules | to_nice_yaml(indent=4) }}
{% endif %}
{% endif %}

{% if discovery_fail2ban_detected %}
fail2ban:
  enabled: {{ discovery_fail2ban_enabled | lower }}
{% endif %}

# =============================================================================
# PACKAGE MANAGEMENT
# =============================================================================

{% if discovery_packages_host | length > 0 or (ansible_system == "Darwin" and discovery_homebrew_casks | length > 0) %}
packages:
{% if discovery_packages_host | length > 0 %}
  present:
    host:
      {{ ansible_distribution }}:
        {{ discovery_packages_host | to_nice_yaml(indent=8) | indent(8, first=false) }}
{%- endif %}
{%- if ansible_system == "Darwin" and discovery_homebrew_casks | length > 0 %}
  casks_present:
    host: {{ discovery_homebrew_casks | to_json }}
{%- endif %}
{% endif %}

{% if ansible_os_family == "Debian" and discovery_repositories | length > 0 %}
apt:
  repositories:
    host:
      {{ ansible_distribution }}:
{{ discovery_repositories | to_nice_yaml(indent=8) }}
{% elif ansible_system == "Darwin" and discovery_homebrew_taps | length > 0 %}
homebrew:
  taps:
{{ discovery_homebrew_taps | to_nice_yaml(indent=4) }}
{% endif %}

{% if discovery_snap_packages | length > 0 %}
snap:
  packages:
    install:
      {{ discovery_snap_packages | to_nice_yaml(indent=6) | indent(6, first=false) }}
{% endif %}

{% if discovery_flatpak_packages | length > 0 %}
flatpak:
  enabled: true
  packages:
    install:
      {{ discovery_flatpak_packages | to_nice_yaml(indent=6) | indent(6, first=false) }}
{% endif %}

{% if ansible_system == "Darwin" and discovery_macos_preferences | length > 0 -%}

# =============================================================================
# macOS-SPECIFIC SETTINGS (DISCOVERED)
# =============================================================================

macosx:
{% if discovery_macos_preferences.gatekeeper_enabled is defined -%}
  gatekeeper:
    enabled: {{ discovery_macos_preferences.gatekeeper_enabled }}
{% endif -%}
{% if discovery_macos_preferences.natural_scroll is defined or discovery_macos_preferences.measurement_units is defined or discovery_macos_preferences.use_metric is defined or discovery_macos_preferences.show_all_extensions is defined -%}
  system_preferences:
{% if discovery_macos_preferences.natural_scroll is defined -%}
    natural_scroll: {{ discovery_macos_preferences.natural_scroll }}
{% endif -%}
{% if discovery_macos_preferences.measurement_units is defined -%}
    measurement_units: {{ discovery_macos_preferences.measurement_units | to_json }}
{% endif -%}
{% if discovery_macos_preferences.use_metric is defined -%}
    use_metric: {{ discovery_macos_preferences.use_metric }}
{% endif -%}
{% if discovery_macos_preferences.show_all_extensions is defined -%}
    show_all_extensions: {{ discovery_macos_preferences.show_all_extensions }}
{% endif -%}
{% endif -%}
{% if discovery_macos_preferences.airdrop_ethernet is defined -%}
  airdrop:
    ethernet_enabled: {{ discovery_macos_preferences.airdrop_ethernet }}
{% endif -%}
{% endif %}
