---
# Simplified user management - trust Ansible built-ins

- name: Add users to system
  become: true
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.uid | default(omit) }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    state: present
    create_home: true
    groups: "{{ item.groups | default([]) }}"
    append: true
  loop: "{{ users_config | default([]) }}"
  when: users_config | default([]) | length > 0

- name: Remove users from system
  become: true
  ansible.builtin.user:
    name: "{{ item }}"
    state: absent
    remove: true
  loop: "{{ users_remove | default([]) }}"
  when: users_remove | default([]) | length > 0

- name: Deploy dotfiles for configured users
  ansible.builtin.include_role:
    name: wolskinet.infrastructure.dotfiles
  vars:
    dotfiles_user: "{{ item.name }}"
    dotfiles_repository_url: "{{ item.dotfiles_repo_url }}"
  loop: "{{ users_config | default([]) | selectattr('dotfiles_repo', 'equalto', true) | list }}"
  when: users_config | default([]) | selectattr('dotfiles_repo', 'equalto', true) | list | length > 0

