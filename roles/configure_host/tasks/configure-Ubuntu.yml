---
# Ubuntu-specific host configuration tasks
# Platform-unique features only - common tasks handled in main.yml

# Ubuntu snap removal (optional but thorough)
- name: Remove snap packages completely (Ubuntu)
  block:
    - name: Check if snap is installed
      ansible.builtin.stat:
        path: /usr/bin/snap
      register: snap_binary

    - name: List installed snap packages
      ansible.builtin.command: snap list
      register: snap_packages
      failed_when: false
      changed_when: false
      when: snap_binary.stat.exists

    - name: Display snap packages that would be removed
      ansible.builtin.debug:
        msg: "Would remove snap package: {{ item.split()[0] }}"
      loop: "{{ snap_packages.stdout_lines[1:] if snap_packages.rc == 0 else [] }}"
      when:
        - snap_packages.rc == 0
        - snap_packages.stdout_lines | length > 1
        - item.split()[0] not in ['core', 'core18', 'core20', 'core22', 'snapd']

    - name: Remove all installed snap packages (with safety checks)
      ansible.builtin.command: snap remove "{{ item.split()[0] }}"
      loop: "{{ snap_packages.stdout_lines[1:] if snap_packages.rc == 0 else [] }}"
      when:
        - snap_binary.stat.exists
        - snap_packages.rc == 0
        - snap_packages.stdout_lines | length > 1
        - item.split()[0] not in ['core', 'core18', 'core20', 'core22', 'snapd']
        - item.split()[0] not in ['lxd', 'multipass']  # Don't remove critical infrastructure snaps
      become: true
      register: snap_removal
      failed_when:
        - snap_removal.rc != 0
        - "'cannot remove' not in snap_removal.stderr | default('')"

    - name: Remove core snap packages (last)
      ansible.builtin.command: snap remove "{{ item }}"
      loop:
        - core22
        - core20
        - core18
        - core
        - snapd
      become: true
      when: snap_binary.stat.exists
      register: core_snap_removal
      failed_when:
        - core_snap_removal.rc != 0
        - "'cannot remove' not in core_snap_removal.stderr | default('')"
        - "'is not installed' not in core_snap_removal.stderr | default('')"

    - name: Check if snapd services exist before stopping
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: snapd_service_status
      loop:
        - snapd.service
        - snapd.socket
        - snapd.seeded.service
      failed_when: false
      changed_when: false

    - name: Stop and disable snapd services
      ansible.builtin.systemd:
        name: "{{ item.item }}"
        state: stopped
        enabled: false
        daemon_reload: true
      loop: "{{ snapd_service_status.results }}"
      when:
        - item.status is defined
        - item.status.LoadState == "loaded"
      become: true

    - name: Remove snapd package
      ansible.builtin.apt:
        name:
          - snapd
          - gnome-software-plugin-snap
        state: absent
        purge: true
      become: true

    - name: Check if snap directories exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: snap_dirs
      loop:
        - /snap
        - /var/snap
        - /var/lib/snapd
        - /var/cache/snapd
        - /usr/lib/snapd
        - /home/{{ ansible_user }}/snap

    - name: Remove snap directories (only if empty or contain only snap data)
      ansible.builtin.file:
        path: "{{ item.item }}"
        state: absent
      loop: "{{ snap_dirs.results }}"
      when:
        - item.stat.exists
        - item.stat.isdir
      become: true
      failed_when: false  # Don't fail if directory is in use

    - name: Remove snap from PATH (system-wide)
      ansible.builtin.lineinfile:
        path: /etc/environment
        regexp: '.*snap.*'
        state: absent
      become: true

    - name: Mark snapd package as hold to prevent reinstallation
      ansible.builtin.dpkg_selections:
        name: snapd
        selection: hold
      become: true
      failed_when: false  # Package might not exist after removal

  when: config_ubuntu_disable_snap | default(false)
  tags:
    - ubuntu
    - snap
    - removal
    - system-cleanup

# APT repository management convenience features (optional)
- name: Configure APT unattended upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  become: true
  when:
    - config_ubuntu_unattended_upgrades | default(true)
  tags:
    - ubuntu
    - updates
    - configure-host
