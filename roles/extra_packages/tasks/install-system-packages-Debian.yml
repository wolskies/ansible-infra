---
# Install system packages on Debian-based systems (Ubuntu/Debian)
# Handles APT package installation with proper error handling

- name: Install system packages on Debian-based systems
  block:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      become: true
      when: update_package_cache | default(true)
      tags:
        - packages
        - cache-update

    - name: Install system packages via APT
      ansible.builtin.apt:
        name: "{{ final_system_packages }}"
        state: present
        install_recommends: false
      become: true
      when: 
        - final_system_packages is defined
        - final_system_packages | length > 0
      register: apt_install_result
      tags:
        - packages
        - system-packages
        - apt

    - name: Display system package installation results
      ansible.builtin.debug:
        msg:
          - "System packages installation completed"
          - "Packages requested: {{ final_system_packages | length }}"
          - "Installation successful: {{ apt_install_result.changed | default(false) }}"
      tags:
        - packages
        - system-packages
        - summary

  rescue:
    - name: Handle system package installation errors
      ansible.builtin.debug:
        msg: "Some system packages failed to install. Continuing with other package categories."
      when: skip_failed_packages | default(true)
      tags:
        - packages
        - error-handling

    - name: Fail on package installation errors (if not skipping)
      ansible.builtin.fail:
        msg: "System package installation failed and skip_failed_packages is disabled"
      when: not (skip_failed_packages | default(true))
      tags:
        - packages
        - error-handling

  tags:
    - extra-packages
    - system-packages
    - debian