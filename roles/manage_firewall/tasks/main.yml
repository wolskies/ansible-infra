---
# manage_firewall main tasks
# Pure firewall rule management - assumes firewall service is already installed and enabled

- name: Validate firewall rule configuration
  ansible.builtin.fail:
    msg: "Invalid rule in firewall_custom_rules: {{ item }} - must have either 'port' or 'name'"
  loop: "{{ firewall_custom_rules }}"
  when:
    - firewall_custom_rules is defined
    - item.port is not defined and item.name is not defined
  tags:
    - always
    - validation
    - firewall

- name: Determine firewall tool
  ansible.builtin.set_fact:
    selected_firewall_tool: >-
      {%- if firewall_type != 'auto' -%}
        {{ firewall_type }}
      {%- elif ansible_distribution in firewall_tool_preference -%}
        {{ firewall_tool_preference[ansible_distribution] }}
      {%- elif ansible_distribution in ['Ubuntu', 'Debian'] -%}
        ufw
      {%- elif ansible_os_family == 'RedHat' -%}
        firewalld
      {%- else -%}
        iptables
      {%- endif %}
  tags:
    - always
    - firewall

- name: Configure firewall rules
  ansible.builtin.include_tasks: "firewall-{{ ansible_distribution }}.yml"
  when:
    - firewall_manage_rules | default(true)
    - ansible_distribution in ['Ubuntu', 'Debian', 'Archlinux', 'MacOSX']
  tags:
    - firewall
    - firewall-rules
