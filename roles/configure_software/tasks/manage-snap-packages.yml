---
# Thin wrapper around community.general.snap for occasional snap package management

- name: Ensure snapd is installed and running
  block:
    - name: Install snapd package
      ansible.builtin.apt:
        name: snapd
        state: present
        update_cache: true
      become: true

    - name: Start and enable snapd services
      ansible.builtin.systemd:
        name: "{{ snapd_service }}"
        state: started
        enabled: true
        daemon_reload: true
      become: true
      loop:
        - snapd.service
        - snapd.socket
      loop_control:
        loop_var: snapd_service

    - name: Wait for snapd to be ready
      ansible.builtin.command: snap wait system seed.loaded
      become: true
      changed_when: false
      failed_when: false

  when: snap_packages | default([]) | length > 0
  tags:
    - snap-packages

- name: Manage snap packages
  community.general.snap:
    name: "{{ snap_package.name }}"
    state: "{{ snap_package.state | default('present') }}"
    classic: "{{ snap_package.classic | default(false) }}"
    channel: "{{ snap_package.channel | default(omit) }}"
  loop: "{{ snap_packages | default([]) }}"
  loop_control:
    loop_var: snap_package
  become: true
  when: snap_packages | default([]) | length > 0
  tags:
    - snap-packages
