services:
  gitlab:
    image: gitlab/gitlab-ee
    container_name: gitlab
    restart: always
    hostname: {{ gitlab_hostname }}.{{ gitlab_domain }}
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Add any other gitlab.rb configuration here, each on its own line
        external_url 'http://{{ gitlab_hostname }}.{{ gitlab_domain }}'
        gitlab_rails['smtp_enable'] = {{ gitlab_smtp_enable }}
        gitlab_rails['smtp_address'] = {{ gitlab_smtp_address }}
        gitlab_rails['smtp_port'] = {{ gitlab_smtp_port }}
        gitlab_rails['smtp_user_name'] = {{ gitlab_smtp_username }}
        gitlab_rails['smtp_password'] = {{ gitlab_smtp_password }}
        gitlab_rails['smtp_domain'] = {{ gitlab_smtp_domain }}
        gitlab_rails['smtp_authentication'] = "login"
        gitlab_rails['smtp_enable_starttls_auto'] = {{ gitlab_smtp_enable_starttls }}
        gitlab_rails['smtp_tls'] = false
        gitlab_rails['smtp_pool'] = false
        gitlab_rails['smtp_openssl_verify_mode'] = 'peer'
        gitlab_rails['gitlab_shell_ssh_port'] = {{ gitlab_shell_ssh_port }}
        gitlab_rails['registry_enabled'] = {{ gitlab_registry_enabled }}
        gitlab_rails['registry_host'] = {{ gitlab_registry_host }}
        gitlab_rails['registry_port'] = {{ gitlab_registry_port }}
        gitlab_rails['registry_path'] = {{ gitlab_registry_path }}
        nginx['listen_port'] = {{ gitlab_nginx_listen_port }}
        nginx['listen_https'] = {{ gitlab_nginx_listen_https }}
        registry_external_url {{ gitlab_registry_url }}
        registry_nginx['listen_port'] = {{ gitlab_registry_port }}
        registry_nginx['listen_https'] = {{ gitlab_listen_https }}
        registry_nginx['enable'] = {{ gitlab_registry_enabled }}
        letsencrypt['enable'] = false
        gitlab_rails['gitlab_default_theme'] = 2
        gitlab_rails['gitlab_default_color_mode'] = 2
        gitlab_rails['initial_root_password'] = {{ gitlab_initial_root_password }}
        gitlab_rails['pages_local_store_enabled'] = {{ gitlab_pages_local_store_enabled }}
        gitlab_rails['pages_local_store_path'] = {{ gitlab_pages_local_store_path }}
        gitlab_rails['manage_backup_path'] = true
        gitlab_rails['backup_path'] = {{ gitlab_backup_path }}
        gitlab_rails['backup_keep_time'] = 604800
        pages_external_url {{ gitlab_pages_external_url }}
        gitlab_pages['enable'] = {{ gitlab_pages_enable }}
        gitlab_pages['listen_proxy'] = {{ gitlab_pages_listen_proxy }}


    ports:
      - {{ gitlab_web_listen_port }}:80
      - {{ gitlab_websecure_listen_port }}:443
      - {{ gitlab_shell_ssh_port }}:22
      - {{ gitlab_registry_port }}:5050
      - {{ gitlab_pages_listen_port }}:8090
    volumes:
      - {{ gitlab_volume_config }}:/etc/gitlab
      - {{ gitlab_volume_logs }}:/var/log/gitlab
      - {{ gitlab_volume_data }}:/var/opt/gitlab
      - {{ gitlab_volume_secret }}:/secret/gitlab/backups
    shm_size: '256m'
