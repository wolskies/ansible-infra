---
# macOS OS-specific user configuration

- name: Set user shell for {{ current_user_config.name }}
  ansible.builtin.user:
    name: "{{ current_user_config.name }}"
    shell: "{{ current_user_config.Darwin.shell }}"
  become: true
  when:
    - current_user_config.Darwin is defined
    - current_user_config.Darwin.shell is defined
    - current_user_config.Darwin.shell | length > 0
  tags:
    - shell

- name: Configure macOS Dock preferences for {{ current_user_config.name }}
  community.general.osx_defaults:
    domain: com.apple.dock
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  notify: restart dock
  become: true
  become_user: "{{ current_user_config.name }}"
  loop:
    - key: "tilesize"
      type: "int"
      value: "{{ current_user_config.Darwin.dock.tile_size }}"
    - key: "autohide"
      type: "bool"
      value: "{{ current_user_config.Darwin.dock.autohide }}"
    - key: "minimize-to-application"
      type: "bool"
      value: "{{ current_user_config.Darwin.dock.minimize_to_application | default(false) }}"
  when:
    - current_user_config.Darwin is defined
    - current_user_config.Darwin.dock is defined
    - item.value is defined
  tags:
    - dock
    - macos

- name: Configure macOS Finder preferences for {{ current_user_config.name }}
  community.general.osx_defaults:
    domain: com.apple.finder
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  notify: restart finder
  become: true
  become_user: "{{ current_user_config.name }}"
  loop:
    - key: "AppleShowAllExtensions"
      type: "bool"
      value: "{{ current_user_config.Darwin.finder.show_extensions }}"
    - key: "AppleShowAllFiles"
      type: "bool"
      value: "{{ current_user_config.Darwin.finder.show_hidden }}"
    - key: "ShowPathbar"
      type: "bool"
      value: "{{ current_user_config.Darwin.finder.show_pathbar | default(true) }}"
  when:
    - current_user_config.Darwin is defined
    - current_user_config.Darwin.finder is defined
    - item.value is defined
  tags:
    - finder
    - macos
