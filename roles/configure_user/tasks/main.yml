---
# Configure user preferences for a single user
# Expects target_user variable to be passed in

- name: Ensure ACL package is installed for privilege escalation
  ansible.builtin.package:
    name: "{{ 'acl' if ansible_os_family != 'Darwin' else omit }}"
    state: present
  become: true
  when:
    - ansible_os_family != 'Darwin'
    - target_user is defined

- name: Debug target_user variable
  ansible.builtin.debug:
    var: target_user
    verbosity: 1

- name: Install Node.js and packages for {{ target_user.name | default('UNKNOWN') }}
  ansible.builtin.include_role:
    name: wolskinet.infrastructure.nodejs
  vars:
    node_user: "{{ target_user.name }}"
    node_packages: "{{ target_user.nodejs.packages }}"
  when:
    - target_user is defined
    - target_user.name is defined
    - target_user.name != 'root'
    - target_user.nodejs.packages | default([]) | length > 0
  tags:
    - user-config
    - language-packages
    - nodejs

- name: Install Rust and packages for {{ target_user.name | default('UNKNOWN') }}
  ansible.builtin.include_role:
    name: wolskinet.infrastructure.rust
  vars:
    rust_user: "{{ target_user.name }}"
    rust_packages: "{{ target_user.rust.packages }}"
  when:
    - target_user is defined
    - target_user.name is defined
    - target_user.name != 'root'
    - target_user.rust.packages | default([]) | length > 0
  tags:
    - user-config
    - language-packages
    - rust

- name: Install Go and packages for {{ target_user.name | default('UNKNOWN') }}
  ansible.builtin.include_role:
    name: wolskinet.infrastructure.go
  vars:
    go_user: "{{ target_user.name }}"
    go_packages: "{{ target_user.go.packages }}"
  when:
    - target_user is defined
    - target_user.name is defined
    - target_user.name != 'root'
    - target_user.go.packages | default([]) | length > 0
  tags:
    - user-config
    - language-packages
    - go

- name: Configure user preferences for {{ target_user.name | default('UNKNOWN') }}
  block:
    - name: Configure cross-platform user preferences for {{ target_user.name | default('UNKNOWN') }}
      ansible.builtin.include_tasks: configure-cross-platform.yml
      tags:
        - user-config
        - cross-platform

    - name: Configure OS-specific user preferences for {{ target_user.name | default('UNKNOWN') }}
      ansible.builtin.include_tasks: configure-{{ ansible_system }}.yml
      when: >
        target_user.shell is defined or
        target_user[ansible_system] is defined
      tags:
        - user-config
        - os-specific

    - name: Configure dotfiles for {{ target_user.name | default('UNKNOWN') }}
      ansible.builtin.include_tasks: configure-dotfiles.yml
      when: target_user.dotfiles is defined and target_user.dotfiles.enable | default(true)
      tags:
        - user-config
        - dotfiles
  become: true
  become_user: "{{ target_user.name }}"
  when:
    - target_user is defined
    - target_user.name is defined
    - target_user.name != 'root' # Skip system accounts
