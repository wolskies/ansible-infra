---
# Configure preferences for a single user with proper privilege escalation
- name: Configure user preferences for {{ target_user.name }}
  block:
    - name: Configure cross-platform user preferences for {{ target_user.name }}
      ansible.builtin.include_tasks: configure-cross-platform.yml
      tags:
        - user-config
        - cross-platform

    - name: Configure OS-specific user preferences for {{ target_user.name }}
      ansible.builtin.include_tasks: configure-{{ ansible_system }}.yml
      when: >
        target_user.shell is defined or
        target_user[ansible_system] is defined
      tags:
        - user-config
        - os-specific

    - name: Configure dotfiles for {{ target_user.name }}
      ansible.builtin.include_tasks: configure-dotfiles.yml
      when: target_user.dotfiles is defined and target_user.dotfiles.enable | default(true)
      tags:
        - user-config
        - dotfiles
  become: true
  become_user: "{{ target_user.name }}"
