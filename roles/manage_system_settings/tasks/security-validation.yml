---
# Security validation tasks for system settings
# Validates parameters and prevents dangerous configurations

- name: Check if security validation is bypassed
  ansible.builtin.debug:
    msg:
      - "⚠️  SECURITY VALIDATION BYPASSED ⚠️"
      - "Active bypasses: {{ security_bypass }}"
      - "This configuration is UNSAFE for production!"
  when: security_bypass.all_validation | default(false)
  tags:
    - security
    - validation
    - warning

- name: Security validation for system settings role
  ansible.builtin.debug:
    msg: "Starting security validation for system settings modifications"
  when: not (security_bypass.all_validation | default(false))
  tags:
    - security
    - validation

- name: Run security validations
  ansible.builtin.include_tasks: validate_setting.yml
  vars:
    validation_rule: "{{ item }}"
  loop:
    - type: sysctl_forbidden
      check_items: "{{ system_settings_custom_sysctl | dict2items | selectattr('key', 'in', system_settings_forbidden_sysctl_parameters) }}"
      bypass: dangerous_sysctl
      condition: "{{ system_settings_security_hardening.enable_strict_sysctl_validation | default(true) }}"
      error: "SECURITY: Forbidden sysctl parameter"

    - type: sysctl_whitelist
      check_items: "{{ system_settings_custom_sysctl | dict2items | rejectattr('key', 'in', system_settings_allowed_sysctl_parameters) }}"
      bypass: sysctl_whitelist
      condition: "{{ system_settings_security_hardening.enable_strict_sysctl_validation | default(true) }}"
      error: "SECURITY: sysctl parameter not in whitelist"

    - type: port_binding
      check_items: "{{ system_settings_custom_sysctl | dict2items | selectattr('key', 'equalto', 'net.ipv4.ip_unprivileged_port_start') | selectattr('value', 'lt', '1024') }}"
      bypass: port_binding
      error: "CRITICAL: Unprivileged port binding < 1024"

    - type: critical_services
      check_items: "{{ system_settings_services_disable | intersect(system_settings_critical_services) }}"
      bypass: critical_services
      condition: "{{ system_settings_security_hardening.enable_service_validation | default(true) }}"
      error: "SECURITY: Cannot disable critical service"

- name: Security summary
  ansible.builtin.debug:
    msg:
      - "Security validation: {{ 'BYPASSED' if security_bypass.all_validation else 'ACTIVE' }}"
      - "Active bypasses: {{ security_bypass | dict2items | selectattr('value') | map(attribute='key') | list | join(', ') or 'None' }}"
  when: not security_bypass.warnings
  tags:
    - security
    - summary
