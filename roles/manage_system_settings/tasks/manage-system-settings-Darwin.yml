---
# macOS system settings tasks

- name: Configure macOS Dock settings
  community.general.osx_defaults:
    domain: com.apple.dock
    key: "{{ item.key }}"
    type: "{{ item.value.type | default('int') }}"
    value: "{{ item.value.value }}"
    state: present
  loop: "{{ system_settings_macos.dock.settings | default({}) | dict2items }}"
  when:
    - system_settings_macos.dock.enabled | default(false) | bool
    - system_settings_macos.dock.settings is defined
    - system_settings_macos.dock.settings | length > 0
  notify: Restart Dock
  tags:
    - macos
    - dock
    - gui

- name: Configure macOS Finder settings
  community.general.osx_defaults:
    domain: com.apple.finder
    key: "{{ item.key }}"
    type: "{{ item.value.type | default('bool') }}"
    value: "{{ item.value.value }}"
    state: present
  loop: "{{ system_settings_macos.finder.settings | default({}) | dict2items }}"
  when:
    - system_settings_macos.finder.enabled | default(false) | bool
    - system_settings_macos.finder.settings is defined
    - system_settings_macos.finder.settings | length > 0
  notify: Restart Finder
  tags:
    - macos
    - finder
    - gui

- name: Configure macOS system-wide settings
  community.general.osx_defaults:
    domain: "{{ item.value.domain | default('NSGlobalDomain') }}"
    key: "{{ item.key }}"
    type: "{{ item.value.type | default('int') }}"
    value: "{{ item.value.value }}"
    state: present
  loop: "{{ system_settings_macos.system.settings | default({}) | dict2items }}"
  when:
    - system_settings_macos.system.enabled | default(false) | bool
    - system_settings_macos.system.settings is defined
    - system_settings_macos.system.settings | length > 0
  tags:
    - macos
    - system
    - performance

- name: Configure macOS security settings
  block:
    - name: Set password requirements after sleep
      community.general.osx_defaults:
        domain: com.apple.screensaver
        key: askForPassword
        type: int
        value: "{{ system_settings_macos.security.settings.require_password_after_sleep | ternary(1, 0) }}"
        state: present
      when: system_settings_macos.security.settings.require_password_after_sleep is defined

    - name: Set password delay after sleep
      community.general.osx_defaults:
        domain: com.apple.screensaver
        key: askForPasswordDelay
        type: int
        value: "{{ system_settings_macos.security.settings.password_delay | default(0) }}"
        state: present
      when: system_settings_macos.security.settings.require_password_after_sleep is defined

    - name: Configure Gatekeeper
      ansible.builtin.command:
        cmd: "spctl --master-{{ system_settings_macos.security.settings.enable_gatekeeper | ternary('enable', 'disable') }}"
      become: true
      when: system_settings_macos.security.settings.enable_gatekeeper is defined
  when:
    - system_settings_macos.security.enabled | default(false) | bool
    - system_settings_macos.security.settings is defined
    - system_settings_macos.security.settings | length > 0
  tags:
    - macos
    - security
