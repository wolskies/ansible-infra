---

- name: Configure macOS Dock
  block:
    - name: Set Dock size
      community.general.osx_defaults:
        domain: com.apple.dock
        key: tilesize
        type: int
        value: "{{ config_macos_gui.dock.tile_size }}"
      notify: restart dock

    - name: Set Dock position
      community.general.osx_defaults:
        domain: com.apple.dock
        key: orientation
        type: string
        value: "{{ config_macos_gui.dock.position }}"
      notify: restart dock

    - name: Configure Dock auto-hide
      community.general.osx_defaults:
        domain: com.apple.dock
        key: autohide
        type: bool
        value: "{{ config_macos_gui.dock.autohide }}"
      notify: restart dock

    - name: Configure Dock magnification
      community.general.osx_defaults:
        domain: com.apple.dock
        key: magnification
        type: bool
        value: "{{ config_macos_gui.dock.magnification }}"
      notify: restart dock

  when: config_macos_gui.dock.enabled | default(true)
  tags:
    - macos
    - dock
    - gui

- name: Configure Finder preferences
  block:
    - name: Show file extensions in Finder
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleShowAllExtensions
        type: bool
        value: "{{ config_macos_gui.finder.show_extensions }}"
      notify: restart finder

    - name: Show hidden files in Finder
      community.general.osx_defaults:
        domain: com.apple.finder
        key: AppleShowAllFiles
        type: bool
        value: "{{ config_macos_gui.finder.show_hidden_files }}"
      notify: restart finder

    - name: Set default Finder view
      community.general.osx_defaults:
        domain: com.apple.finder
        key: FXPreferredViewStyle
        type: string
        value: >-
          {%- if config_macos_gui.finder.default_view == 'column' -%}clmv
          {%- elif config_macos_gui.finder.default_view == 'list' -%}Nlsv
          {%- elif config_macos_gui.finder.default_view == 'icon' -%}icnv
          {%- elif config_macos_gui.finder.default_view == 'cover flow' -%}Flwv
          {%- else -%}clmv{%- endif %}
      notify: restart finder

  when: config_macos_gui.finder.enabled | default(true)
  tags:
    - macos
    - finder
    - gui

- name: Configure system behavior preferences
  block:
    - name: Enable fast key repeat
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: KeyRepeat
        type: int
        value: 2
      when: config_macos_gui.behavior.fast_key_repeat | default(true)
      notify: restart cfprefsd

    - name: Set initial key repeat delay
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: InitialKeyRepeat
        type: int
        value: 15
      when: config_macos_gui.behavior.fast_key_repeat | default(true)
      notify: restart cfprefsd

    - name: Show battery percentage in menu bar
      community.general.osx_defaults:
        domain: ~/Library/Preferences/ByHost/com.apple.controlcenter
        key: BatteryShowPercentage
        type: bool
        value: "{{ config_macos_gui.display.show_battery_percentage }}"
      when: config_macos_gui.display.show_battery_percentage is defined
      notify: restart cfprefsd

  when: config_macos_gui.behavior.enabled | default(true)
  tags:
    - macos
    - behavior
    - gui

- name: Configure GUI security settings
  block:
    - name: Require password immediately after sleep or screensaver
      community.general.osx_defaults:
        domain: com.apple.screensaver
        key: askForPasswordDelay
        type: int
        value: 0
      when: config_macos_gui.security.require_password_immediately | default(true)
      notify: restart cfprefsd

    - name: Require admin password for system-wide preferences
      community.general.osx_defaults:
        domain: /Library/Preferences/com.apple.preferences.accounts
        key: DisableGuestAccount
        type: bool
        value: true
      become: true
      when: config_macos_gui.security.require_admin_password | default(true)

    - name: Enable Gatekeeper
      ansible.builtin.command: spctl --master-enable
      become: true
      register: gatekeeper_result
      changed_when: "'assessments enabled' in gatekeeper_result.stdout"
      failed_when: false
      when: config_macos_gui.security.enable_gatekeeper | default(true)

  when: config_macos_gui.security.enabled | default(true)
  tags:
    - security
    - macos
    - gui
