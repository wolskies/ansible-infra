---
# Language ecosystem package management
# Handles npm, uv (Python), cargo, go modules with dependency checking

- name: Install missing language tools via system package manager
  block:
    - name: Check for required tools
      ansible.builtin.command: "which {{ item.tool }}"
      register: tool_check
      changed_when: false
      failed_when: false
      loop:
        - tool: "python3"
          packages_ubuntu: ["python3"]
          packages_debian: ["python3"]
          packages_archlinux: ["python"]
          packages_macosx: []
          condition: "{{ language_packages.python.enable and (language_packages.python.packages | default([]) | length > 0) }}"
        - tool: "npm"
          packages_ubuntu: ["nodejs", "npm"]
          packages_debian: ["nodejs", "npm"]
          packages_archlinux: ["nodejs", "npm"]
          packages_macosx: []
          condition: "{{ language_packages.nodejs.enable and (language_packages.nodejs.packages | default([]) | length > 0) }}"
      when:
        - language_packages.config.check_dependencies | default(true)
        - language_packages.config.install_missing_tools | default(true)
        - item.condition | bool

    - name: Install missing tools via system package manager
      ansible.builtin.package:
        name: "{{ vars['packages_' + ansible_distribution | lower] }}"
        state: present
      become: true
      loop: "{{ tool_check.results }}"
      loop_control:
        loop_var: result
      when:
        - language_packages.config.install_missing_tools | default(true)
        - result.rc is defined
        - result.rc != 0
        - result.item.condition | bool
      vars:
        packages_ubuntu: "{{ result.item.packages_ubuntu }}"
        packages_debian: "{{ result.item.packages_debian }}"
        packages_archlinux: "{{ result.item.packages_archlinux }}"
        packages_macosx: "{{ result.item.packages_macosx }}"

# Python packages via uv
- name: Setup Python packages
  block:
    - name: Validate uv installation method
      ansible.builtin.fail:
        msg: "Invalid language_packages.python.install_method: {{ language_packages.python.install_method }}. Must be 'user', 'global', or 'project'"
      when: language_packages.python.install_method not in ['user', 'global', 'project']

    - name: Warn about global uv installation
      ansible.builtin.debug:
        msg: |
          WARNING: Global Python package installation can conflict with system packages.
          Consider using 'user' or 'project' method instead.
      when: language_packages.python.install_method == 'global'

    - name: Check if uv is installed
      ansible.builtin.command: "which uv"
      register: uv_check
      changed_when: false
      failed_when: false

    - name: Install uv via secure script
      ansible.builtin.include_tasks: secure_script_install.yml
      vars:
        tool_name: uv
        download_url: https://astral.sh/uv/install.sh
        target_binary: "{{ ansible_env.HOME }}/.local/bin/uv"
      when:
        - uv_check.rc != 0
        - language_packages.config.install_missing_tools | default(true)

    - name: Fail if uv is not installed and auto-install disabled
      ansible.builtin.fail:
        msg: "uv is not installed. Please install uv first or set language_packages.config.install_missing_tools: true"
      when:
        - uv_check.rc != 0
        - not (language_packages.config.install_missing_tools | default(true))

    - name: Create project directory for project-based installs
      ansible.builtin.file:
        path: "{{ language_packages.python.project_path }}"
        state: directory
        mode: "0755"
      become: false
      when: language_packages.python.install_method == 'project'

    - name: Initialize uv project for project-based installs
      ansible.builtin.command:
        cmd: "{{ ansible_env.HOME }}/.local/bin/uv init"
        chdir: "{{ language_packages.python.project_path }}"
        creates: "{{ language_packages.python.project_path }}/pyproject.toml"
      when: language_packages.python.install_method == 'project'
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"

    - name: Install Python packages with uv (user method)
      ansible.builtin.command: "{{ ansible_env.HOME }}/.local/bin/uv tool install {{ item }}"
      loop: "{{ language_packages.python.packages }}"
      register: uv_user_install
      changed_when: "'already installed' not in uv_user_install.stdout"
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"
      when: language_packages.python.install_method == 'user'

    - name: Install Python packages with uv (global method)
      ansible.builtin.command: "uv tool install --global {{ item }}"
      loop: "{{ language_packages.python.packages }}"
      register: uv_global_install
      changed_when: "'already installed' not in uv_global_install.stdout"
      become: true
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"
      when: language_packages.python.install_method == 'global'

    - name: Install Python packages with uv (project method)
      ansible.builtin.command: "{{ ansible_env.HOME }}/.local/bin/uv add {{ item }}"
      loop: "{{ language_packages.python.packages }}"
      register: uv_project_install
      changed_when: uv_project_install.rc == 0
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"
      args:
        chdir: "{{ language_packages.python.project_path }}"
      when: language_packages.python.install_method == 'project'
  when:
    - language_packages.python.enable | default(false)
    - language_packages.python.packages is defined
    - language_packages.python.packages | length > 0
  tags:
    - python
    - uv
    - language-packages

# Node.js packages via npm
- name: Setup Node.js packages
  block:
    - name: Ensure npm is installed
      ansible.builtin.fail:
        msg: "npm is not installed. Please install Node.js and npm first or set language_packages.config.install_missing_tools: true"
      when:
        - not (language_packages.config.install_missing_tools | default(true))
        - ansible_facts['packages']['npm'] is not defined

    - name: Install npm packages globally
      community.general.npm:
        name: "{{ item }}"
        global: "{{ language_packages.nodejs.install_global }}"
        state: present
      loop: "{{ language_packages.nodejs.packages }}"
      become: "{{ language_packages.nodejs.install_global }}"
  when:
    - language_packages.nodejs.enable | default(false)
    - language_packages.nodejs.packages is defined
    - language_packages.nodejs.packages | length > 0
  tags:
    - nodejs
    - npm
    - language-packages

# Rust packages via cargo
- name: Setup Rust packages
  block:
    - name: Check if cargo is installed
      ansible.builtin.command: which cargo
      register: cargo_check
      changed_when: false
      failed_when: false

    - name: Install Rust via secure script
      ansible.builtin.include_tasks: secure_script_install.yml
      vars:
        tool_name: rust
        download_url: https://sh.rustup.rs
        install_args: "-y"
        target_binary: "{{ ansible_env.HOME }}/.cargo/bin/cargo"
      when:
        - cargo_check.rc != 0
        - language_packages.config.install_missing_tools | default(true)

    - name: Fail if Rust is not installed and auto-install disabled
      ansible.builtin.fail:
        msg: "Rust is not installed. Please install Rust first or set language_packages.config.install_missing_tools: true"
      when:
        - cargo_check.rc != 0
        - not (language_packages.config.install_missing_tools | default(true))

    - name: Install Rust packages
      ansible.builtin.command: "{{ ansible_env.HOME }}/.cargo/bin/cargo install {{ item }}"
      loop: "{{ language_packages.rust.packages }}"
      register: cargo_install
      changed_when: "'Installed' in cargo_install.stdout"
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.cargo/bin"
  when:
    - language_packages.rust.enable | default(false)
    - language_packages.rust.packages is defined
    - language_packages.rust.packages | length > 0
  tags:
    - rust
    - cargo
    - language-packages

# Go packages
- name: Setup Go packages
  block:
    - name: Check if go is installed
      ansible.builtin.command: which go
      register: go_check
      changed_when: false
      failed_when: false

    - name: Install Go via system package manager if missing
      ansible.builtin.package:
        name: "{{ go_package_name }}"
        state: present
      become: true
      when:
        - go_check.rc != 0
        - language_packages.config.install_missing_tools | default(true)
      vars:
        go_package_name: "{{ 'go' if ansible_distribution in ['Ubuntu', 'Debian', 'Archlinux'] else 'golang' }}"

    - name: Fail if Go is not installed and auto-install disabled
      ansible.builtin.fail:
        msg: "Go is not installed. Please install Go first or set language_packages.config.install_missing_tools: true"
      when:
        - go_check.rc != 0
        - not (language_packages.config.install_missing_tools | default(true))

    - name: Install Go packages
      ansible.builtin.command: "go install {{ item }}"
      loop: "{{ language_packages.go.packages }}"
      environment:
        GO111MODULE: "on"
        GOPATH: "{{ ansible_env.HOME }}/go"
        PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/go/bin"
      register: go_install
      changed_when: go_install.rc == 0
  when:
    - language_packages.go.enable | default(false)
    - language_packages.go.packages is defined
    - language_packages.go.packages | length > 0
  tags:
    - golang
    - go
    - language-packages

# Display summary
- name: Display language packages summary
  ansible.builtin.debug:
    msg:
      - "=== Language Packages Summary ==="
      - "Python packages: {{ language_packages.python.packages | default([]) | length }} (uv method: {{ language_packages.python.install_method | default('user') }})"
      - "Node.js packages: {{ language_packages.nodejs.packages | default([]) | length }}"
      - "Rust packages: {{ language_packages.rust.packages | default([]) | length }}"
      - "Go packages: {{ language_packages.go.packages | default([]) | length }}"
      - "=== Security Enhancements ==="
      - "✅ Secure script downloads with certificate validation"
      - "✅ Temporary file cleanup after installation"
      - "✅ Script integrity verification support"
  tags:
    - always
    - summary
    - language-packages
