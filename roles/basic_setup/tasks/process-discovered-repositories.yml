---
# Process discovered repositories from discovery role
- name: Configure discovered APT repositories
  become: true
  block:
    - name: Check existing APT sources
      ansible.builtin.shell: |
        grep -h "^[^#]" /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null | grep -F "{{ item }}" || true
      loop: "{{ discovered_repositories.apt.additional_sources | default([]) }}"
      register: apt_source_check
      changed_when: false
      when:
        - discovered_repositories.apt.additional_sources is defined
        - discovered_repositories.apt.additional_sources | length > 0

    - name: Add discovered APT sources (only if not present)
      ansible.builtin.apt_repository:
        repo: "{{ item.item }}"
        state: present
        update_cache: true
      loop: "{{ apt_source_check.results | default([]) }}"
      when:
        - discovered_repositories.apt.additional_sources is defined
        - discovered_repositories.apt.additional_sources | length > 0
        - apt_source_check is defined
        - item.stdout == ""  # Source not found in existing files

    - name: Add discovered APT keys
      ansible.builtin.apt_key:
        url: "{{ item }}"
        state: present
      loop: "{{ discovered_repositories.apt.keys | default([]) }}"
      when:
        - discovered_repositories.apt.keys is defined
        - discovered_repositories.apt.keys | length > 0

  when:
    - configure_additional_repositories | default(true)
    - ansible_os_family == 'Debian'
    - discovered_repositories.apt is defined
  tags:
    - repositories
    - apt-repositories
    - discovered-repositories
    - debian-family

- name: Configure discovered AUR helper (Arch Linux)
  block:
    - name: Install AUR helper if not present
      become: true
      ansible.builtin.package:
        name: "{{ discovered_repositories.pacman.aur_helpers[0] }}"
        state: present
      when:
        - discovered_repositories.pacman.aur_helpers is defined
        - discovered_repositories.pacman.aur_helpers | length > 0

    - name: Configure AUR helper
      ansible.builtin.debug:
        msg: "AUR helper {{ discovered_repositories.pacman.aur_helpers[0] }} is configured and ready"
      when:
        - discovered_repositories.pacman.aur_helpers is defined
        - discovered_repositories.pacman.aur_helpers | length > 0

  when:
    - setup_aur_helper | default(true)
    - ansible_distribution == 'Archlinux'
    - discovered_repositories.pacman is defined
  tags:
    - repositories
    - aur-setup
    - discovered-repositories
    - arch-linux

- name: Configure discovered Homebrew taps (macOS)
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
  loop: "{{ discovered_repositories.homebrew.taps | default([]) }}"
  when:
    - setup_homebrew_taps | default(true)
    - ansible_os_family == 'Darwin'
    - discovered_repositories.homebrew.taps is defined
    - discovered_repositories.homebrew.taps | length > 0
  tags:
    - repositories
    - homebrew-taps
    - discovered-repositories
    - macos

- name: Configure discovered Flatpak repositories
  community.general.flatpak_remote:
    name: "{{ item.name }}"
    flatpakrepo_url: "{{ item.url }}"
    state: present
  loop: "{{ discovered_repositories.flatpak.remotes | default([]) }}"
  when:
    - discovered_repositories.flatpak.remotes is defined
    - discovered_repositories.flatpak.remotes | length > 0
  tags:
    - repositories
    - flatpak-repositories
    - discovered-repositories

- name: Configure discovered Snap repositories
  ansible.builtin.shell: |
    snap install {{ item }}
  loop: "{{ discovered_repositories.snap.packages | default([]) }}"
  become: true
  when:
    - discovered_repositories.snap.packages is defined
    - discovered_repositories.snap.packages | length > 0
  tags:
    - repositories
    - snap-packages
    - discovered-repositories

- name: Display repository configuration summary
  ansible.builtin.debug:
    msg:
      - "Repository configuration completed:"
      - "APT sources: {{ discovered_repositories.apt.additional_sources | default([]) | length if ansible_os_family == 'Debian' else 'N/A' }}"
      - "AUR helper: {{ discovered_repositories.pacman.aur_helpers[0] | default('none') if ansible_distribution == 'Archlinux' else 'N/A' }}"
      - "Homebrew taps: {{ discovered_repositories.homebrew.taps | default([]) | length if ansible_os_family == 'Darwin' else 'N/A' }}"
      - "Flatpak remotes: {{ discovered_repositories.flatpak.remotes | default([]) | length }}"
      - "Snap packages: {{ discovered_repositories.snap.packages | default([]) | length }}"
  tags:
    - repositories
    - discovered-repositories
    - summary