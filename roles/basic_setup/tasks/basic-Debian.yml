---
# Debian basic setup and feature management
# Tags: sudo, packages, updates, repositories, firewall, security

- name: System security configuration
  block:
    - name: Allow passwordless sudo for the user (Debian)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^{{ ansible_user }}'
        line: '{{ ansible_user}} ALL=(ALL) NOPASSWD:ALL'
        validate: '/usr/sbin/visudo -cf %s'
        backup: true
      become: true
      tags:
        - sudo
        - security
        - user-config

  rescue:
    - name: Handle sudo configuration errors
      ansible.builtin.debug:
        msg: "Failed to configure sudo access for {{ ansible_user }}"
      tags:
        - debug
        - sudo
        - error-handling

  tags:
    - sudo
    - security
    - debian

- name: Package management
  block:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      become: true
      tags:
        - packages
        - updates
        - cache

    - name: Install merged package list
      ansible.builtin.package:
        name: "{{ final_packages_install }}"
        state: present
      become: true
      when: 
        - final_packages_install is defined
        - final_packages_install | length > 0
      tags:
        - packages
        - package-install
        - merged-packages

    - name: Remove unwanted packages
      ansible.builtin.package:
        name: "{{ final_packages_remove }}"
        state: absent
        purge: true
      become: true
      when: 
        - final_packages_remove is defined
        - final_packages_remove | length > 0
      tags:
        - packages
        - package-remove
        - cleanup

  rescue:
    - name: Handle package management errors
      ansible.builtin.debug:
        msg: "Package management encountered errors, check logs for details"
      tags:
        - debug
        - packages
        - error-handling

  tags:
    - packages
    - debian

- name: System updates
  block:
    - name: Perform system upgrade
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        autoremove: true
        autoclean: true
      become: true
      register: upgrade_result
      tags:
        - updates
        - upgrade
        - maintenance

    - name: Display upgrade results
      ansible.builtin.debug:
        msg:
          - "System upgrade completed"
          - "Packages upgraded: {{ upgrade_result.changed }}"
      when: upgrade_result is defined
      tags:
        - updates
        - debug
        - summary

  rescue:
    - name: Handle system upgrade errors
      ansible.builtin.debug:
        msg: "System upgrade failed, manual intervention may be required"
      tags:
        - debug
        - updates
        - error-handling

  when: enable_system_updates | default(true)
  tags:
    - updates
    - debian

- name: Debian repository management
  block:
    - name: Enable non-free repositories if requested
      ansible.builtin.apt_repository:
        repo: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }} non-free"
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }}-updates non-free"
        - "deb http://security.debian.org/debian-security {{ ansible_distribution_release }}-security non-free"
      become: true
      when: debian_enable_non_free | default(false)
      tags:
        - repositories
        - non-free

  tags:
    - debian
    - repositories

- name: Debian system optimization
  block:
    - name: Configure APT for better performance
      ansible.builtin.copy:
        content: |
          APT::Acquire::Retries "3";
          APT::Acquire::http::Timeout "30";
          APT::Install-Recommends "false";
          APT::Install-Suggests "false";
        dest: /etc/apt/apt.conf.d/99optimization
        mode: '0644'
      become: true
      when: debian_optimize_apt | default(true)
      tags:
        - apt
        - optimization

    - name: Enable automatic security updates
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present
      become: true
      when: debian_enable_auto_security_updates | default(true)
      tags:
        - updates
        - security

    - name: Configure unattended upgrades for security only
      ansible.builtin.copy:
        content: |
          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}-security";
              "${distro_id} ESMApps:${distro_codename}-apps-security";
              "${distro_id} ESM:${distro_codename}-infra-security";
          };
          Unattended-Upgrade::Automatic-Reboot "false";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        mode: '0644'
      become: true
      when: debian_enable_auto_security_updates | default(true)
      tags:
        - updates
        - security

  tags:
    - debian
    - optimization

- name: Basic firewall setup
  block:
    - name: Install UFW firewall
      ansible.builtin.package:
        name: ufw
        state: present
      become: true
      tags:
        - firewall
        - install

    - name: Allow SSH through firewall
      community.general.ufw:
        rule: allow
        name: OpenSSH
        comment: "Allow SSH access - managed by basic_setup"
      become: true
      tags:
        - firewall
        - ssh
        - basic

    - name: Enable UFW firewall with default deny policy
      community.general.ufw:
        state: enabled
        policy: deny
        direction: incoming
      become: true
      tags:
        - firewall
        - enable
        - security

  rescue:
    - name: Handle basic firewall setup errors
      ansible.builtin.debug:
        msg: "Basic firewall setup failed - SSH access may be blocked"
      tags:
        - debug
        - firewall
        - error-handling

  when: install_firewall | default(true)
  tags:
    - firewall
    - basic-security
    - debian

