---
# Debian/Ubuntu specific basic setup tasks
# Tags: sudo, packages, updates, firewall, security, debian-ubuntu

- name: System security configuration
  block:
    - name: Allow passwordless sudo for the user (Debian/Ubuntu)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^{{ ansible_user }}'
        line: '{{ ansible_user}} ALL=(ALL) NOPASSWD:ALL'
        validate: '/usr/sbin/visudo -cf %s'
        backup: true
      become: true
      tags:
        - sudo
        - security
        - user-config

  rescue:
    - name: Handle sudo configuration errors
      ansible.builtin.debug:
        msg: "Failed to configure sudo access for {{ ansible_user }}"
      tags:
        - debug
        - sudo
        - error-handling

  tags:
    - sudo
    - security
    - debian-ubuntu

- name: Package management
  block:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      become: true
      tags:
        - packages
        - updates
        - cache

    - name: Install essential packages
      ansible.builtin.package:
        name: "{{ packages_install }}"
        state: present
      become: true
      when: packages_install is defined
      tags:
        - packages
        - package-install
        - essential

    - name: Remove unwanted packages
      ansible.builtin.package:
        name: "{{ packages_remove }}"
        state: absent
        purge: true
      become: true
      when: packages_remove is defined
      tags:
        - packages
        - package-remove
        - cleanup

  rescue:
    - name: Handle package management errors
      ansible.builtin.debug:
        msg: "Package management encountered errors, check logs for details"
      tags:
        - debug
        - packages
        - error-handling

  tags:
    - packages
    - debian-ubuntu

- name: System updates
  block:
    - name: Perform system upgrade
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        autoremove: true
        autoclean: true
      become: true
      register: upgrade_result
      tags:
        - updates
        - upgrade
        - maintenance

    - name: Display upgrade results
      ansible.builtin.debug:
        msg:
          - "System upgrade completed"
          - "Packages upgraded: {{ upgrade_result.changed }}"
      when: upgrade_result is defined
      tags:
        - updates
        - debug
        - summary

  rescue:
    - name: Handle system upgrade errors
      ansible.builtin.debug:
        msg: "System upgrade failed, manual intervention may be required"
      tags:
        - debug
        - updates
        - error-handling

  when: enable_system_updates | default(true)
  tags:
    - updates
    - debian-ubuntu

- name: Firewall configuration
  block:
    - name: Configure UFW - Allow OpenSSH
      community.general.ufw:
        rule: allow
        name: OpenSSH
        comment: "Allow SSH access"
      become: true
      tags:
        - firewall
        - ufw
        - ssh
        - security

    - name: Configure UFW - Additional rules
      community.general.ufw:
        rule: "{{ item.rule }}"
        port: "{{ item.port | default(omit) }}"
        proto: "{{ item.proto | default('tcp') }}"
        src: "{{ item.src | default(omit) }}"
        comment: "{{ item.comment | default(omit) }}"
      loop: "{{ ufw_rules | default([]) }}"
      become: true
      tags:
        - firewall
        - ufw
        - security
        - custom-rules

    - name: Enable UFW firewall
      community.general.ufw:
        state: enabled
        policy: deny
        direction: incoming
      become: true
      when: enable_firewall | default(true)
      tags:
        - firewall
        - ufw
        - security
        - enable-firewall

    - name: Display UFW status
      ansible.builtin.command: ufw status verbose
      register: ufw_status
      become: true
      changed_when: false
      tags:
        - firewall
        - ufw
        - status
        - debug

    - name: Show firewall configuration
      ansible.builtin.debug:
        var: ufw_status.stdout_lines
      tags:
        - firewall
        - debug
        - summary

  rescue:
    - name: Handle firewall configuration errors
      ansible.builtin.debug:
        msg: "Firewall configuration failed, system may be unprotected"
      tags:
        - debug
        - firewall
        - error-handling
        - security-warning

  when: configure_firewall | default(true)
  tags:
    - firewall
    - security
    - debian-ubuntu



