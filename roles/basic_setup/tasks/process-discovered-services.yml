---
# Process discovered services from discovery role
# NOTE: This file handles service configuration replication with caution
- name: Backup existing service configurations
  become: true
  block:
    - name: Create backup directory
      ansible.builtin.file:
        path: "/etc/ansible-service-backups/{{ ansible_date_time.epoch }}"
        state: directory
        mode: '0755'
      register: backup_dir

    - name: Backup nginx configuration
      ansible.builtin.copy:
        src: "/etc/nginx/"
        dest: "{{ backup_dir.path }}/nginx/"
        remote_src: true
        mode: preserve
      when:
        - discovered_services.web_servers.nginx.detected | default(false)
        - backup_existing_configs | default(true)

    - name: Backup apache configuration
      ansible.builtin.copy:
        src: "/etc/apache2/"
        dest: "{{ backup_dir.path }}/apache2/"
        remote_src: true
        mode: preserve
      when:
        - discovered_services.web_servers.apache.detected | default(false)
        - backup_existing_configs | default(true)

  when:
    - backup_existing_configs | default(true)
    - configure_discovered_services | default(false)
  tags:
    - services
    - backup
    - discovered-services

- name: Configure discovered Nginx sites (manual review required)
  become: true
  block:
    - name: Display Nginx sites found
      ansible.builtin.debug:
        msg:
          - "Nginx sites discovered on source machine:"
          - "{{ discovered_services.web_servers.nginx.sites | default([]) }}"
          - ""
          - "MANUAL ACTION REQUIRED:"
          - "1. Review these site configurations"
          - "2. Copy relevant site files manually"
          - "3. Update domain names and paths as needed"
          - "4. Test configurations before enabling"

    - name: Create nginx sites directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/nginx/sites-available
        - /etc/nginx/sites-enabled
      when: ansible_os_family == 'Debian'

  when:
    - discovered_services.web_servers.nginx.detected | default(false)
    - configure_discovered_services | default(false)
  tags:
    - services
    - nginx
    - discovered-services
    - manual-review

- name: Configure discovered Apache sites (manual review required)
  become: true
  block:
    - name: Display Apache sites found
      ansible.builtin.debug:
        msg:
          - "Apache sites discovered on source machine:"
          - "{{ discovered_services.web_servers.apache.sites | default([]) }}"
          - ""
          - "MANUAL ACTION REQUIRED:"
          - "1. Review these site configurations"
          - "2. Copy relevant site files manually"
          - "3. Update domain names and paths as needed"
          - "4. Test configurations before enabling"

    - name: Create apache sites directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/apache2/sites-available
        - /etc/apache2/sites-enabled
      when: ansible_os_family == 'Debian'

  when:
    - discovered_services.web_servers.apache.detected | default(false)
    - configure_discovered_services | default(false)
  tags:
    - services
    - apache
    - discovered-services
    - manual-review

- name: Configure discovered database services (manual review required)
  block:
    - name: Display discovered database information
      ansible.builtin.debug:
        msg:
          - "Database services discovered:"
          - "MySQL/MariaDB: {{ 'Yes' if discovered_services.databases.mysql_detected else 'No' }}"
          - "PostgreSQL: {{ 'Yes' if discovered_services.databases.postgresql_detected else 'No' }}"
          - ""
          - "MANUAL ACTION REQUIRED:"
          - "1. Install database services if needed"
          - "2. Configure authentication and access"
          - "3. Restore database dumps if available"
          - "4. Set up vault variables for database passwords"

    - name: Install MySQL/MariaDB if discovered
      become: true
      ansible.builtin.package:
        name: "{{ 'mariadb-server' if ansible_os_family == 'Debian' else 'mariadb' }}"
        state: present
      when:
        - discovered_services.databases.mysql_detected | default(false)
        - configure_discovered_services | default(false)

    - name: Install PostgreSQL if discovered
      become: true
      ansible.builtin.package:
        name: postgresql
        state: present
      when:
        - discovered_services.databases.postgresql_detected | default(false)
        - configure_discovered_services | default(false)

  when:
    - discovered_services.databases.mysql_detected | default(false) or
      discovered_services.databases.postgresql_detected | default(false)
  tags:
    - services
    - databases
    - discovered-services
    - manual-review

- name: Configure discovered SSH settings
  become: true
  block:
    - name: Update SSH port if custom port detected
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port'
        line: "Port {{ discovered_security.ssh.settings.port }}"
        backup: true
      when:
        - discovered_security.ssh.settings.port is defined
        - discovered_security.ssh.settings.port != '22'
      notify: restart ssh

    - name: Display SSH configuration info
      ansible.builtin.debug:
        msg:
          - "SSH service configuration:"
          - "Port: {{ discovered_security.ssh.settings.port | default('22') }}"
          - "Service running: {{ discovered_security.ssh.service_running | default(false) }}"

  when:
    - discovered_security.ssh.service_running | default(false)
    - configure_discovered_services | default(false)
  tags:
    - services
    - ssh
    - discovered-services

- name: Display service configuration summary
  ansible.builtin.debug:
    msg:
      - "Service configuration processing completed:"
      - "Nginx sites: {{ discovered_services.web_servers.nginx.sites | default([]) | length }}"
      - "Apache sites: {{ discovered_services.web_servers.apache.sites | default([]) | length }}"
      - "Databases: {{ 'MySQL/MariaDB, ' if discovered_services.databases.mysql_detected else '' }}{{ 'PostgreSQL' if discovered_services.databases.postgresql_detected else '' }}"
      - "SSH configured: {{ discovered_security.ssh.service_running | default(false) }}"
      - ""
      - "IMPORTANT: Service configurations require manual review and testing"
      - "Check backup directory: {{ backup_dir.path | default('not created') }}"
  tags:
    - services
    - discovered-services
    - summary