---
# Debian-specific features and management
# Tags: repositories, debian

- name: Debian repository management
  block:
    - name: Enable non-free repositories if requested
      ansible.builtin.apt_repository:
        repo: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }} non-free"
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }}-updates non-free"
        - "deb http://security.debian.org/debian-security {{ ansible_distribution_release }}-security non-free"
      become: true
      when: debian_enable_nonfree | default(false)
      tags:
        - repositories
        - nonfree
        - apt

    - name: Enable contrib repositories if requested
      ansible.builtin.apt_repository:
        repo: "{{ item }}"
        state: present
        update_cache: true
      loop:
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }} contrib"
        - "deb http://deb.debian.org/debian {{ ansible_distribution_release }}-updates contrib"
        - "deb http://security.debian.org/debian-security {{ ansible_distribution_release }}-security contrib"
      become: true
      when: debian_enable_contrib | default(false)
      tags:
        - repositories
        - contrib
        - apt

    - name: Add backports repository if requested
      ansible.builtin.apt_repository:
        repo: "deb http://deb.debian.org/debian {{ ansible_distribution_release }}-backports main contrib non-free"
        state: present
        update_cache: true
      become: true
      when: debian_enable_backports | default(false)
      tags:
        - repositories
        - backports
        - apt

  rescue:
    - name: Handle repository management errors
      ansible.builtin.debug:
        msg: "Repository management encountered errors"
      tags:
        - debug
        - repositories
        - error-handling

  tags:
    - repositories
    - debian
    - apt