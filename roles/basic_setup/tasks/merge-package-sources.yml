---
# Merge package sources from inventory hierarchy
# Standard Ansible variable precedence: all -> groups -> host
# Discovery populates these same variables, no special handling needed

- name: Merge system packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_system_packages: >-
      {{
        (system_packages | default([])) +
        (group_system_packages | default([])) +
        (host_system_packages | default([]))
      }}
  tags:
    - merge
    - system-packages

- name: Merge development packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_development_packages: >-
      {{
        (development_packages | default([])) +
        (group_development_packages | default([])) +
        (host_development_packages | default([]))
      }}
  tags:
    - merge
    - development-packages

- name: Merge desktop packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_desktop_packages: >-
      {{
        (desktop_packages | default([])) +
        (group_desktop_packages | default([])) +
        (host_desktop_packages | default([]))
      }}
  tags:
    - merge
    - desktop-packages

- name: Merge media packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_media_packages: >-
      {{
        (media_packages | default([])) +
        (group_media_packages | default([])) +
        (host_media_packages | default([]))
      }}
  tags:
    - merge
    - media-packages

- name: Merge Python packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_pip_packages: >-
      {{
        (python_packages | default([])) +
        (group_python_packages | default([])) +
        (host_python_packages | default([]))
      }}
  tags:
    - merge
    - python-packages

- name: Merge Node.js packages from inventory hierarchy
  ansible.builtin.set_fact:
    final_npm_packages: >-
      {{
        (nodejs_packages | default([])) +
        (group_nodejs_packages | default([])) +
        (host_nodejs_packages | default([]))
      }}
  tags:
    - merge
    - nodejs-packages

- name: Merge AUR packages from inventory hierarchy (Arch Linux only)
  ansible.builtin.set_fact:
    final_aur_packages: >-
      {{
        (aur_packages | default([])) +
        (group_aur_packages | default([])) +
        (host_aur_packages | default([]))
      }}
  when: ansible_distribution == 'Archlinux'
  tags:
    - merge
    - aur-packages

- name: Merge Homebrew packages from inventory hierarchy (macOS only)
  ansible.builtin.set_fact:
    final_homebrew_packages: >-
      {{
        (homebrew_packages | default([])) +
        (group_homebrew_packages | default([])) +
        (host_homebrew_packages | default([]))
      }}
    final_homebrew_casks: >-
      {{
        (homebrew_casks | default([])) +
        (group_homebrew_casks | default([])) +
        (host_homebrew_casks | default([]))
      }}
  when: ansible_os_family == 'Darwin'
  tags:
    - merge
    - homebrew-packages

- name: Remove duplicates from all package lists
  ansible.builtin.set_fact:
    final_system_packages: "{{ final_system_packages | unique }}"
    final_development_packages: "{{ final_development_packages | unique }}"
    final_desktop_packages: "{{ final_desktop_packages | unique }}"
    final_media_packages: "{{ final_media_packages | unique }}"
    final_pip_packages: "{{ final_pip_packages | unique }}"
    final_npm_packages: "{{ final_npm_packages | unique }}"
  tags:
    - merge
    - deduplication

- name: Remove duplicates from OS-specific package lists
  ansible.builtin.set_fact:
    final_aur_packages: "{{ final_aur_packages | unique }}"
  when: ansible_distribution == 'Archlinux'
  tags:
    - merge
    - deduplication

- name: Remove duplicates from macOS package lists
  ansible.builtin.set_fact:
    final_homebrew_packages: "{{ final_homebrew_packages | unique }}"
    final_homebrew_casks: "{{ final_homebrew_casks | unique }}"
  when: ansible_os_family == 'Darwin'
  tags:
    - merge
    - deduplication

- name: Display package merge summary
  ansible.builtin.debug:
    msg:
      - "=== Package Inventory Merging Summary ==="
      - "Sources: group_vars + host_vars (discovery populates these same variables)"
      - "Total system packages: {{ final_system_packages | length }}"
      - "Total development packages: {{ final_development_packages | length }}"
      - "Total desktop packages: {{ final_desktop_packages | length }}"
      - "Total media packages: {{ final_media_packages | length }}"
      - "Total Python packages: {{ final_pip_packages | length }}"
      - "Total Node.js packages: {{ final_npm_packages | length }}"
  tags:
    - merge
    - debug
    - summary