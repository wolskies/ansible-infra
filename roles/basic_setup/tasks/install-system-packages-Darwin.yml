---
# Install system packages on macOS
# Handles Homebrew package and cask installation

- name: Install system packages on macOS
  block:
    - name: Update Homebrew
      community.general.homebrew:
        update_homebrew: true
      when: update_package_cache | default(true)
      tags:
        - packages
        - homebrew-update

    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ final_homebrew_packages }}"
        state: present
      when: 
        - final_homebrew_packages is defined
        - final_homebrew_packages | length > 0
      register: homebrew_install_result
      tags:
        - packages
        - homebrew-packages

    - name: Install Homebrew casks
      community.general.homebrew_cask:
        name: "{{ final_homebrew_casks }}"
        state: present
      when: 
        - install_homebrew_casks | default(true)
        - final_homebrew_casks is defined
        - final_homebrew_casks | length > 0
      register: cask_install_result
      tags:
        - packages
        - homebrew-casks

    - name: Install additional system packages (mapped from final_system_packages)
      community.general.homebrew:
        name: "{{ final_system_packages }}"
        state: present
      when: 
        - final_system_packages is defined
        - final_system_packages | length > 0
      register: system_homebrew_result
      tags:
        - packages
        - system-packages
        - homebrew

    - name: Display system package installation results
      ansible.builtin.debug:
        msg:
          - "macOS packages installation completed"
          - "Homebrew packages: {{ final_homebrew_packages | default([]) | length }}"
          - "Homebrew casks: {{ final_homebrew_casks | default([]) | length if install_homebrew_casks else 'skipped' }}"
          - "System packages: {{ final_system_packages | default([]) | length }}"
      tags:
        - packages
        - system-packages
        - summary

  rescue:
    - name: Handle system package installation errors
      ansible.builtin.debug:
        msg: "Some system packages failed to install. Continuing with other package categories."
      when: skip_failed_packages | default(true)
      tags:
        - packages
        - error-handling

    - name: Fail on package installation errors (if not skipping)
      ansible.builtin.fail:
        msg: "System package installation failed and skip_failed_packages is disabled"
      when: not (skip_failed_packages | default(true))
      tags:
        - packages
        - error-handling

  tags:
    - extra-packages
    - system-packages
    - macos