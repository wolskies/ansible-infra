---
# Install Node.js packages via npm
# Cross-platform Node.js package installation

- name: Install Node.js packages
  block:
    - name: Check if npm is available
      ansible.builtin.command: npm --version
      register: npm_check
      failed_when: false
      changed_when: false
      tags:
        - nodejs
        - npm-check

    - name: Install Node.js packages via npm
      community.general.npm:
        name: "{{ item }}"
        global: true
        state: present
      loop: "{{ final_npm_packages }}"
      when: 
        - npm_check.rc == 0
        - final_npm_packages is defined
        - final_npm_packages | length > 0
      register: npm_install_result
      tags:
        - nodejs
        - npm-packages

    - name: Display Node.js package installation results
      ansible.builtin.debug:
        msg:
          - "Node.js packages installation completed"
          - "Packages installed: {{ final_npm_packages | length }}"
          - "Installation successful: {{ npm_install_result.changed | default(false) }}"
      when: npm_check.rc == 0
      tags:
        - nodejs
        - npm-packages
        - summary

    - name: Warn if npm is not available
      ansible.builtin.debug:
        msg: "npm is not available - Node.js packages will be skipped"
      when: npm_check.rc != 0
      tags:
        - nodejs
        - warning

  rescue:
    - name: Handle Node.js package installation errors
      ansible.builtin.debug:
        msg: "Some Node.js packages failed to install. Continuing with other categories."
      when: skip_failed_packages | default(true)
      tags:
        - nodejs
        - error-handling

  tags:
    - extra-packages
    - nodejs-packages