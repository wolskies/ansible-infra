---
# Ubuntu-specific features and management
# Tags: snap, ubuntu

- name: Ubuntu snap management
  block:
    - name: Check if snapd is installed
      ansible.builtin.package_facts:
        manager: apt
      tags:
        - snap
        - feature-management

    - name: Stop snapd services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - snapd.service
        - snapd.socket
        - snapd.seeded.service
      become: true
      when: 
        - ubuntu_disable_snap | default(true)
        - "'snapd' in ansible_facts.packages"
      ignore_errors: true
      tags:
        - snap
        - feature-management

    - name: Remove snap packages
      ansible.builtin.command: snap remove {{ item }}
      loop:
        - lxd
        - core20
        - snapd
      become: true
      when: 
        - ubuntu_disable_snap | default(true)
        - "'snapd' in ansible_facts.packages"
      ignore_errors: true
      register: snap_removal
      changed_when: snap_removal.rc == 0
      tags:
        - snap
        - feature-management

    - name: Remove snapd package
      ansible.builtin.apt:
        name: snapd
        state: absent
        purge: true
      become: true
      when: ubuntu_disable_snap | default(true)
      tags:
        - snap
        - cleanup
        - remove

    - name: Remove snap directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /snap
        - /var/snap
        - /var/lib/snapd
        - /var/cache/snapd
        - /usr/lib/snapd
      become: true
      when: ubuntu_disable_snap | default(true)
      tags:
        - snap
        - cleanup
        - directories

    - name: Prevent snap from being installed
      ansible.builtin.copy:
        content: |
          Package: snapd
          Pin: release a=*
          Pin-Priority: -10
        dest: /etc/apt/preferences.d/nosnap.pref
        owner: root
        group: root
        mode: '0644'
      become: true
      when: ubuntu_disable_snap | default(true)
      tags:
        - snap
        - prevention
        - apt

  rescue:
    - name: Handle snap management errors
      ansible.builtin.debug:
        msg: "Snap management encountered errors. This is often expected on fresh installs."
      tags:
        - debug
        - snap
        - error-handling

  tags:
    - snap
    - ubuntu
    - feature-management