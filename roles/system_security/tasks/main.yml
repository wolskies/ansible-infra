---
# System Security main tasks
# Firewall and fail2ban management (complements devsec.hardening collection)

- name: System security initialization
  block:
    - name: Display security configuration
      ansible.builtin.debug:
        msg:
          - "=== System Security Configuration ==="
          - "Firewall: {{ 'enabled' if enable_firewall else 'disabled' }}"
          - "Fail2ban: {{ 'enabled' if enable_fail2ban else 'disabled' }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - ""
          - "Note: For comprehensive SSH and OS hardening, use devsec.hardening collection:"
          - "  - devsec.hardening.ssh_hardening"
          - "  - devsec.hardening.os_hardening"
      tags:
        - security
        - debug

    - name: Use discovered firewall type if available
      ansible.builtin.set_fact:
        firewall_type: "{{ discovered_services.security.firewall_type }}"
      when:
        - discovered_services is defined
        - discovered_services.security is defined
        - discovered_services.security.firewall_type is defined
        - discovered_services.security.firewall_type != 'none'
        - firewall_type == 'auto'
      tags:
        - security
        - firewall

# Phase 1: Firewall Configuration
- name: Configure firewall
  block:
    - name: Determine firewall tool
      ansible.builtin.set_fact:
        selected_firewall_tool: >-
          {%- if firewall_type != 'auto' -%}
            {{ firewall_type }}
          {%- elif ansible_distribution in firewall_tool_preference -%}
            {{ firewall_tool_preference[ansible_distribution] }}
          {%- elif ansible_os_family == 'Debian' -%}
            ufw
          {%- elif ansible_os_family == 'RedHat' -%}
            firewalld
          {%- else -%}
            iptables
          {%- endif %}

    - name: Validate firewall configuration
      ansible.builtin.fail:
        msg: "Invalid port in firewall_custom_rules: {{ item }}"
      loop: "{{ firewall_custom_rules }}"
      when:
        - firewall_custom_rules is defined
        - item.port is not defined or item.protocol is not defined

    - name: Include firewall tasks
      ansible.builtin.include_tasks: "firewall-{{ ansible_distribution }}.yml"
      when: ansible_distribution in ['Ubuntu', 'Debian', 'Archlinux']

    - name: Include Darwin firewall tasks
      ansible.builtin.include_tasks: "firewall-Darwin.yml"
      when: ansible_os_family == 'Darwin'

  when: enable_firewall | default(true)
  tags:
    - security
    - firewall

# Phase 2: Fail2ban Configuration
- name: Configure fail2ban
  block:
    - name: Check if fail2ban is already installed
      ansible.builtin.package_facts:
        manager: auto

    - name: Skip fail2ban if already configured
      ansible.builtin.debug:
        msg: "Fail2ban already installed and configured, skipping..."
      when:
        - discovered_services is defined
        - discovered_services.security is defined
        - discovered_services.security.fail2ban_detected | default(false)

    - name: Install fail2ban
      ansible.builtin.package:
        name: fail2ban
        state: present
      become: true
      when: not (discovered_services.security.fail2ban_detected | default(false))

    - name: Create fail2ban local configuration
      ansible.builtin.template:
        src: jail.local.j2
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      become: true
      notify: restart fail2ban
      when: not (discovered_services.security.fail2ban_detected | default(false))

    - name: Ensure fail2ban is started and enabled
      ansible.builtin.service:
        name: fail2ban
        state: started
        enabled: true
      become: true

  when: enable_fail2ban | default(false)
  tags:
    - security
    - fail2ban

# Phase 3: Summary
- name: Security configuration summary
  ansible.builtin.debug:
    msg:
      - "=== System Security Summary ==="
      - "Firewall: {{ selected_firewall_tool | default('not configured') }}"
      - "Allowed ports: {{ firewall_allowed_ports | default([]) | join(', ') }}"
      - "Fail2ban: {{ 'active' if enable_fail2ban else 'not configured' }}"
      - ""
      - "Security recommendations:"
      - "  - Add devsec.hardening.ssh_hardening for SSH security"
      - "  - Add devsec.hardening.os_hardening for OS-level security"
      - "  - This role provides firewall and fail2ban only"
  tags:
    - security
    - summary