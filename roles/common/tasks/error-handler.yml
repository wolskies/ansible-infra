---
# Common error handler for all roles
# This provides a standardized way to handle errors across the collection
# Include this file in rescue blocks to ensure consistent error handling

- name: Log error details
  ansible.builtin.debug:
    msg:
      - "ERROR: Task failed in {{ role_name | default(ansible_role_name) | default('unknown role') }}"
      - "Task: {{ ansible_failed_task.name | default('Unknown task') }}"
      - "Host: {{ inventory_hostname }}"
      - "Error: {{ ansible_failed_result.msg | default('No error message available') }}"
  when: ansible_failed_task is defined

- name: Set error fact for later reference
  ansible.builtin.set_fact:
    task_errors: "{{ task_errors | default([]) + [{'role': role_name | default(ansible_role_name) | default('unknown'), 'task': ansible_failed_task.name | default('unknown'), 'host': inventory_hostname, 'msg': ansible_failed_result.msg | default('No message')}] }}"
  when: ansible_failed_task is defined

- name: Determine if error is critical
  ansible.builtin.set_fact:
    is_critical_error: "{{ critical_errors | default(true) }}"

- name: Fail on critical errors
  ansible.builtin.fail:
    msg: "Critical error encountered. Stopping execution. Set critical_errors=false to continue on errors."
  when: is_critical_error | bool