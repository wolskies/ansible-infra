#SPDX-License-Identifier: MIT-0
---
- name: Include OS-specific install tasks
  include_tasks: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_release }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
      paths:
        - "{{ role_path }}/tasks"
        
- name: Check if dotfiles directory exists
  ansible.builtin.stat:
    path: /home/{{ ansible_user}}/.dotfiles
  register: dotfiles_directory

- name: Install dotfiles
  when: not dotfiles_directory.stat.exists
  block: 
    - name: Install dotfiles
      ansible.builtin.git:
        repo: "{{ dotfiles_repository_url | default('https://github.com/example/dotfiles.git') }}"
        dest: "{{ ansible_env.HOME }}/.dotfiles"
        update: true
        clone: true
        accept_hostkey: true
        key_file: "{{ ansible_env.HOME }}/.ssh/id_rsa"
    - name: Stow dotfiles
      ansible.builtin.shell: "stow . --verbose 2 --no-folding"
      args:
        chdir: "{{ ansible_env.HOME }}/.dotfiles"
  become: true
  become_user: "{{ ansible_user }}"