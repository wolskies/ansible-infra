---
- name: Check to see if basic packages are installed
  ansible.builtin.package:
    name:
      - git
      - stow
      - gpg
    state: present
  become: true

- name: Check for starship
  ansible.builtin.stat:
    path: /home/{{ ansible_user}}/.local/bin/starship
  register: starship_binary

- name: Install starship via script
  ansible.builtin.include_tasks: ../manage_language_packages/tasks/secure_script_install.yml
  vars:
    tool_name: starship
    download_url: https://starship.rs/install.sh
    install_args: "--yes"
    target_binary: "/home/{{ ansible_user}}/.local/bin/starship"
  when:
    - dotfiles_starship_enable | default(false)
    - not starship_binary.stat.exists

- name: Create starship configuration directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.config"
    state: directory
    mode: '0755'
  when:
    - dotfiles_starship_enable | default(false)
    - dotfiles_starship_create_config | default(true)

- name: Deploy starship configuration
  ansible.builtin.copy:
    content: "{{ dotfiles_starship_config }}"
    dest: "{{ ansible_env.HOME }}/.config/starship.toml"
    mode: '0644'
  when:
    - dotfiles_starship_enable | default(false)
    - dotfiles_starship_create_config | default(true)
    - dotfiles_starship_config is defined
    - dotfiles_starship_config | length > 0

- name: Check for zoxide
  ansible.builtin.stat:
    path: /home/{{ ansible_user}}/.local/bin/zoxide
  register: zoxide_binary

- name: Install zoxide via script
  ansible.builtin.include_tasks: ../manage_language_packages/tasks/secure_script_install.yml
  vars:
    tool_name: zoxide
    download_url: https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh
    target_binary: "/home/{{ ansible_user}}/.local/bin/zoxide"
  when: not zoxide_binary.stat.exists

- name: Check for eza
  ansible.builtin.stat:
    path: /usr/bin/eza
  register: eza_binary

- name: Install eza
  when: not eza_binary.stat.exists
  block:
    - name: Add eza GPG Key
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/eza-community/eza/main/deb.asc
        dest: /etc/apt/trusted.gpg.d/gierens.asc
        mode: '0644'
        force: true
    - name: Add eza Repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/trusted.gpg.d/gierens.asc] http://deb.gierens.de stable main"
        state: present
    - name: Update apt and install eza
      ansible.builtin.package:
        name:
          - eza
        state: latest
        update_cache: true
      become: true

- name: Check for fzf
  ansible.builtin.stat:
    path: /home/{{ ansible_user}}/.fzf/bin/fzf
  register: fzf_binary

- name: Install fzf
  when: not fzf_binary.stat.exists
  block:
    - name: Add fzf repo
      ansible.builtin.git:
        repo: https://github.com/junegunn/fzf.git
        dest: /home/{{ ansible_user }}/.fzf
        clone: true
        depth: 1
    - name: Install fzf
      ansible.builtin.shell: yes | /home/{{ ansible_user }}/.fzf/install

- name: Ensure fastfetch is present
  ansible.builtin.apt:
    deb: >-
      https://github.com/fastfetch-cli/fastfetch/releases/download/2.44.0/fastfetch-linux-{{
        'amd64' if ansible_architecture == 'x86_64' else
        'arm64' if ansible_architecture == 'aarch64' else ansible_architecture
      }}.deb
    state: present
  become: true
