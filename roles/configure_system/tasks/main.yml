---
# configure_system role main tasks

- name: Configure Operating System
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.os_configuration"
  tags:
    - host-configuration
    - core

- name: Manage Security Services
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.manage_security_services"
  tags:
    - security-services
    - core

- name: Manage Users
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.manage_users"
  tags:
    - users
    - user-management
    - core

- name: Manage System Packages
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.manage_packages"
  tags:
    - packages
    - package-management
    - core

- name: Manage Snap Packages
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.manage_snap_packages"
  when: ansible_system == "Linux"
  tags:
    - snap-packages
    - optional

- name: Manage Flatpak Packages
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.manage_flatpak"
  when: ansible_system == "Linux"
  tags:
    - flatpak-packages
    - optional

- name: Configure User Preferences
  ansible.builtin.include_role:
    name: "wolskinet.infrastructure.configure_user"
  vars:
    target_user: "{{ user_item }}"
  loop: "{{ infrastructure.domain.users | default([]) }}"
  loop_control:
    loop_var: user_item
  when:
    - user_item.name is defined
    - user_item.name != 'root' # Skip system accounts
  tags:
    - user-preferences
    - optional

- name: Display system configuration completion
  ansible.builtin.debug:
    msg:
      - "=== System Configuration Complete ==="
      - "Host: {{ inventory_hostname }}"
      - "Execution complete. Use tags to control which components are executed:"
      - "  Core components: --tags core"
      - "  Optional components: --tags optional"
      - "  Specific components: --tags users,packages,dotfiles"
  tags:
    - always
    - progress
