---
# Simple flatpak package management

- name: Install flatpak package (Debian/Ubuntu)
  ansible.builtin.apt:
    name: flatpak
    state: present
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"
  tags: []

- name: Install flatpak package (Arch Linux)
  community.general.pacman:
    name: flatpak
    state: present
  become: true
  when: ansible_os_family == "Archlinux"
  tags: []

- name: Install GNOME Software flatpak plugin (Debian/Ubuntu)
  ansible.builtin.apt:
    name: gnome-software-plugin-flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Debian"
    - flatpak.plugins.gnome | default(false)
  failed_when: false
  tags: []

- name: Install Plasma Discover flatpak plugin (Debian/Ubuntu)
  ansible.builtin.apt:
    name: plasma-discover-backend-flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Debian"
    - flatpak.plugins.plasma | default(false)
  failed_when: false
  tags: []

- name: Install GNOME Software flatpak plugin (Arch Linux)
  community.general.pacman:
    name: gnome-software-flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Archlinux"
    - flatpak.plugins.gnome | default(false)
  failed_when: false
  tags: []

- name: Install Plasma Discover flatpak plugin (Arch Linux)
  community.general.pacman:
    name: discover
    state: present
  become: true
  when:
    - ansible_os_family == "Archlinux"
    - flatpak.plugins.plasma | default(false)
  failed_when: false
  tags: []

- name: Enable Flathub repository
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    method: system
  become: true
  when:
    - flatpak is defined
    - flatpak.flathub
  tags: []

- name: Remove flatpak packages
  community.general.flatpak:
    name: "{{ item.name if item is mapping else item }}"
    state: absent
    method: "{{ item.method | default('system') if item is mapping else 'system' }}"
  loop: "{{ flatpak.packages.remove }}"
  become: "{{ false if (item is mapping and item.method | default('system') == 'user') else true }}"
  when:
    - flatpak is defined
    - flatpak.packages is defined
    - flatpak.packages.remove | length > 0
  tags: []

- name: Install flatpak packages
  community.general.flatpak:
    name: "{{ item.name if item is mapping else item }}"
    state: present
    method: "{{ item.method | default('system') if item is mapping else 'system' }}"
  loop: "{{ flatpak.packages.install }}"
  become: "{{ false if (item is mapping and item.method | default('system') == 'user') else true }}"
  when:
    - flatpak is defined
    - flatpak.packages is defined
    - flatpak.packages.install | length > 0
  tags: []
