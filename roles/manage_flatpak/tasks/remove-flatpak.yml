---
# Remove flatpak packages from system

- name: Ensure list of installed flatpak packages is retrieved
  ansible.builtin.shell: flatpak list --app --columns=application 2>/dev/null || true
  register: flatpak_packages_installed
  changed_when: false
  failed_when: false
  tags:
    - flatpak-packages
    - remove-flatpak

- name: Ensure all flatpak packages are removed
  community.general.flatpak:
    name: "{{ item }}"
    state: absent
    method: system
  loop: "{{ flatpak_packages_installed.stdout_lines }}"
  become: true
  when:
    - flatpak_packages.remove.all_packages | default(true)
    - flatpak_packages_installed.stdout_lines | length > 0
    - item | length > 0
  failed_when: false
  tags:
    - flatpak-packages
    - remove-flatpak

- name: Remove Flathub repository
  community.general.flatpak_remote:
    name: flathub
    state: absent
    method: system
  become: true
  when: flatpak_packages.remove.cleanup_repositories | default(true)
  failed_when: false
  tags:
    - flatpak-packages
    - remove-flatpak