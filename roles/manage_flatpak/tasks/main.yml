---
- name: Install flatpak package (Debian/Ubuntu)
  ansible.builtin.apt:
    name: flatpak
    state: present
    update_cache: true
  become: true
  when:
    - ansible_os_family == "Debian"
    - flatpak.enabled | default(false)
  tags:
    - flatpak-system

- name: Install flatpak package (Arch Linux)
  community.general.pacman:
    name: flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Archlinux"
    - flatpak.enabled | default(false)
  retries: 3
  delay: 10
  register: pacman_result
  until: pacman_result is succeeded
  tags:
    - flatpak-system

- name: Install GNOME Software flatpak plugin (Debian/Ubuntu)
  ansible.builtin.apt:
    name: gnome-software-plugin-flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Debian"
    - flatpak.enabled | default(false)
    - flatpak.plugins.gnome | default(false)
  failed_when: false
  tags:
    - flatpak-plugins

- name: Install Plasma Discover flatpak plugin (Debian/Ubuntu)
  ansible.builtin.apt:
    name: plasma-discover-backend-flatpak
    state: present
  become: true
  when:
    - ansible_os_family == "Debian"
    - flatpak.enabled | default(false)
    - flatpak.plugins.plasma | default(false)
  failed_when: false
  tags:
    - flatpak-plugins

- name: Enable Flathub repository
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    method: "{{ flatpak.method | default('system') }}"
  become: true
  become_user: "{{ flatpak.user | default(omit) }}"
  when:
    - flatpak.enabled | default(false)
    - flatpak.flathub | default(false)
  tags:
    - flatpak-system

- name: Manage flatpak packages
  community.general.flatpak:
    name: "{{ flatpak_package.name }}"
    state: "{{ flatpak_package.state | default('present') }}"
    method: "{{ flatpak.method | default('system') }}"
  loop: "{{ flatpak_packages | default([]) }}"
  loop_control:
    loop_var: flatpak_package
  become: true
  become_user: "{{ flatpak.user | default(omit) }}"
  when:
    - flatpak.enabled | default(false)
    - flatpak_packages | default([]) | length > 0
  tags:
    - flatpak-packages
