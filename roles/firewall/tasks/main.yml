---
# Main firewall management tasks
# Handles firewall port configuration across different operating systems

- name: Firewall management validation
  block:
    - name: Debug firewall configuration
      ansible.builtin.debug:
        msg:
          - "Firewall management: {{ 'enabled' if firewall_manage_ports else 'disabled' }}"
          - "OS Family: {{ ansible_os_family }}"
          - "Distribution: {{ ansible_distribution }}"
          - "Ports to configure: {{ firewall_ports | length }}"
          - "Services to configure: {{ firewall_services | length }}"
      tags:
        - firewall
        - debug
        - validation

    - name: Validate port configuration
      ansible.builtin.fail:
        msg: "Invalid port configuration: {{ item }}"
      loop: "{{ firewall_ports }}"
      when:
        - firewall_ports is defined
        - item.port is not defined or item.protocol is not defined
      tags:
        - firewall
        - validation

  tags:
    - always
    - firewall
    - validation

- name: Execute OS-specific firewall tasks
  block:
    - name: Include OS-specific firewall tasks
      ansible.builtin.include_tasks: "firewall-{{ ansible_distribution }}.yml"
      when: ansible_distribution in ['Ubuntu', 'Debian', 'Archlinux'] or ansible_os_family == 'Darwin'
      tags:
        - firewall
        - os-specific

    - name: Fallback to OS family tasks
      ansible.builtin.include_tasks: "firewall-{{ ansible_os_family }}.yml"
      when:
        - ansible_distribution not in ['Ubuntu', 'Debian', 'Archlinux']
        - ansible_os_family != 'Darwin'
        - ansible_os_family in ['RedHat', 'Suse']
      tags:
        - firewall
        - os-fallback

  rescue:
    - name: Handle firewall configuration errors
      ansible.builtin.debug:
        msg: "Firewall configuration failed for {{ ansible_distribution }}. Check if firewall is installed and accessible."
      tags:
        - debug
        - firewall
        - error-handling

  when: firewall_manage_ports | default(true)
  tags:
    - firewall
    - configuration

- name: Firewall configuration summary
  block:
    - name: Display firewall status
      ansible.builtin.debug:
        msg:
          - "=== Firewall Configuration Summary ==="
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Firewall tool: {{ firewall_tool_preference[ansible_distribution] | default('auto-detected') }}"
          - "Ports configured: {{ firewall_ports | length }}"
          - "Services configured: {{ firewall_services | length }}"
          - "Management enabled: {{ firewall_manage_ports }}"
      when: firewall_manage_ports | default(true)
      tags:
        - firewall
        - summary
        - debug

  tags:
    - always
    - firewall
    - summary
