---
# Debian UFW firewall management
# Manages ports and services using UFW (Uncomplicated Firewall)

- name: UFW port management
  block:
    - name: Configure UFW ports
      community.general.ufw:
        rule: allow
        port: "{{ item.port | string }}"
        proto: "{{ item.protocol | default('tcp') }}"
        src: "{{ item.source | default(omit) }}"
        comment: "{{ item.comment | default('Managed by firewall role') }}"
      loop: "{{ firewall_ports }}"
      become: true
      when: firewall_ports is defined and firewall_ports | length > 0
      notify: reload ufw
      tags:
        - firewall
        - ufw
        - ports

    - name: Configure UFW services
      community.general.ufw:
        rule: allow
        name: "{{ item }}"
        comment: "Service managed by firewall role"
      loop: "{{ firewall_services }}"
      become: true
      when: firewall_services is defined and firewall_services | length > 0
      notify: reload ufw
      tags:
        - firewall
        - ufw
        - services

    - name: Enable UFW logging
      community.general.ufw:
        logging: "on"
      become: true
      when: firewall_logging | default(false)
      tags:
        - firewall
        - ufw
        - logging

  rescue:
    - name: Handle UFW configuration errors
      ansible.builtin.debug:
        msg: "UFW configuration failed. Ensure UFW is installed and firewall is accessible."
      tags:
        - debug
        - firewall
        - error-handling

  tags:
    - firewall
    - debian
    - ufw