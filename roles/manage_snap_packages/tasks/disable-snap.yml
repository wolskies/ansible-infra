---
# Disable and remove snap system entirely from Ubuntu/Debian systems

- name: Get list of installed snap packages
  ansible.builtin.command: snap list
  register: snap_list
  become: true
  failed_when: false
  changed_when: false
  tags:
    - snap-packages

- name: Remove all installed snap packages
  ansible.builtin.command: "snap remove {{ item.split()[0] }}"
  become: true
  loop: "{{ snap_list.stdout_lines[1:] | default([]) }}"
  when:
    - snap_list.rc == 0
    - snap_list.stdout_lines | length > 1
    - item.split()[0] != "core"
  failed_when: false
  tags:
    - snap-packages

- name: Remove core snap packages (last)
  ansible.builtin.command: "snap remove core core18 core20 core22 snapd"
  become: true
  when: snap.disable_and_remove | default(true)
  failed_when: false
  tags:
    - snap-packages

- name: Stop and disable snapd services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    daemon_reload: true
  become: true
  loop:
    - snapd.service
    - snapd.socket
    - snapd.seeded.service
    - snapd.apparmor.service
  failed_when: false
  tags:
    - snap-packages

- name: Remove snap system packages (APT)
  ansible.builtin.apt:
    name:
      - snapd
      - gnome-software-plugin-snap
    state: absent
    purge: true
  become: true
  failed_when: false
  tags:
    - snap-packages

- name: Remove snap directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /snap
    - /var/snap
    - /var/lib/snapd
    - /var/cache/snapd
    - /usr/lib/snapd
    - "{{ ansible_env.HOME | default('/home/' + ansible_user_id) }}/snap"
  become: true
  failed_when: false
  tags:
    - snap-packages

- name: Remove snap from system PATH
  ansible.builtin.lineinfile:
    path: /etc/environment
    regexp: ".*:/snap/bin.*"
    state: absent
  become: true
  failed_when: false
  tags:
    - snap-packages

- name: Prevent snapd from being installed via APT preferences
  ansible.builtin.copy:
    content: |
      # Prevent snap packages from being installed
      # Generated by manage_snap_packages role
      Package: snapd gnome-software-plugin-snap
      Pin: release a=*
      Pin-Priority: -10
    dest: /etc/apt/preferences.d/no-snap
    owner: root
    group: root
    mode: "0644"
  become: true
  tags:
    - snap-packages
