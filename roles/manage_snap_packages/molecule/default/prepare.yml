---
- name: Prepare container for testing
  hosts: all
  become: true
  tasks:
    - name: Install acl package for proper become support
      ansible.builtin.apt:
        name: acl
        state: present
        update_cache: true
      when: ansible_os_family == 'Debian'

    # Ensure snapd is pre-installed for testing scenarios
    - name: Ensure snapd is installed for testing
      ansible.builtin.apt:
        name: snapd
        state: present
        update_cache: true
      when: ansible_os_family == 'Debian'

    - name: Start snapd services for testing
      ansible.builtin.systemd:
        name: "{{ snapd_service_item }}"
        state: started
        enabled: true
        daemon_reload: true
      loop:
        - snapd.service
        - snapd.socket
      loop_control:
        loop_var: snapd_service_item
      when: ansible_os_family == 'Debian'

    # Pre-install some test packages for removal testing
    - name: Install test snap packages that will be used for testing
      community.general.snap:
        name: hello-world
        state: present
      become: true
      when:
        - ansible_os_family == 'Debian'
        - inventory_hostname == 'ubuntu-snap-removal-full'
