---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Check if cargo is available
      ansible.builtin.shell: command -v cargo || test -f ~/.cargo/bin/cargo
      become: true
      become_user: rusttest
      register: cargo_check
      changed_when: false

    - name: Verify cargo is installed
      ansible.builtin.assert:
        that:
          - cargo_check.rc == 0
        fail_msg: "cargo is not available for rusttest user"

    - name: Check if rustup is available
      ansible.builtin.shell: command -v rustup || test -f ~/.cargo/bin/rustup
      become: true
      become_user: rusttest
      register: rustup_check
      changed_when: false

    - name: Verify rustup is installed
      ansible.builtin.assert:
        that:
          - rustup_check.rc == 0
        fail_msg: "rustup is not available for rusttest user"

    - name: Verify cargo install command works
      ansible.builtin.command: cargo --version
      become: true
      become_user: rusttest
      register: cargo_version
      changed_when: false

    - name: Verify cargo version format
      ansible.builtin.assert:
        that:
          - cargo_version.stdout is match("^cargo [0-9]+\\.[0-9]+\\.[0-9]+")
        fail_msg: "cargo version format is incorrect: {{ cargo_version.stdout }}"
