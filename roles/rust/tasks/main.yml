---
# Install Rust toolchain and user packages
# Expects: rust_user (target user) and rust_packages (list of cargo packages)

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - rust_user is defined
      - rust_user | length > 0
      - rust_packages is defined
    fail_msg: "rust role requires rust_user and rust_packages variables"

- name: Install rustup (Debian/Ubuntu)
  ansible.builtin.apt:
    name: rustup
    state: present
    update_cache: true
  become: true
  when:
    - rust_packages | length > 0
    - ansible_os_family == 'Debian'
    - (ansible_distribution == 'Ubuntu' and ansible_distribution_major_version | int >= 24) or
      (ansible_distribution == 'Debian' and ansible_distribution_major_version | int >= 13)
  tags:
    - rust
    - system-deps

- name: Install rustup (Arch Linux)
  ansible.builtin.package:
    name: rustup
    state: present
  become: true
  when:
    - rust_packages | length > 0
    - ansible_os_family == 'Archlinux'
  tags:
    - rust
    - system-deps

- name: Install rustup (macOS)
  community.general.homebrew:
    name: rustup
    state: present
  when:
    - rust_packages | length > 0
    - ansible_system == 'Darwin'
  tags:
    - rust
    - system-deps

- name: Get rust_user home directory
  ansible.builtin.user:
    name: "{{ rust_user }}"
  register: rust_user_info
  when:
    - rust_packages | length > 0

- name: Initialize rustup default toolchain
  ansible.builtin.command: rustup default stable
  environment:
    PATH: "{{ rust_user_info.home }}/.cargo/bin:{{ ansible_env.PATH }}{{ ':' + '/opt/homebrew/bin:/usr/local/bin' if ansible_system == 'Darwin' else '' }}"
  become: true
  become_user: "{{ rust_user }}"
  register: rustup_default
  changed_when: "'info: using existing install' not in rustup_default.stderr"
  when:
    - rust_packages | length > 0
  tags:
    - rust
    - language-packages

- name: Install Rust packages for {{ rust_user }}
  ansible.builtin.command: cargo install {{ rust_package }}
  environment:
    PATH: "{{ rust_user_info.home }}/.cargo/bin:{{ ansible_env.PATH }}{{ ':' + '/opt/homebrew/bin:/usr/local/bin' if ansible_system == 'Darwin' else '' }}"
  register: cargo_install
  changed_when: "'Installing' in cargo_install.stderr"
  loop: "{{ rust_packages }}"
  loop_control:
    loop_var: rust_package
  become: true
  become_user: "{{ rust_user }}"
  when:
    - rust_packages | length > 0
  tags:
    - rust
    - user-packages
