---
# Simplified package management - trust Ansible built-ins

# Ensure package facts are available (Linux only - macOS not supported)
- name: Gather package facts
  ansible.builtin.package_facts:
    manager: auto
  when: ansible_system == "Linux"

# =============================================================================
# APT REPOSITORY MANAGEMENT (UBUNTU/DEBIAN)
# =============================================================================

- name: Manage APT repositories (Ubuntu/Debian)
  ansible.builtin.include_tasks: manage-apt-repositories.yml
  vars:
    merged_apt_repositories: >-
      {{
        (vars.get('all_apt_repositories_' + ansible_distribution, []) | default([])) +
        (vars.get('group_apt_repositories_' + ansible_distribution, []) | default([])) +
        (vars.get('host_apt_repositories_' + ansible_distribution, []) | default([]))
        | unique | list
      }}
  when:
    - ansible_os_family == "Debian"
    - merged_apt_repositories | length > 0

# =============================================================================
# HOMEBREW SETUP (macOS) - Must come before package installation
# =============================================================================

- name: Setup Homebrew (macOS)
  ansible.builtin.include_tasks: manage-homebrew.yml
  when: ansible_system == "Darwin"
  tags:
    - homebrew
    - packages

# =============================================================================
# OFFICIAL REPOSITORY PACKAGES (ALL DISTRIBUTIONS)
# =============================================================================

- name: Install packages via Homebrew (macOS)
  community.general.homebrew:
    name: "{{ merged_packages_install }}"
    state: present
  when:
    - ansible_system == "Darwin"
    - merged_packages_install | length > 0
  vars:
    merged_packages_install: >-
      {{
        (vars.get('all_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('group_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('host_packages_install_' + ansible_distribution, []) | default([]))
        | unique | sort
      }}

- name: Install packages via system package manager (Linux)
  ansible.builtin.package:
    name: "{{ merged_packages_install }}"
    state: present
  become: true
  when:
    - ansible_system == "Linux"
    - merged_packages_install | length > 0
  vars:
    merged_packages_install: >-
      {{
        (vars.get('all_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('group_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('host_packages_install_' + ansible_distribution, []) | default([]))
        | unique | list
      }}

- name: Remove packages
  ansible.builtin.package:
    name: "{{ merged_packages_remove }}"
    state: absent
  become: true
  vars:
    merged_packages_remove: >-
      {{
        (vars.get('all_packages_remove_' + ansible_distribution, []) | default([])) +
        (vars.get('group_packages_remove_' + ansible_distribution, []) | default([])) +
        (vars.get('host_packages_remove_' + ansible_distribution, []) | default([]))
        | unique | list
      }}
  when: merged_packages_remove | length > 0

- name: Update package cache
  ansible.builtin.package:
    update_cache: true
  become: true
  when: packages_update_cache | default(true)

- name: Upgrade all packages (non-Arch)
  ansible.builtin.package:
    name: "*"
    state: latest
  become: true
  when:
    - packages_perform_system_upgrade | default(false)
    - ansible_distribution != "Archlinux"

- name: Upgrade all packages (Arch Linux)
  community.general.pacman:
    update_cache: false
    upgrade: true
  become: true
  when:
    - packages_perform_system_upgrade | default(false)
    - ansible_distribution == "Archlinux"

# =============================================================================
# ARCH LINUX AUR PACKAGES (OPTIONAL - SECURITY CONSIDERATION)
# =============================================================================

- name: Handle Arch Linux AUR packages
  block:
    - name: Set merged AUR packages variable
      ansible.builtin.set_fact:
        merged_aur_packages: >-
          {{
            (vars.get('all_packages_aur_install_' + ansible_distribution, []) | default([])) +
            (vars.get('group_packages_aur_install_' + ansible_distribution, []) | default([])) +
            (vars.get('host_packages_aur_install_' + ansible_distribution, []) | default([]))
            | unique | list
          }}

    - name: Install AUR packages if any configured
      block:
        - name: Check if paru is installed
          ansible.builtin.command: which paru
          register: paru_installed
          changed_when: false
          failed_when: false

        - name: Install paru from AUR
          block:
            - name: Install build dependencies for AUR packages
              ansible.builtin.package:
                name:
                  - base-devel
                  - git
                state: present
              become: true

            - name: Clone and install paru
              become: false
              block:
                - name: Clone paru repository
                  ansible.builtin.git:
                    repo: 'https://aur.archlinux.org/paru.git'
                    dest: '/tmp/paru-install'
                    version: master

                - name: Build and install paru
                  ansible.builtin.command:
                    cmd: makepkg -si --noconfirm
                    chdir: /tmp/paru-install
                  environment:
                    MAKEFLAGS: "-j{{ ansible_processor_vcpus | default(1) }}"

                - name: Clean up paru build directory
                  ansible.builtin.file:
                    path: /tmp/paru-install
                    state: absent
                  become: true
          when: paru_installed.rc != 0

        - name: Install AUR packages with paru
          become: false
          ansible.builtin.command:
            cmd: paru -S --noconfirm --needed {{ item }}
          loop: "{{ merged_aur_packages }}"
          register: aur_install_results
          changed_when: "'installing' in aur_install_results.stdout"
      when: merged_aur_packages | length > 0
  when:
    - ansible_distribution == "Archlinux"
    - packages_enable_aur | default(true)

# =============================================================================
# ARCH LINUX SPECIFIC CONFIGURATION
# =============================================================================

# Arch Linux specific: Configure reflector if installed
- name: Gather package facts (Arch Linux)
  ansible.builtin.package_facts:
    manager: pacman
  when: ansible_distribution == "Archlinux"

- name: Check if reflector is installed (Arch Linux)
  ansible.builtin.set_fact:
    reflector_installed: "{{ 'reflector' in ansible_facts.packages }}"
  when: ansible_distribution == "Archlinux"

- name: Configure reflector for mirror optimization (Arch Linux)
  block:
    - name: Ensure reflector config directory exists
      ansible.builtin.file:
        path: /etc/xdg/reflector
        state: directory
        owner: root
        group: root
        mode: '0755'
      become: true

    - name: Configure reflector
      ansible.builtin.template:
        src: reflector.conf.j2
        dest: /etc/xdg/reflector/reflector.conf
        owner: root
        group: root
        mode: '0644'
      become: true
      notify: restart reflector
  when:
    - ansible_distribution == "Archlinux"
    - reflector_installed | default(false)
    - config_archlinux_reflector | default(true)
  tags:
    - archlinux
    - mirrors
    - packages

# =============================================================================
# SNAP PACKAGE MANAGEMENT (Ubuntu/Debian)
# =============================================================================

- name: Manage Snap packages
  block:
    - name: Set merged snap package variables
      ansible.builtin.set_fact:
        merged_snap_packages: >-
          {{
            (all_packages_snap_packages | default([]) +
             group_packages_snap_packages | default([]) +
             host_packages_snap_packages | default([]) +
             packages_snap_packages | default([])) | unique
          }}
        merged_snap_classic_packages: >-
          {{
            (all_packages_snap_classic | default([]) +
             group_packages_snap_classic | default([]) +
             host_packages_snap_classic | default([]) +
             packages_snap_classic | default([])) | unique
          }}
        merged_snap_packages_remove: >-
          {{
            (all_packages_snap_packages_remove | default([]) +
             group_packages_snap_packages_remove | default([]) +
             host_packages_snap_packages_remove | default([]) +
             packages_snap_packages_remove | default([])) | unique
          }}
      tags: always

    - name: Install Snap packages
      community.general.snap:
        name: "{{ item }}"
        state: present
      loop: "{{ merged_snap_packages | default([]) }}"
      become: true
      when: merged_snap_packages | default([]) | length > 0

    - name: Install Snap packages with classic confinement
      community.general.snap:
        name: "{{ item }}"
        state: present
        classic: true
      loop: "{{ merged_snap_classic_packages | default([]) }}"
      become: true
      when: merged_snap_classic_packages | default([]) | length > 0

    - name: Remove Snap packages
      community.general.snap:
        name: "{{ item }}"
        state: absent
      loop: "{{ merged_snap_packages_remove | default([]) }}"
      become: true
      when: merged_snap_packages_remove | default([]) | length > 0

  when:
    - ansible_os_family == "Debian"
    - "'snapd' in ansible_facts.packages"
  tags:
    - snap
    - packages

# =============================================================================
# FLATPAK PACKAGE MANAGEMENT (Linux)
# =============================================================================

- name: Manage Flatpak packages
  block:
    - name: Set merged flatpak package variables
      ansible.builtin.set_fact:
        merged_flatpak_packages: >-
          {{
            (all_packages_flatpak_packages | default([]) +
             group_packages_flatpak_packages | default([]) +
             host_packages_flatpak_packages | default([]) +
             packages_flatpak_packages | default([])) | unique
          }}
        merged_flatpak_packages_remove: >-
          {{
            (all_packages_flatpak_packages_remove | default([]) +
             group_packages_flatpak_packages_remove | default([]) +
             host_packages_flatpak_packages_remove | default([]) +
             packages_flatpak_packages_remove | default([])) | unique
          }}
        merged_flatpak_remotes: >-
          {{
            (all_packages_flatpak_remotes | default([]) +
             group_packages_flatpak_remotes | default([]) +
             host_packages_flatpak_remotes | default([]) +
             packages_flatpak_remotes | default([])) | unique
          }}
      tags: always

    - name: Add Flatpak remotes
      community.general.flatpak_remote:
        name: "{{ item.name }}"
        state: present
        flatpakrepo_url: "{{ item.url }}"
        method: system
      loop: "{{ merged_flatpak_remotes | default([]) }}"
      become: true
      when: merged_flatpak_remotes | default([]) | length > 0

    - name: Install Flatpak packages
      community.general.flatpak:
        name: "{{ item }}"
        state: present
        method: system
      loop: "{{ merged_flatpak_packages | default([]) }}"
      become: true
      when: merged_flatpak_packages | default([]) | length > 0

    - name: Remove Flatpak packages
      community.general.flatpak:
        name: "{{ item }}"
        state: absent
        method: system
      loop: "{{ merged_flatpak_packages_remove | default([]) }}"
      become: true
      when: merged_flatpak_packages_remove | default([]) | length > 0

  when:
    - ansible_system == "Linux"
    - "'flatpak' in ansible_facts.packages"
  tags:
    - flatpak
    - packages

