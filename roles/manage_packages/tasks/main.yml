---
# Simplified package management - trust Ansible built-ins

- name: Install packages (hierarchical merge handled by Ansible precedence)
  ansible.builtin.package:
    name: "{{ merged_packages_install }}"
    state: present
  become: true
  vars:
    merged_packages_install: >-
      {{
        (vars.get('all_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('group_packages_install_' + ansible_distribution, []) | default([])) +
        (vars.get('host_packages_install_' + ansible_distribution, []) | default([]))
        | unique | list
      }}
  when: merged_packages_install | length > 0

- name: Remove packages
  ansible.builtin.package:
    name: "{{ merged_packages_remove }}"
    state: absent
  become: true
  vars:
    merged_packages_remove: >-
      {{
        (vars.get('all_packages_remove_' + ansible_distribution, []) | default([])) +
        (vars.get('group_packages_remove_' + ansible_distribution, []) | default([])) +
        (vars.get('host_packages_remove_' + ansible_distribution, []) | default([]))
        | unique | list
      }}
  when: merged_packages_remove | length > 0

- name: Update package cache
  ansible.builtin.package:
    update_cache: true
  become: true
  when: packages_update_cache | default(true)

- name: Upgrade all packages
  ansible.builtin.package:
    name: "*"
    state: latest
  become: true
  when: packages_perform_system_upgrade | default(false)
