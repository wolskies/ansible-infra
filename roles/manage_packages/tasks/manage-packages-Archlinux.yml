---
# REQ-MP-001: Combine packages from different inventory levels
- name: Combine packages from all inventory levels
  ansible.builtin.set_fact:
    _final_packages: >-
      {{
        (manage_packages_all | default({})) |
        combine(manage_packages_group | default({}), list_merge='append') |
        combine(manage_packages_host | default({}), list_merge='append')
      }}

- name: Upgrade all Pacman packages
  community.general.pacman:
    update_cache: false
    upgrade: true
  become: true
  tags:
    - upgrades

# Branch based on AUR enablement
- name: Manage packages (AUR disabled - pacman only)
  community.general.pacman:
    name: "{{ item.name }}"
    state: "{{ item.state | default('present') }}"
    update_cache: true
  loop: "{{ _final_packages[ansible_os_family] | default([]) }}"
  become: true
  when:
    - _final_packages[ansible_os_family] | default([]) | length > 0
    - not (pacman.enable_aur | default(false))

- name: Install packages (AUR enabled)
  block:
    - name: Ensure ansible_user can run pacman without password
      ansible.builtin.lineinfile:
        path: "/etc/sudoers.d/11-install-{{ ansible_user_id }}"
        line: "{{ ansible_user_id }} ALL=(ALL) NOPASSWD: /usr/bin/pacman"
        create: yes
        mode: "0644"
        validate: "visudo -cf %s"
      become: true

    - name: Ensure base-devel group is installed (required for AUR building)
      community.general.pacman:
        name: base-devel
        state: present
        update_cache: true
      become: true

    - name: Bootstrap AUR helper (paru) if needed
      kewlfft.aur.aur:
        name: paru
        state: present
        use: auto # Will bootstrap using available method
      become: false # Run as ansible_user, not root
      tags:
        - no-container
        - aur

    - name: Manage packages via kewlfft.aur module using paru for ALL packages
      kewlfft.aur.aur:
        name: "{{ item.name }}"
        state: "{{ item.state | default('present') }}"
        use: paru # Use paru for both official and AUR packages
      loop: "{{ _final_packages[ansible_os_family] | default([]) }}"
      become: false # Run as ansible_user, not root
      tags:
        - no-container
        - aur
  when:
    - _final_packages[ansible_os_family] | default([]) | length > 0
    - pacman.enable_aur | default(false)

- name: Gather package facts (Arch Linux)
  ansible.builtin.package_facts:
    manager: pacman
  when: manage_packages[ansible_os_family] | default([]) | length > 0
