---
# Update package sources and caches
# Platform-specific cache updates with proper timing

# =============================================================================
# UBUNTU/DEBIAN: APT CACHE UPDATE
# =============================================================================

- name: Update APT cache (Ubuntu/Debian)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ packages_cache_valid_time | default(3600) }}"
  become: true
  when:
    - ansible_distribution in ['Ubuntu', 'Debian']
    - packages_update_cache | default(true)
  tags:
    - cache
    - apt
    - updates

# =============================================================================
# ARCH LINUX: PACMAN CACHE UPDATE
# =============================================================================

- name: Update pacman cache (Arch Linux)
  community.general.pacman:
    update_cache: true
  become: true
  when:
    - ansible_distribution == 'Archlinux'
    - packages_update_cache | default(true)
  tags:
    - cache
    - pacman
    - updates

# =============================================================================
# MACOS: HOMEBREW UPDATE
# =============================================================================

- name: Update Homebrew (macOS)
  community.general.homebrew:
    update_homebrew: true
  when:
    - ansible_distribution == 'MacOSX'
    - packages_macos_update_homebrew | default(true)
  register: homebrew_update
  tags:
    - cache
    - homebrew
    - updates

- name: Display Homebrew update results
  ansible.builtin.debug:
    msg: "Homebrew updated successfully"
  when:
    - ansible_distribution == 'MacOSX'
    - homebrew_update is defined
    - homebrew_update.changed
    - ansible_verbosity >= 1
  tags:
    - cache
    - homebrew
