---
- name: Merge APT repositories from all sources
  ansible.builtin.set_fact:
    merged_apt_repositories: >-
      {{
        (infrastructure.host.packages.repositories.all.ansible_distribution | default([])) +
        (infrastructure.host.packages.repositories.group.ansible_distribution | default([])) +
        (infrastructure.host.packages.repositories.host.ansible_distribution | default([]))
        | unique | list
      }}

- name: Manage APT repositories
  block:
    - name: Ensure old apt keys are not present in trusted.gpg.d
      ansible.builtin.file:
        path: "/etc/apt/trusted.gpg.d/{{ item.name }}.asc"
        state: absent
      loop: "{{ merged_apt_repositories }}"
      become: true

    - name: Ensure old apt source lists are not present in sources.list.d
      ansible.builtin.file:
        path: "/etc/apt/sources.list.d/{{ file_item }}"
        state: absent
      loop: >-
        {%- set files = [] -%}
        {%- for repo in merged_apt_repositories -%}
          {%- set _ = files.append(repo.name + '.list') -%}
          {%- set _ = files.append(repo.name | replace('_', '-') + '.list') -%}
          {%- set _ = files.append('download_' + repo.name | replace('.', '_') + '.list') -%}
        {%- endfor -%}
        {{ files | unique }}
      loop_control:
        loop_var: file_item
      become: true

    - name: Ensure APT repository dependencies are installed
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - python3-debian
          - gnupg
        state: present
        update_cache: true
        cache_valid_time: 3600
      become: true

    - name: Add or remove APT repositories
      ansible.builtin.deb822_repository:
        name: "{{ item.name }}"
        types: "{{ item.types | default('deb') }}"
        uris: "{{ item.uris }}"
        suites: "{{ item.suites }}"
        components: "{{ item.components | default(['main']) }}"
        signed_by: "{{ item.signed_by | default(omit) }}"
        state: "{{ item.state | default('present') }}"
      loop: "{{ merged_apt_repositories }}"
      become: true
      register: repositories_changed

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: "{{ infrastructure.host.packages.apt.apt_cache.update_cache | default(true) }}"
    cache_valid_time: "{{ infrastructure.host.packages.apt.apt_cache.valid_time | default(3600) }}"
  become: true
  when: infrastructure.host.packages.apt.apt_cache.update_cache | default(true)

- name: Remove packages via APT
  ansible.builtin.apt:
    name: "{{ merged_apt_packages_remove }}"
    state: absent
  become: true
  when: merged_packages_remove | length > 0

- name: Install packages via APT
  ansible.builtin.apt:
    name: "{{ merged_apt_packages_install }}"
    state: present
  become: true
  when: merged_packages_install | length > 0

- name: Upgrade all APT packages
  ansible.builtin.apt:
    upgrade: "{{ infrastructure.host.packages.apt.system_upgrade.type | default('safe') }}"
  become: true
  when: infrastructure.host.packages.apt.system_upgrade.enable | default(false)

- name: Gather package facts (Debian family)
  ansible.builtin.package_facts:
    manager: auto