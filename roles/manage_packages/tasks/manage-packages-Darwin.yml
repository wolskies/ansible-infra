---
# REQ-MP-001: Combine packages from different inventory levels
- name: Combine packages from all inventory levels
  ansible.builtin.set_fact:
    _final_packages: >-
      {{
        (manage_packages_all | default({})) |
        combine(manage_packages_group | default({}), list_merge='append') |
        combine(manage_packages_host | default({}), list_merge='append')
      }}

# Build lists for geerlingguy.mac.homebrew role compatibility
- name: Build Homebrew package lists
  ansible.builtin.set_fact:
    homebrew_packages_install: >-
      {{
        _final_packages[ansible_os_family] | default([])
        | selectattr('state', 'undefined') | map(attribute='name') | list +
        _final_packages[ansible_os_family] | default([])
        | selectattr('state', 'defined') | selectattr('state', 'eq', 'present')
        | map(attribute='name') | list
      }}
    homebrew_packages_remove: >-
      {{
        _final_packages[ansible_os_family] | default([])
        | selectattr('state', 'defined') | selectattr('state', 'eq', 'absent')
        | map(attribute='name') | list
      }}
    homebrew_casks_install: >-
      {{
        manage_casks[ansible_os_family] | default([])
        | selectattr('state', 'undefined') | map(attribute='name') | list +
        manage_casks[ansible_os_family] | default([])
        | selectattr('state', 'defined') | selectattr('state', 'eq', 'present')
        | map(attribute='name') | list
      }}
    homebrew_casks_remove: >-
      {{
        manage_casks[ansible_os_family] | default([])
        | selectattr('state', 'defined') | selectattr('state', 'eq', 'absent')
        | map(attribute='name') | list
      }}
  tags:
    - packages

- name: Install and manage packages via Homebrew
  ansible.builtin.include_role:
    name: geerlingguy.mac.homebrew
  vars:
    homebrew_installed_packages: "{{ homebrew_packages_install }}"
    homebrew_uninstalled_packages: "{{ homebrew_packages_remove }}"
    homebrew_cask_apps: "{{ homebrew_casks_install }}"
    homebrew_cask_uninstalled_apps: "{{ homebrew_casks_remove }}"
    homebrew_cask_appdir: /Applications
    homebrew_taps: "{{ homebrew.taps | default([]) }}"
    homebrew_clear_cache: "{{ homebrew.cleanup_cache | default(false) }}"
  tags:
    - packages
    - repositories
