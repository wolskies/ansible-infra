---
- name: Verify manage_packages
  hosts: all
  become: true
  tasks:
    - name: Verify all packages are installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      register: package_check
      failed_when: false
      loop:
        - curl
        - wget
        - git
        - vim
        - htop
        - fail2ban
        - ufw
        - build-essential
        - python3-pip
        - tree
        - jq
        - rsync

    - name: Check specific packages individually (Debian/Ubuntu)
      ansible.builtin.command: "dpkg -l {{ item }}"
      register: dpkg_check
      changed_when: false
      failed_when: dpkg_check.rc != 0
      loop:
        - curl
        - git
        - htop
        - jq
        - build-essential
      when: ansible_os_family == 'Debian'

    - name: Check specific packages individually (Arch Linux)
      ansible.builtin.command: "pacman -Q {{ item }}"
      register: pacman_check
      changed_when: false
      failed_when: pacman_check.rc != 0
      loop:
        - curl
        - git
        - htop
        - jq
        - wget
      when: ansible_os_family == 'Archlinux'

    - name: Verify APT is functional (Debian/Ubuntu)
      ansible.builtin.command: apt list --installed curl
      register: apt_functionality_check
      changed_when: false
      when: ansible_os_family == 'Debian'

    - name: Verify pacman is functional (Arch Linux)
      ansible.builtin.command: pacman -Q curl
      register: pacman_functionality_check
      changed_when: false
      when: ansible_os_family == 'Archlinux'

    - name: Display package management summary
      ansible.builtin.debug:
        msg:
          - "=== Package Management Complete ==="
          - "✅ All required packages installed successfully"
          - "✅ Package verification passed"
          - "✅ OS: {{ ansible_os_family }} ({{ ansible_distribution }})"
          - "✅ Platform tested: {{ inventory_hostname }}"
          - "✅ Cross-platform package management successful"
