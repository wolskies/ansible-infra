---
# macOS security services configuration

- name: Ensure macOS Application Layer Firewall configuration
  block:
    - name: Check current firewall state
      ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate
      register: macos_firewall_state_result
      changed_when: false
      become: true

    - name: Ensure macOS Application Layer Firewall state
      ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate {{ 'on' if security_firewall_common.start else 'off' }}
      become: true
      register: macos_firewall_enable_result
      changed_when: >-
        (security_firewall_common.start and 'Firewall is enabled' not in macos_firewall_state_result.stdout) or
        (not security_firewall_common.start and 'Firewall is enabled' in macos_firewall_state_result.stdout)
      when: security_firewall_common.start is defined

    - name: Ensure stealth mode configuration
      ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setstealthmode {{ 'on' if security_firewall_macosx.stealth_mode else 'off' }}
      become: true
      register: macos_stealth_result
      changed_when: macos_stealth_result.rc == 0
      when: security_firewall_macosx.stealth_mode is defined

    - name: Ensure block all setting
      ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setblockall {{ 'on' if security_firewall_macosx.block_all else 'off' }}
      become: true
      register: macos_blockall_result
      changed_when: macos_blockall_result.rc == 0
      when: security_firewall_macosx.block_all is defined

    - name: Ensure firewall logging configuration
      ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setloggingmode {{ 'on' if security_firewall_macosx.logging else 'off' }}
      become: true
      register: macos_logging_result
      changed_when: macos_logging_result.rc == 0
      when: security_firewall_macosx.logging is defined

  when: security_firewall_common.enabled | default(true)
  tags:
    - macos
    - firewall
    - security
