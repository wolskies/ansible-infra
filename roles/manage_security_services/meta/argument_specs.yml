---
# Manage Security Services Role Argument Specification
# This role handles firewall configuration and intrusion prevention services

argument_specs:
  main:
    short_description: Configure firewall and intrusion prevention services
    description:
      - Handles firewall configuration on Linux (UFW) and macOS (Application Layer Firewall)
      - Manages intrusion prevention services (fail2ban on Linux)
      - Automatically detects and protects SSH access during firewall operations
      - Configures firewall rules, stealth mode, and logging options
      - Uses collection-wide variables for consistent security configuration

    options:
      # Firewall Configuration
      firewall:
        description:
          - Firewall configuration and management options
          - Controls UFW on Linux and Application Layer Firewall on macOS
        type: dict
        required: false
        default: {}
        options:
          enabled:
            description: Enable firewall service and rule management
            type: bool
            required: false
            default: false
          prevent_ssh_lockout:
            description: Automatically detect and protect SSH access during firewall operations
            type: bool
            required: false
            default: true
          rules:
            description: List of firewall rule definitions
            type: list
            elements: dict
            required: false
            default: []
            options:
              port:
                description: Port number or range (e.g., 22, "8080:8090")
                type: raw
                required: true
              protocol:
                description: Protocol type
                type: str
                required: false
                default: "tcp"
                choices: ["tcp", "udp", "any"]
              rule:
                description: Rule action
                type: str
                required: false
                default: "allow"
                choices: ["allow", "deny"]
              source:
                description: Source IP/CIDR (e.g., "192.168.1.0/24", "any")
                type: str
                required: false
                default: "any"
              destination:
                description: Destination IP/CIDR
                type: str
                required: false
                default: "any"
              comment:
                description: Rule description
                type: str
                required: false
                default: ""
          stealth_mode:
            description: Enable stealth mode on macOS Application Layer Firewall (don't respond to pings)
            type: bool
            required: false
            default: false
          block_all:
            description: Block all incoming connections on macOS (except essential services)
            type: bool
            required: false
            default: false
          logging:
            description: Enable firewall logging on macOS Application Layer Firewall
            type: bool
            required: false
            default: false

      # Fail2ban Configuration
      fail2ban:
        description:
          - Fail2ban intrusion prevention configuration
          - Linux-only service for protecting against brute force attacks
        type: dict
        required: false
        default: {}
        options:
          enabled:
            description: Enable fail2ban intrusion prevention service
            type: bool
            required: false
            default: false
          bantime:
            description: Duration for which IP is banned (e.g., "10m", "1h", "1d")
            type: str
            required: false
            default: "10m"
          findtime:
            description: Time window for counting failures (e.g., "10m", "1h")
            type: str
            required: false
            default: "10m"
          maxretry:
            description: Number of failures before IP is banned
            type: int
            required: false
            default: 5
          jails:
            description: List of fail2ban jail configurations
            type: list
            elements: dict
            required: false
            default: []
            options:
              name:
                description: Jail name (e.g., "sshd", "apache-auth", "nginx-http-auth")
                type: str
                required: true
              enabled:
                description: Whether this jail is active
                type: bool
                required: false
                default: true
              port:
                description: Port(s) to monitor (e.g., "ssh", "http,https", "22")
                type: str
                required: false
              filter:
                description: Filter name to use (defaults to jail name)
                type: str
                required: false
              logpath:
                description: Log file path to monitor (e.g., "/var/log/auth.log")
                type: str
                required: true
              maxretry:
                description: Override global maxretry for this jail
                type: int
                required: false
              bantime:
                description: Override global bantime for this jail (e.g., "1h", "1d")
                type: str
                required: false
              findtime:
                description: Override global findtime for this jail
                type: str
                required: false
              action:
                description: Ban action (e.g., "iptables", "iptables-multiport", "ufw")
                type: str
                required: false
                default: "iptables"
