---
# handlers file for manage_security_services

- name: restart fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: restarted
  become: true
  when: ansible_system == 'Linux'

- name: reload fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: reloaded
  become: true
  when: ansible_system == 'Linux'

- name: reload ufw
  block:
    - name: Ensure SSH access before firewall reload (prevent lockout)
      community.general.ufw:
        rule: allow
        port: "{{ current_ssh_port }}"
        proto: tcp
        comment: "SSH access (prevent lockout) - port {{ current_ssh_port }}"
      become: true
      when:
        - firewall.prevent_ssh_lockout | default(true)
        - current_ssh_port is defined

    - name: Reload UFW firewall
      community.general.ufw:
        state: reloaded
      become: true
  become: true
  when: ansible_system == 'Linux'
