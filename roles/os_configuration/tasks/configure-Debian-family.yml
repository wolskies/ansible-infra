---

- name: Manage snap packages
  ansible.builtin.include_role:
    name: wolskinet.infrastructure.manage_snap_packages
  vars:
    snap_management_action: "purge"
    snap_purge_confirm: "{{ config_debian_family.snap.remove_completely }}"
  when: config_debian_family.snap.remove_completely | default(false)
  tags:
    - snap
    - cleanup

- name: Configure APT unattended upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  become: true
  when: config_debian_family.unattended_upgrades.enabled | default(true)
  tags:
    - updates
    - security

- name: Debian family system optimizations
  block:
    - name: Disable unnecessary services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
      loop: "{{ config_debian_family.services.unnecessary_services }}"
      become: true
      when: config_debian_family.services.disable_unnecessary | default(false)
      failed_when: false

    - name: Configure vm.swappiness
      ansible.posix.sysctl:
        name: vm.swappiness
        value: "{{ config_debian_family.optimizations.swappiness | default(10) }}"
        state: present
        reload: true
      become: true
      when: config_debian_family.optimizations.tune_swappiness | default(false)
  tags:
    - optimization


- name: Configure APT behavior
  block:
    - name: Configure APT to not install recommends
      ansible.builtin.copy:
        content: |
          APT::Install-Recommends "false";
          APT::Install-Suggests "false";
        dest: /etc/apt/apt.conf.d/99-no-recommends
        owner: root
        group: root
        mode: '0644'
      become: true
      when: config_debian_family.apt.no_recommends | default(false)

    - name: Configure APT proxy
      ansible.builtin.copy:
        content: |
          Acquire::http::Proxy "{{ config_debian_family.apt.proxy }}";
          Acquire::https::Proxy "{{ config_debian_family.apt.proxy }}";
        dest: /etc/apt/apt.conf.d/99-proxy
        owner: root
        group: root
        mode: '0644'
      become: true
      when: config_debian_family.apt.proxy != ""
  tags:
    - apt
    - packages
