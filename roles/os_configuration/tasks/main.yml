---
- name: Configure system hostname
  ansible.builtin.hostname:
    name: "{{ infrastructure.host.hostname }}"
  become: true
  when:
    - infrastructure.host.hostname | length > 0
    - not (molecule_test | default(false)) # Skip in molecule container tests
  tags:
    - hostname
    - os-configuration

- name: Set system timezone
  community.general.timezone:
    name: "{{ infrastructure.domain.timezone }}"
  become: true
  when:
    - infrastructure.domain.timezone is defined
    - infrastructure.domain.timezone | length > 0
  tags:
    - timezone
    - os-configuration

- name: Update /etc/hosts file
  block:
    - name: Backup /etc/hosts before modification
      ansible.builtin.copy:
        src: /etc/hosts
        dest: /etc/hosts.backup.{{ ansible_date_time.epoch }}
        owner: root
        group: "{{ 'wheel' if ansible_system == 'Darwin' else 'root' }}"
        mode: "0644"
        remote_src: true
      become: true

    - name: Update /etc/hosts - Add FQDN and hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1\s+.*{{ infrastructure.host.hostname | regex_escape }}.*'
        line: "127.0.0.1\tlocalhost {{ infrastructure.host.hostname }}.{{ infrastructure.domain.name }} {{ infrastructure.host.hostname }}"
        create: false
      become: true
  when:
    - infrastructure.host.update_hosts | default(false)
    - infrastructure.host.hostname | length > 0
    - infrastructure.domain.name is defined
    - infrastructure.domain.name | length > 0

- name: Include OS-specific configuration
  ansible.builtin.include_tasks: configure-{{ ansible_system }}.yml
  tags:
    - os-configuration
