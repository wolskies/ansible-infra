---
- name: Validate supported OS versions
  ansible.builtin.fail:
    msg: |
      {{ ansible_distribution }} {{ ansible_distribution_version }} is not supported.
      Supported distributions: Ubuntu 22+, Debian 12+, Arch Linux, macOS
  when:
    - (ansible_distribution == "Ubuntu" and ansible_distribution_major_version | int < 22) or
      (ansible_distribution == "Debian" and ansible_distribution_major_version | int < 12) or
      (ansible_distribution not in ["Archlinux", "Ubuntu", "Debian", "MacOSX"])
  tags:
    - always
    - validation

- name: Set hostname configuration facts
  ansible.builtin.set_fact:
    _hostname: "{{ config_common_hostname if config_common_hostname != '' else ansible_hostname }}"
    _domain: "{{ config_common_domain if config_common_domain != '' else 'localdomain' }}"
    _hostname_changed: "{{ (config_common_hostname != '' and config_common_hostname != ansible_hostname) | bool }}"
    _domain_changed: "{{ (config_common_domain != '') | bool }}"
  when: (config_common_hostname != "") or (config_common_domain != "")
  tags:
    - hostname
    - os-configuration

- name: Set FQDN fact
  ansible.builtin.set_fact:
    _fqdn: "{{ _hostname }}.{{ _domain }}"
  when: (config_common_hostname != "") or (config_common_domain != "")
  tags:
    - hostname
    - os-configuration

- name: Validate hostname format
  ansible.builtin.fail:
    msg: "Invalid hostname '{{ _hostname }}'. Hostname must contain only letters, numbers, and hyphens, and cannot start or end with a hyphen."
  when:
    - (config_common_hostname != "") or (config_common_domain != "")
    - _hostname_changed
    - not _hostname is match('^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$')
  tags:
    - hostname
    - validation
    - os-configuration

- name: Validate domain format
  ansible.builtin.fail:
    msg: "Invalid domain '{{ _domain }}'. Domain must be a valid DNS domain name."
  when:
    - (config_common_hostname != "") or (config_common_domain != "")
    - _domain_changed
    - _domain != 'localdomain'
    - not _domain is match('^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)*[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$')
  tags:
    - hostname
    - validation
    - os-configuration

- name: Set system timezone
  community.general.timezone:
    name: "{{ config_common_timezone }}"
  become: true
  when: config_common_timezone != ""
  tags:
    - timezone
    - os-configuration

- name: Include Linux common configurations
  ansible.builtin.include_tasks: configure-linux-common.yml
  when: ansible_system == 'Linux'
  tags:
    - linux
    - os-configuration

- name: Include Debian family configuration
  ansible.builtin.include_tasks: configure-Debian-family.yml
  when: ansible_distribution in ['Ubuntu', 'Debian']
  tags:
    - os-specific
    - os-configuration

- name: Include distribution-specific configuration
  ansible.builtin.include_tasks: "configure-{{ ansible_distribution }}.yml"
  when: ansible_distribution in ['Archlinux', 'MacOSX']
  tags:
    - os-specific
    - os-configuration
