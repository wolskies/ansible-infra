---
- name: Configure system hostname
  ansible.builtin.hostname:
    name: "{{ host_hostname }}"
  become: true
  when:
    - host_hostname is defined
    - host_hostname | length > 0
  tags:
    - hostname
    - os-configuration

- name: Set system timezone
  community.general.timezone:
    name: "{{ domain_timezone }}"
  become: true
  when:
    - domain_timezone is defined
    - domain_timezone | length > 0
  tags:
    - timezone
    - os-configuration

- name: Update /etc/hosts file
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1\s+.*{{ host_hostname | regex_escape }}.*'
    line: "127.0.0.1\tlocalhost {{ host_hostname }}.{{ domain_name }} {{ host_hostname }}"
    create: false
    backup: true
  become: true
  when:
    - host_update_hosts | default(false)
    - host_hostname is defined
    - host_hostname | length > 0
    - domain_name is defined
    - domain_name | length > 0

- name: Include user management tasks
  ansible.builtin.include_tasks: users.yml
  when: (users is defined and users | length > 0) or (users_absent is defined and users_absent | length > 0)
  tags:
    - users
    - os-configuration

- name: Include OS-specific configuration
  ansible.builtin.include_tasks: configure-{{ ansible_system }}.yml
  tags:
    - os-configuration
