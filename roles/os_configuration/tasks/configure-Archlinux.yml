---
- name: Configure Pacman behavior
  block:
    - name: Configure pacman to skip confirms
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: "^#?NoConfirm"
        line: "NoConfirm"
        state: present
      become: true
      when:
        - infrastructure.host.packages is defined
        - infrastructure.host.packages.pacman is defined
        - infrastructure.host.packages.pacman.no_confirms | default(false)

    - name: Configure multilib repository
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: "^#?\\[multilib\\]"
        line: "[multilib]"
        state: present
      become: true
      when:
        - infrastructure.host.packages is defined
        - infrastructure.host.packages.pacman is defined
        - infrastructure.host.packages.pacman.multilib | default(false)

    - name: Enable multilib repository Include line
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: "^#?Include = /etc/pacman.d/mirrorlist"
        line: "Include = /etc/pacman.d/mirrorlist"
        insertafter: "^\\[multilib\\]"
        state: present
      become: true
      when:
        - infrastructure.host.packages is defined
        - infrastructure.host.packages.pacman is defined
        - infrastructure.host.packages.pacman.multilib | default(false)

    - name: Configure pacman proxy
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: "^#?Server.*{{ infrastructure.host.packages.pacman.proxy | regex_escape }}"
        insertafter: '^\\[.*\\]'
        line: "Server = {{ infrastructure.host.packages.pacman.proxy }}/$repo/os/$arch"
        state: present
      become: true
      when:
        - infrastructure.host.packages is defined
        - infrastructure.host.packages.pacman is defined
        - infrastructure.host.packages.pacman.proxy is defined
        - infrastructure.host.packages.pacman.proxy | length > 0
  tags:
    - pacman
    - packages
