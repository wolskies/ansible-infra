---
- name: Configure Darwin locale
  block:
    - name: Set system locale
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleLocale
        type: string
        value: "{{ infrastructure.domain.locale.split('.')[0] }}"
      when:
        - infrastructure.domain.locale is defined
      notify: restart cfprefsd

    - name: Set preferred languages
      community.general.osx_defaults:
        domain: NSGlobalDomain
        key: AppleLanguages
        type: array
        value:
          - "{{ infrastructure.domain.language.split('.')[0] }}"
      when:
        - infrastructure.domain.language is defined
      notify: restart cfprefsd
  tags:
    - locale
    - language
    - Darwin

- name: Configure Darwin NTP time synchronization
  block:
    - name: Check current NTP server configuration
      ansible.builtin.command: systemsetup -getnetworktimeserver
      register: current_ntp_server
      changed_when: false
      become: true

    - name: Enable network time synchronization
      ansible.builtin.command: systemsetup -setusingnetworktime on
      become: true
      register: ntp_enable_result
      changed_when: "'Network Time' in ntp_enable_result.stderr or ntp_enable_result.rc == 0"
      when:
        - infrastructure.domain.ntp.enabled

    - name: Set NTP server (first server from list)
      ansible.builtin.command: "systemsetup -setnetworktimeserver {{ infrastructure.domain.ntp.servers[0] }}"
      become: true
      register: ntp_server_result
      changed_when: ntp_server_result.rc == 0
      when:
        - infrastructure.domain.ntp.enabled
        - infrastructure.domain.ntp.servers | length > 0
        - infrastructure.domain.ntp.servers[0] not in current_ntp_server.stdout

    - name: Disable network time synchronization
      ansible.builtin.command: systemsetup -setusingnetworktime off
      become: true
      register: ntp_disable_result
      changed_when: "'Network Time' in ntp_disable_result.stderr or ntp_disable_result.rc == 0"
      when:
        - not infrastructure.domain.ntp.enabled
  tags:
    - ntp
    - time
    - Darwin

- name: Configure Darwin automatic updates
  community.general.osx_defaults:
    domain: /Library/Preferences/com.apple.SoftwareUpdate
    key: "{{ item.key }}"
    type: bool
    value: "{{ item.value }}"
  loop:
    - key: "AutomaticCheckEnabled"
      value: "{{ infrastructure.host.macosx.updates.auto_check | default(true) }}"
    - key: "AutomaticDownload"
      value: "{{ infrastructure.host.macosx.updates.auto_download | default(true) }}"
  become: true
  notify: restart cfprefsd
  when:
    - infrastructure.host.macosx.updates is defined
  tags:
    - Darwin
    - updates
    - system

- name: Configure macOS Gatekeeper
  ansible.builtin.command:
    cmd: "spctl --master-{{ infrastructure.host.macosx.gatekeeper.enabled | default(true) | ternary('enable', 'disable') }}"
  become: true
  register: gatekeeper_result
  changed_when: gatekeeper_result.rc == 0
  when:
    - infrastructure.host.macosx.gatekeeper is defined
  tags:
    - Darwin
    - security
    - gatekeeper
