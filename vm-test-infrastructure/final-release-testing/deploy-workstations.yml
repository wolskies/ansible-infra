---
# Final Release Testing - Workstation Configuration Deployment
# Applies comprehensive development environment to workstation VMs

- name: Configure Workstation Systems
  hosts: workstations
  become: true
  gather_facts: true
  vars_files:
    - test-scenarios/workstation-config.yml
    - ../inventory/group_vars/all/vault.yml # Vault-encrypted passwords

  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300
        delay: 10

    - name: Update package cache
      package:
        update_cache: yes
      when: ansible_pkg_mgr in ['apt', 'pacman']

    - name: Display test scenario info
      debug:
        msg:
          - "=== Final Release Testing - Workstation Configuration ==="
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Platform: {{ ansible_architecture }}"
          - "Test Type: Workstation Configuration"
          - "Users: {{ users | map(attribute='name') | list | join(', ') }}"
          - "Development Tools: Node.js, Rust, Go, Neovim"

  roles:
    # Core system configuration
    - wolskies.infrastructure.os_configuration

    # Package management
    - wolskies.infrastructure.manage_packages

    # User management (handles dev tools automatically)
    # configure_users will call nodejs, rust, go, neovim, terminal_config internally
    - wolskies.infrastructure.configure_users

    # Package system management
    - wolskies.infrastructure.manage_snap_packages
    - wolskies.infrastructure.manage_flatpak

  post_tasks:
    - name: Verify development tools installation
      command: "{{ item }}"
      loop:
        - "node --version"
        - "npm --version"
        - "rustc --version"
        - "cargo --version"
        - "go version"
        - "nvim --version"
      become_user: "{{ users[0].name }}"
      ignore_errors: yes
      register: dev_tools_check

    - name: Display deployment summary
      debug:
        msg:
          - "=== Workstation Configuration Deployment Complete ==="
          - "Host: {{ inventory_hostname }}"
          - "Users configured: {{ users | map(attribute='name') | list | join(', ') }}"
          - "Development tools installed per user configuration"
          - "Ready for discovery validation"
