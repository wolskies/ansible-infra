---
# Server Configuration Validation Tasks
# Compares discovery results against expected server configuration

- name: Load discovery results for {{ host_name }}
  ansible.builtin.set_fact:
    actual_config: "{{ lookup('file', 'inventory/host_vars/' + host_name + '/vars.yml', errors='ignore') | default('{}', true) | from_yaml }}"
  failed_when: false

- name: Initialize validation result for {{ host_name }}
  ansible.builtin.set_fact:
    host_validation:
      hostname: "{{ host_name }}"
      type: "server"
      status: "unknown"
      checks: []
      passed: 0
      failed: 0
      errors: []

- name: Validate timezone configuration
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'checks': host_validation.checks + [{
          'test': 'timezone',
          'expected': expected_config.domain_timezone,
          'actual': actual_config.get('domain_timezone', 'not_found'),
          'passed': (actual_config.get('domain_timezone', '') == expected_config.domain_timezone)
        }]
      }) }}
  when: actual_config is defined

- name: Validate target user creation
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'checks': host_validation.checks + [{
          'test': 'target_user',
          'expected': expected_config.users[0].name,
          'actual': actual_config.get('users', []) | map(attribute='name') | list,
          'passed': (expected_config.users[0].name in (actual_config.get('users', []) | map(attribute='name') | list))
        }]
      }) }}
  when: actual_config is defined and expected_config.users | length > 0

- name: Validate firewall configuration
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'checks': host_validation.checks + [{
          'test': 'firewall_enabled',
          'expected': expected_config.get('firewall', {}).get('enabled', false),
          'actual': actual_config.get('firewall', {}).get('enabled', false),
          'passed': (actual_config.get('firewall', {}).get('enabled', false) == expected_config.get('firewall', {}).get('enabled', false))
        }]
      }) }}
  when: actual_config is defined

- name: Validate fail2ban configuration
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'checks': host_validation.checks + [{
          'test': 'fail2ban_enabled',
          'expected': expected_config.get('fail2ban', {}).get('enabled', false),
          'actual': actual_config.get('fail2ban', {}).get('enabled', false),
          'passed': (actual_config.get('fail2ban', {}).get('enabled', false) == expected_config.get('fail2ban', {}).get('enabled', false))
        }]
      }) }}
  when: actual_config is defined

- name: Validate sample server packages
  # This test verifies that the package management system is working by checking
  # for a few representative packages from the config. Not meant to be exhaustive.
  ansible.builtin.set_fact:
    sample_packages: ["nginx", "fail2ban", "ufw"]
    installed_packages: "{{ actual_config.get('packages', {}).get('present', {}).get('host', {}).values() | list | flatten | map(attribute='name') | list }}"
  when: actual_config is defined

- name: Check sample packages installed
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'checks': host_validation.checks + [{
          'test': 'sample_packages_installed',
          'expected': sample_packages,
          'actual': installed_packages | intersect(sample_packages),
          'passed': (sample_packages | difference(installed_packages) | length == 0)
        }]
      }) }}
  when: actual_config is defined

- name: Calculate validation summary
  ansible.builtin.set_fact:
    host_validation: >
      {{ host_validation | combine({
        'passed': host_validation.checks | selectattr('passed') | list | length,
        'failed': host_validation.checks | rejectattr('passed') | list | length,
        'status': 'pass' if (host_validation.checks | rejectattr('passed') | list | length == 0) else 'fail'
      }) }}

- name: Add host validation to results
  ansible.builtin.set_fact:
    validation_results: "{{ validation_results + [host_validation] }}"

- name: Display server validation result for {{ host_name }}
  ansible.builtin.debug:
    msg:
      - "Server {{ host_name }}: {{ host_validation.status | upper }}"
      - "Passed: {{ host_validation.passed }}/{{ host_validation.checks | length }}"
      - "Failed checks: {{ host_validation.checks | rejectattr('passed') | map(attribute='test') | list }}"
