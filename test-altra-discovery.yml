---
# Discovery test for altra machine
- name: Run Infrastructure Discovery on Altra
  hosts: altra
  gather_facts: true
  collections:
    - community.general

  vars:
    discovery_output_dir: "./altra-discovery-output"
    target_hostname: "altra"

  tasks:
    - name: Test connectivity
      ansible.builtin.ping:

    - name: Display target machine info
      ansible.builtin.debug:
        msg:
          - "=== Discovering Infrastructure on Altra ==="
          - "Target: {{ inventory_hostname }}"
          - "IP: {{ ansible_host }}"
          - "User: {{ ansible_user }}"

    - name: Run discovery role
      ansible.builtin.include_role:
        name: roles/discovery
      vars:
        discovery:
          output_dir: "{{ discovery_output_dir }}"
          generate_configs: true
          include_sensitive: false
          timeout: 300
        inventory_hostname: "{{ target_hostname }}"

    - name: Display discovery completion
      ansible.builtin.debug:
        msg:
          - "=== Discovery Completed on Altra ==="
          - "Output directory: {{ discovery_output_dir }}"
          - "Machine type: {{ discovered_machine.type | default('unknown') }}"
          - "OS: {{ discovered_system.os.distribution | default('unknown') }} {{ discovered_system.os.version | default('') }}"
          - "Total packages: {{ discovered_packages.total | default(0) }}"
          - "Services: {{ discovered_services.running | default([]) | length }}"
          - "Docker: {{ discovered_docker.installed | default(false) }}"
          - "Desktop: {{ discovered_desktop.has_gui | default(false) }}"