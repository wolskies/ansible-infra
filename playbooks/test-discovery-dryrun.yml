---
# Dry-run test for discovery and basic_setup role integration
# This playbook tests the discovery -> basic_setup workflow safely
- name: Test Discovery and Basic Setup Integration (DRY RUN)
  hosts: localhost
  gather_facts: true
  connection: local
  collections:
    - wolskinet.infrastructure

  vars:
    # Discovery configuration
    discovery_output_dir: "./test-discovery-output"
    target_hostname: "test-machine"
    
    # Safety defaults for testing - all destructive operations disabled
    process_discovered_packages: false          # Don't install packages
    process_discovered_repositories: false      # Don't add repositories
    process_discovered_services: false          # Don't configure services
    configure_firewall: false                   # Don't modify firewall
    enable_maintenances: false                # Don't run system updates
    install_system_packages: false              # Don't install any packages
    install_development_packages: false         # Don't install dev packages
    install_desktop_packages: false             # Don't install desktop packages
    install_media_packages: false               # Don't install media packages

  tasks:
    - name: Clean up any previous test output
      ansible.builtin.file:
        path: "{{ discovery_output_dir }}"
        state: absent
      tags: cleanup

    - name: Run infrastructure discovery (safe)
      ansible.builtin.include_role:
        name: discovery
      vars:
        discovery:
          output_dir: "{{ discovery_output_dir }}"
          generate_configs: true
          include_sensitive: false
          timeout: 300
        inventory_hostname: "{{ target_hostname }}"
      tags: discovery

    - name: Test basic_setup role with discovered data (DRY RUN)
      ansible.builtin.include_role:
        name: basic_setup
      vars:
        # Pass discovered data to basic_setup role
        discovered_packages: "{{ discovered_packages | default({}) }}"
        discovered_repositories: "{{ discovered_repositories | default({}) }}"
        discovered_services: "{{ discovered_services | default({}) }}"
        discovered_security: "{{ discovered_security | default({}) }}"
        discovered_desktop: "{{ discovered_desktop | default({}) }}"
        
        # Override all potentially destructive operations
        user_details: []  # Don't create users
      tags: basic-setup-test

    - name: Display test results
      ansible.builtin.debug:
        msg:
          - "=== DRY RUN TEST COMPLETED ==="
          - "Discovery output: {{ discovery_output_dir }}"
          - ""
          - "Discovered data summary:"
          - "- Machine type: {{ discovered_machine.type | default('unknown') }}"
          - "- OS: {{ discovered_system.os.distribution | default('unknown') }}"
          - "- Total packages: {{ discovered_packages.total | default(0) }}"
          - "- Services running: {{ discovered_services.running | default([]) | length }}"
          - "- Docker installed: {{ discovered_docker.installed | default(false) }}"
          - ""
          - "Basic setup role executed with all destructive operations disabled"
          - "Check logs above for any errors or warnings"
      tags: summary

    - name: List generated files
      ansible.builtin.find:
        paths: "{{ discovery_output_dir }}"
        recurse: yes
      register: generated_files
      tags: file-list

    - name: Show generated configuration files
      ansible.builtin.debug:
        msg:
          - "Generated configuration files:"
          - "{{ generated_files.files | map(attribute='path') | list }}"
      when: generated_files.files | length > 0
      tags: file-list